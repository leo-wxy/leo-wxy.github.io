

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#9b868d">
  <meta name="description" content="如果我没有见过光明，那我本可以忍受黑暗">
  <meta name="author" content="Leo-Wxy">
  <meta name="keywords" content>
  <title>Hprof文件解析 - Wxy的个人博客</title>

  <link rel="stylesheet" href="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/css/bootstrap.min.css">


  <link rel="stylesheet" href="https://cdn.staticfile.org/github-markdown-css/4.0.0/github-markdown.min.css">
  <link rel="stylesheet" href="/lib/hint/hint.min.css">

  
    
    
      
      <link rel="stylesheet" href="https://cdn.staticfile.org/highlight.js/10.1.2/styles/dracula.min.css">
    
  

  
    <link rel="stylesheet" href="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.css">
  



<!-- 主题依赖的图标库，不要自行修改 -->
<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">

<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">

<link rel="stylesheet" href="/css/main.css">

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"leo-wxy.github.io","root":"/","version":"1.8.5","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"right","visible":"hover","icon":""},"copy_btn":true,"image_zoom":{"enable":true},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null},"tajs":null}};
  </script>
  <script src="/js/utils.js"></script>
  <script src="/js/color-schema.js"></script>
</head>


<body>
  <header style="height: 40vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Wxy's Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner intro-2" id="background" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Hprof文件解析">
              
                Hprof文件解析
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2020-12-14 14:45" pubdate>
        2020年12月14日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      2.6k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      38
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid">
  <div class="row">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-md">
      <div class="container nopadding-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Hprof文件解析</h1>
            
            <div class="markdown-body">
              <blockquote>
<p>Hprof对应的就是<strong>内存快照</strong>。可以方便的凭借<code>Hprof</code>进行<code>OOM分析</code>以及<code>异常治理</code>。</p>
</blockquote>
<ul>
<li><p><code>OOM治理</code></p>
<p><code>内存快照</code>保存的<code>对象信息</code>和<code>依赖关系</code>也是静态分析内存泄漏的关键。</p>
</li>
<li><p><code>Crash治理</code></p>
<p>保存的数据，也可用于分析异常问题。</p>
</li>
</ul>
<p><img src="/images/Hprof文件解析.png" srcset="/img/loading.gif" alt="Hprof文件解析"></p>
<h2 id="Hprof文件格式"><a href="#Hprof文件格式" class="headerlink" title="Hprof文件格式"></a>Hprof文件格式</h2><p>Hprof文件格式有明确组织方式，Android在Java的基础上新增了部分Tag。</p>
<h3 id="Java-Hprof格式"><a href="#Java-Hprof格式" class="headerlink" title="Java Hprof格式"></a>Java Hprof格式</h3><p><img src="/images/Java Hprof格式.png" srcset="/img/loading.gif" alt="Java Hprof格式"></p>
<p>整体分为<code>Header</code>和<code>Record数组</code>两部分。</p>
<h4 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h4><blockquote>
<p>记录hprof的元信息</p>
</blockquote>
<p><img src="/images/Hprof-Header" srcset="/img/loading.gif" alt="Hprof-Header"></p>
<ul>
<li>格式名和版本号：JAVA PROFILE 1.0.2 (<code>18byte</code>)</li>
<li>标识符大小：<code>4byte</code></li>
<li>高位时间戳：<code>4byte</code></li>
<li>地位时间戳：<code>4byte</code></li>
</ul>
<p><code>Header</code>总共占了<code>18 + 4 + 4 + 4 = 32byte</code></p>
<h4 id="Record数组"><a href="#Record数组" class="headerlink" title="Record数组"></a>Record数组</h4><blockquote>
<p>记录各个类型对应的数据</p>
</blockquote>
<p><img src="/images/Hprof-Record" srcset="/img/loading.gif" alt="Hprof-Record"></p>
<ul>
<li><strong>类型(<code>TAG</code>)</strong>：表示Record对应的类型(<code>1Byte</code>)</li>
<li>时间戳(<code>TIME</code>)：发生时间(<code>4byte</code>)</li>
<li>长度(<code>LENGTH</code>)：记录数据的长度(<code>4byte</code>)</li>
<li>记录数据(<code>BODY</code>)：记录的数据(<code>${LENGTH}Byte</code>)</li>
</ul>
<p>单条<code>Record</code>总共占了<code>1 + 4 + 4 + LENGTH byte</code></p>
<h4 id="支持的TAG类型"><a href="#支持的TAG类型" class="headerlink" title="支持的TAG类型"></a>支持的TAG类型</h4><h5 id="一级Tag"><a href="#一级Tag" class="headerlink" title="一级Tag"></a>一级Tag</h5><ul>
<li>STRING_IN_UTF8 = 0x01</li>
<li>LOAD_CLASS = 0x02</li>
<li>UNLOAD_CLASS = 0x03</li>
<li>STACK_FRAME = 0x04</li>
<li>STACK_TRACE = 0x05</li>
<li>ALLOC_SITES = 0x06</li>
<li>HEAP_SUMMARY = 0x07</li>
<li>START_THREAD = 0x0a</li>
<li>END_THREAD = 0x0b</li>
<li><strong>HEAP_DUMP = 0x0c</strong></li>
<li>CPU_SAMPLES = 0x0d</li>
<li>CONTROL_SETTINGS = 0x0e</li>
<li><strong>HEAP_DUMP_SEGMENT = 0x1c</strong></li>
<li>HEAP_DUMP_END = 0x2c</li>
</ul>
<h5 id="二级Tag"><a href="#二级Tag" class="headerlink" title="二级Tag"></a>二级Tag</h5><p>主要位于<code>HEAP_DUMP</code>或<code>HEAP_DUMP_SEGMENT</code>中</p>
<ul>
<li>ROOT_UNKNOWN = 0xff</li>
<li>ROOT_JNI_GLOBAL = 0x01</li>
<li>ROOT_JNI_LOCAL = 0x02</li>
<li>ROOT_JAVA_FRAME = 0x03</li>
<li>ROOT_NATIVE_STACK = 0x04</li>
<li>ROOT_STICKY_CLASS = 0x05</li>
<li>ROOT_THREAD_BLOCK = 0x06</li>
<li>ROOT_MONITOR_USED = 0x07</li>
<li>ROOT_THREAD_OBJECT = 0x08</li>
<li><strong>CLASS_DUMP = 0x20</strong></li>
<li><strong>INSTANCE_DUMP = 0x21</strong></li>
<li><strong>OBJECT_ARRAY_DUMP = 0x22</strong></li>
<li><strong>PRIMITIVE_ARRAY_DUMP = 0x23</strong>：占据到80%以上</li>
</ul>
<h3 id="Android-Hprof格式"><a href="#Android-Hprof格式" class="headerlink" title="Android Hprof格式"></a>Android Hprof格式</h3><p><img src="/images/Android Hprof格式.png" srcset="/img/loading.gif" alt="Android Hprof格式"></p>
<h4 id="Header-1"><a href="#Header-1" class="headerlink" title="Header"></a>Header</h4><p>格式与Java的Header一致</p>
<h4 id="Record数组-1"><a href="#Record数组-1" class="headerlink" title="Record数组"></a>Record数组</h4><p>格式与Java的Record一致</p>
<h4 id="支持的TAG类型-1"><a href="#支持的TAG类型-1" class="headerlink" title="支持的TAG类型"></a>支持的TAG类型</h4><h5 id="一级Tag-1"><a href="#一级Tag-1" class="headerlink" title="一级Tag"></a>一级Tag</h5><ul>
<li>STRING_IN_UTF8 = 0x01</li>
<li>LOAD_CLASS = 0x02</li>
<li>STACK_FRAME = 0x04</li>
<li>STACK_TRACE = 0x05</li>
<li>HEAP_DUMP_SEGMENT = 0x1c</li>
<li>HEAP_DUMP_END = 0x2c</li>
</ul>
<h5 id="二级Tag-1"><a href="#二级Tag-1" class="headerlink" title="二级Tag"></a>二级Tag</h5><p>主要位于<code>HEAP_DUMP_SEGMENT</code>中</p>
<ul>
<li>Java所有的二级Tag</li>
<li>HEAP_DUMP_INFO = 0xfe：存储的是<code>堆空间的类型</code>，主要有以下三种<ul>
<li>HEAP_ZYGOTE = 0x5A <code>Z</code> 系统堆空间</li>
<li><strong>HEAP_APP</strong> = 0x41 <code>A</code> 应用堆空间</li>
<li>HEAP_IMAGE = 0x49 <code>I</code> 图片堆空间</li>
</ul>
</li>
<li>ROOT_INTERNED_STRING = 0x89</li>
<li>ROOT_FINALIZING = 0x8a</li>
<li>ROOT_DEBUGGER = 0x8b</li>
<li>ROOT_REFERENCE_CLEANUP = 0x8c</li>
<li>ROOT_VM_INTERNAL = 0x8d</li>
<li>ROOT_JNI_MONITOR = 0x8e</li>
<li>ROOT_UNREACHABLE = 0x90</li>
<li>PRIMITIVE_ARRAY_NODATA = 0xc3</li>
</ul>
<h2 id="Hprof文件生成原理"><a href="#Hprof文件生成原理" class="headerlink" title="Hprof文件生成原理"></a>Hprof文件生成原理</h2><p><img src="/images/Hprof文件生成原理.png" srcset="/img/loading.gif" alt="Hprof文件生成原理"></p>
<h3 id="Debug-dumpHprofData"><a href="#Debug-dumpHprofData" class="headerlink" title="Debug.dumpHprofData()"></a>Debug.dumpHprofData()</h3><p>通过调用<code>Debug.dumpHprofData()</code>去生成Hprof文件</p>
<div class="hljs"><pre><code class="hljs java"><span class="hljs-comment">//frameworks/base/core/java/android/os/Debug.java</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">dumpHprofData</span><span class="hljs-params">(String fileName)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
        VMDebug.dumpHprofData(fileName);
    &#125;

<span class="hljs-comment">//libcore/dalvik/src/main/java/dalvik/system/VMDebug.java</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">dumpHprofData</span><span class="hljs-params">(String filename)</span> <span class="hljs-keyword">throws</span> IOException </span>&#123;
        <span class="hljs-keyword">if</span> (filename == <span class="hljs-keyword">null</span>) &#123;
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> NullPointerException(<span class="hljs-string">"filename == null"</span>);
        &#125;
        dumpHprofData(filename, <span class="hljs-keyword">null</span>);
    &#125;

    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">native</span> <span class="hljs-keyword">void</span> <span class="hljs-title">dumpHprofData</span><span class="hljs-params">(String fileName, <span class="hljs-keyword">int</span> fd)</span>
            <span class="hljs-keyword">throws</span> IOException</span>;</code></pre></div>
<p>执行到Native层的<code>vmDebug</code>中</p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">//art/runtime/native/dalvik_system_VMDebug.cc</span>
<span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">VMDebug_dumpHprofData</span><span class="hljs-params">(JNIEnv* env, jclass, jstring javaFilename, jint javaFd)</span> </span>&#123;
  <span class="hljs-comment">// Only one of these may be null.</span>
  <span class="hljs-keyword">if</span> (javaFilename == <span class="hljs-literal">nullptr</span> &amp;&amp; javaFd &lt; <span class="hljs-number">0</span>) &#123;
    <span class="hljs-function">ScopedObjectAccess <span class="hljs-title">soa</span><span class="hljs-params">(env)</span></span>;
    ThrowNullPointerException(<span class="hljs-string">"fileName == null &amp;&amp; fd == null"</span>);
    <span class="hljs-keyword">return</span>;
  &#125;

  <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> filename;
  <span class="hljs-keyword">if</span> (javaFilename != <span class="hljs-literal">nullptr</span>) &#123;
    <span class="hljs-function">ScopedUtfChars <span class="hljs-title">chars</span><span class="hljs-params">(env, javaFilename)</span></span>;
    <span class="hljs-keyword">if</span> (env-&gt;ExceptionCheck()) &#123;
      <span class="hljs-keyword">return</span>;
    &#125;
    filename = chars.c_str();
  &#125; <span class="hljs-keyword">else</span> &#123;
    filename = <span class="hljs-string">"[fd]"</span>;
  &#125;

  <span class="hljs-keyword">int</span> fd = javaFd;

  hprof::DumpHeap(filename.c_str(), fd, <span class="hljs-literal">false</span>);
&#125;</code></pre></div>
<p><code>hprof</code>指的就是<code>hprof.cc</code></p>
<h3 id="Hprof-DumpHeap"><a href="#Hprof-DumpHeap" class="headerlink" title="Hprof::DumpHeap()"></a>Hprof::DumpHeap()</h3><div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">//art/runtime/hprof/hprof.cc</span>
<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">DumpHeap</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* filename, <span class="hljs-keyword">int</span> fd, <span class="hljs-keyword">bool</span> direct_to_ddms)</span> </span>&#123;
  CHECK(filename != <span class="hljs-literal">nullptr</span>);
  Thread* self = Thread::Current();
  <span class="hljs-comment">// Need to take a heap dump while GC isn't running. See the comment in Heap::VisitObjects().</span>
  <span class="hljs-comment">// Also we need the critical section to avoid visiting the same object twice. See b/34967844</span>
  <span class="hljs-comment">// 此时需要停止所有进程等待dump文件完成</span>
  <span class="hljs-function">gc::ScopedGCCriticalSection <span class="hljs-title">gcs</span><span class="hljs-params">(self,
                                  gc::kGcCauseHprof,
                                  gc::kCollectorTypeHprof)</span></span>;
  <span class="hljs-function">ScopedSuspendAll <span class="hljs-title">ssa</span><span class="hljs-params">(__FUNCTION__, <span class="hljs-literal">true</span> <span class="hljs-comment">/* long suspend */</span>)</span></span>;
  <span class="hljs-function">Hprof <span class="hljs-title">hprof</span><span class="hljs-params">(filename, fd, direct_to_ddms)</span></span>;
  hprof.Dump();
&#125;

  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Dump</span><span class="hljs-params">()</span>
    <span class="hljs-title">REQUIRES</span><span class="hljs-params">(Locks::mutator_lock_)</span>
    <span class="hljs-title">REQUIRES</span><span class="hljs-params">(!Locks::heap_bitmap_lock_, !Locks::alloc_tracker_lock_)</span> </span>&#123;
    ...
    <span class="hljs-comment">// First pass to measure the size of the dump.</span>
    <span class="hljs-keyword">size_t</span> overall_size;
    <span class="hljs-keyword">size_t</span> max_length;
    &#123;
      EndianOutput count_output;
      output_ = &amp;count_output;
      ProcessHeap(<span class="hljs-literal">false</span>);<span class="hljs-comment">//执行heap读取</span>
      overall_size = count_output.SumLength();
      max_length = count_output.MaxLength();
      output_ = <span class="hljs-literal">nullptr</span>;
    &#125;

    <span class="hljs-keyword">bool</span> okay;
    visited_objects_.<span class="hljs-built_in">clear</span>();
    ...
      <span class="hljs-comment">//写入文件</span>
      okay = DumpToFile(overall_size, max_length);
    
    ...
  &#125;</code></pre></div>
<h4 id="ScopedSuspendAll"><a href="#ScopedSuspendAll" class="headerlink" title="ScopedSuspendAll"></a>ScopedSuspendAll</h4><p><img src="/images/Hprof-ScopedSuspendAll.png" srcset="/img/loading.gif" alt="Hprof-ScopedSuspendAll"></p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">//art/runtime/thread_list.cc</span>
ScopedSuspendAll::ScopedSuspendAll(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* cause, <span class="hljs-keyword">bool</span> long_suspend) &#123;
  Runtime::Current()-&gt;GetThreadList()-&gt;SuspendAll(cause, long_suspend);
&#125;

ScopedSuspendAll::~ScopedSuspendAll() &#123;
  Runtime::Current()-&gt;GetThreadList()-&gt;ResumeAll();
&#125;</code></pre></div>
<h5 id="SuspendAll"><a href="#SuspendAll" class="headerlink" title="SuspendAll"></a>SuspendAll</h5><blockquote>
<p><strong>主要负责暂停所有Java线程的操作</strong></p>
</blockquote>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ThreadList::SuspendAll</span><span class="hljs-params">(<span class="hljs-keyword">const</span> <span class="hljs-keyword">char</span>* cause, <span class="hljs-keyword">bool</span> long_suspend)</span> </span>&#123;
  Thread* self = Thread::Current();

  &#123;
    <span class="hljs-function">ScopedTrace <span class="hljs-title">trace</span><span class="hljs-params">(<span class="hljs-string">"Suspending mutator threads"</span>)</span></span>;
    <span class="hljs-keyword">const</span> <span class="hljs-keyword">uint64_t</span> start_time = NanoTime();

    SuspendAllInternal(self, self);
    <span class="hljs-comment">// All threads are known to have suspended (but a thread may still own the mutator lock)</span>
    <span class="hljs-comment">// Make sure this thread grabs exclusive access to the mutator lock and its protected data.</span>
&#125;

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ThreadList::SuspendAllInternal</span><span class="hljs-params">(Thread* self,
                                    Thread* ignore1,
                                    Thread* ignore2,
                                    SuspendReason reason)</span> </span>&#123;
  ...
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span>&amp; thread : list_) &#123;
      <span class="hljs-keyword">if</span> (thread == ignore1 || thread == ignore2) &#123;
        <span class="hljs-keyword">continue</span>;
      &#125;
      VLOG(threads) &lt;&lt; <span class="hljs-string">"requesting thread suspend: "</span> &lt;&lt; *thread;
      <span class="hljs-comment">//使thread进入 suspend状态</span>
      <span class="hljs-keyword">bool</span> updated = thread-&gt;ModifySuspendCount(self, +<span class="hljs-number">1</span>, &amp;pending_threads, reason);
      DCHECK(updated);

      <span class="hljs-comment">// Must install the pending_threads counter first, then check thread-&gt;IsSuspend() and clear</span>
      <span class="hljs-comment">// the counter. Otherwise there's a race with Thread::TransitionFromRunnableToSuspended()</span>
      <span class="hljs-comment">// that can lead a thread to miss a call to PassActiveSuspendBarriers().</span>
      <span class="hljs-keyword">if</span> (thread-&gt;IsSuspended()) &#123;
        <span class="hljs-comment">// Only clear the counter for the current thread.</span>
        thread-&gt;ClearSuspendBarrier(&amp;pending_threads);
        pending_threads.FetchAndSubSequentiallyConsistent(<span class="hljs-number">1</span>);
      &#125;
    &#125;
  
&#125;</code></pre></div>
<h5 id="ResumeAll"><a href="#ResumeAll" class="headerlink" title="ResumeAll"></a>ResumeAll</h5><blockquote>
<p><strong>主要负责唤醒暂停的Java线程</strong></p>
</blockquote>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ThreadList::ResumeAll</span><span class="hljs-params">()</span> </span>&#123;
  Thread* self = Thread::Current();
  ...

  Locks::mutator_lock_-&gt;ExclusiveUnlock(self);
  &#123;
    <span class="hljs-function">MutexLock <span class="hljs-title">mu</span><span class="hljs-params">(self, *Locks::thread_list_lock_)</span></span>;
    <span class="hljs-function">MutexLock <span class="hljs-title">mu2</span><span class="hljs-params">(self, *Locks::thread_suspend_count_lock_)</span></span>;
    <span class="hljs-comment">// Update global suspend all state for attaching threads.</span>
    --suspend_all_count_;
    <span class="hljs-comment">// Decrement the suspend counts for all threads.</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> <span class="hljs-keyword">auto</span>&amp; thread : list_) &#123;
      <span class="hljs-keyword">if</span> (thread == self) &#123;
        <span class="hljs-keyword">continue</span>;
      &#125;
      <span class="hljs-comment">//解除suspend状态</span>
      <span class="hljs-keyword">bool</span> updated = thread-&gt;ModifySuspendCount(self, <span class="hljs-number">-1</span>, <span class="hljs-literal">nullptr</span>, SuspendReason::kInternal);
      DCHECK(updated);
    &#125;

    <span class="hljs-comment">// Broadcast a notification to all suspended threads, some or all of</span>
    <span class="hljs-comment">// which may choose to wake up.  No need to wait for them.</span>
    <span class="hljs-keyword">if</span> (self != <span class="hljs-literal">nullptr</span>) &#123;
      VLOG(threads) &lt;&lt; *self &lt;&lt; <span class="hljs-string">" ResumeAll waking others"</span>;
    &#125; <span class="hljs-keyword">else</span> &#123;
      VLOG(threads) &lt;&lt; <span class="hljs-string">"Thread[null] ResumeAll waking others"</span>;
    &#125;
    Thread::resume_cond_-&gt;Broadcast(self);
  &#125;

&#125;</code></pre></div>
<h3 id="Hprof-ProcessHeap"><a href="#Hprof-ProcessHeap" class="headerlink" title="Hprof::ProcessHeap()"></a>Hprof::ProcessHeap()</h3><p><img src="/images/Hprof-ProcessHeap.png" srcset="/img/loading.gif" alt="Hprof-ProcessHeap"></p>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-comment">//art/runtime/hprof/hprof.cc</span>
  <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ProcessHeap</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> header_first)</span>
      <span class="hljs-title">REQUIRES</span><span class="hljs-params">(Locks::mutator_lock_)</span> </span>&#123;
    current_heap_ = HPROF_HEAP_DEFAULT;
    objects_in_segment_ = <span class="hljs-number">0</span>;

    <span class="hljs-keyword">if</span> (header_first) &#123;
      ProcessHeader(<span class="hljs-literal">true</span>);
      ProcessBody();
    &#125; <span class="hljs-keyword">else</span> &#123;
      ProcessBody();
      ProcessHeader(<span class="hljs-literal">false</span>);
    &#125;
  &#125;</code></pre></div>
<h4 id="ProcessHeader"><a href="#ProcessHeader" class="headerlink" title="ProcessHeader()"></a>ProcessHeader()</h4><blockquote>
<p>主要就是生成了Hprof对应的几个Tag的<code>Record</code>以及<code>Hprof Header</code></p>
</blockquote>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ProcessHeader</span><span class="hljs-params">(<span class="hljs-keyword">bool</span> string_first)</span> <span class="hljs-title">REQUIRES</span><span class="hljs-params">(Locks::mutator_lock_)</span> </span>&#123;
  <span class="hljs-comment">// Write the header.</span>
  WriteFixedHeader();
  <span class="hljs-comment">// Write the string and class tables, and any stack traces, to the header.</span>
  <span class="hljs-comment">// (jhat requires that these appear before any of the data in the body that refers to them.)</span>
  <span class="hljs-comment">// jhat also requires the string table appear before class table and stack traces.</span>
  <span class="hljs-comment">// However, WriteStackTraces() can modify the string table, so it's necessary to call</span>
  <span class="hljs-comment">// WriteStringTable() last in the first pass, to compute the correct length of the output.</span>
  <span class="hljs-keyword">if</span> (string_first) &#123;
    WriteStringTable();
  &#125;
  WriteClassTable();
  WriteStackTraces();
  <span class="hljs-keyword">if</span> (!string_first) &#123;
    WriteStringTable();
  &#125;
  output_-&gt;EndRecord();
&#125;</code></pre></div>
<h5 id="WriteFixedHeader"><a href="#WriteFixedHeader" class="headerlink" title="WriteFixedHeader"></a>WriteFixedHeader</h5><blockquote>
<p>生成<code>Hprof Header</code></p>
</blockquote>
<h5 id="WriteClassTable"><a href="#WriteClassTable" class="headerlink" title="WriteClassTable"></a>WriteClassTable</h5><blockquote>
<p>生成Tag为<code>LOAD_CLASS</code>的<code>Record</code></p>
</blockquote>
<h5 id="WriteStackTraces"><a href="#WriteStackTraces" class="headerlink" title="WriteStackTraces"></a>WriteStackTraces</h5><blockquote>
<p>生成Tag为<code>STACK_FRAME</code>和<code>STACK_TRACE</code>的<code>Record</code></p>
</blockquote>
<h5 id="WriteStringTable"><a href="#WriteStringTable" class="headerlink" title="WriteStringTable"></a>WriteStringTable</h5><blockquote>
<p>生成Tag为<code>String</code>的<code>Record</code></p>
</blockquote>
<h4 id="ProcessBody"><a href="#ProcessBody" class="headerlink" title="ProcessBody()"></a>ProcessBody()</h4><blockquote>
<p>主要为了生成Tag为<code>HEAP_DUMP_SEGMENT</code>和<code>HEAP_DUMP_END</code>的Record。</p>
<p>还有生成<code>HEAP_DUMP_SEGMENT</code>下的<code>子Record</code>。</p>
</blockquote>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">ProcessBody</span><span class="hljs-params">()</span> <span class="hljs-title">REQUIRES</span><span class="hljs-params">(Locks::mutator_lock_)</span> </span>&#123;
  Runtime* <span class="hljs-keyword">const</span> runtime = Runtime::Current();
  <span class="hljs-comment">// Walk the roots and the heap.</span>
  output_-&gt;StartNewRecord(HPROF_TAG_HEAP_DUMP_SEGMENT, kHprofTime);

  simple_roots_.<span class="hljs-built_in">clear</span>();
  runtime-&gt;VisitRoots(<span class="hljs-keyword">this</span>);
  runtime-&gt;VisitImageRoots(<span class="hljs-keyword">this</span>);
  <span class="hljs-keyword">auto</span> dump_object = [<span class="hljs-keyword">this</span>](mirror::Object* obj) REQUIRES_SHARED(Locks::mutator_lock_) &#123;
    DCHECK(obj != <span class="hljs-literal">nullptr</span>);
    <span class="hljs-comment">//Dump内存对象</span>
    DumpHeapObject(obj);
  &#125;;
  runtime-&gt;GetHeap()-&gt;VisitObjectsPaused(dump_object);
  output_-&gt;StartNewRecord(HPROF_TAG_HEAP_DUMP_END, kHprofTime);
  output_-&gt;EndRecord();
&#125;</code></pre></div>
<h5 id="DumpHeapObject"><a href="#DumpHeapObject" class="headerlink" title="DumpHeapObject"></a>DumpHeapObject</h5><p>主要采用了<code>访问者模式</code>进行内存对象的转储</p>
<blockquote>
<p>访问者模式：封装一些用于某种数据结构中的各元素的操作，可以在不改变这个数据结构的前提下定义作用于这些元素的新的操作。</p>
<p>适用于复杂的集合对象、XML文档解析等不易变的结构上。</p>
</blockquote>
<div class="hljs"><pre><code class="hljs c"><span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Hprof::DumpHeapObject</span><span class="hljs-params">(mirror::Object* obj)</span> </span>&#123;
  ...
    <span class="hljs-comment">//记录堆空间位置</span>
  <span class="hljs-keyword">if</span> (heap_type != current_heap_) &#123;
    HprofStringId nameId;

    <span class="hljs-comment">// This object is in a different heap than the current one.</span>
    <span class="hljs-comment">// Emit a HEAP_DUMP_INFO tag to change heaps.</span>
    <span class="hljs-function">__ <span class="hljs-title">AddU1</span><span class="hljs-params">(HPROF_HEAP_DUMP_INFO)</span></span>;
    <span class="hljs-function">__ <span class="hljs-title">AddU4</span><span class="hljs-params">(<span class="hljs-keyword">static_cast</span>&lt;<span class="hljs-keyword">uint32_t</span>&gt;(heap_type))</span></span>;   <span class="hljs-comment">// uint32_t: heap type</span>
    <span class="hljs-keyword">switch</span> (heap_type) &#123;
    <span class="hljs-keyword">case</span> HPROF_HEAP_APP:
      nameId = LookupStringId(<span class="hljs-string">"app"</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> HPROF_HEAP_ZYGOTE:
      nameId = LookupStringId(<span class="hljs-string">"zygote"</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">case</span> HPROF_HEAP_IMAGE:
      nameId = LookupStringId(<span class="hljs-string">"image"</span>);
      <span class="hljs-keyword">break</span>;
    <span class="hljs-keyword">default</span>:
      <span class="hljs-comment">// Internal error</span>
      LOG(ERROR) &lt;&lt; <span class="hljs-string">"Unexpected desiredHeap"</span>;
      nameId = LookupStringId(<span class="hljs-string">"&lt;ILLEGAL&gt;"</span>);
      <span class="hljs-keyword">break</span>;
    &#125;
    <span class="hljs-function">__ <span class="hljs-title">AddStringId</span><span class="hljs-params">(nameId)</span></span>;
    current_heap_ = heap_type;
  &#125;

  mirror::Class* c = obj-&gt;GetClass();
  <span class="hljs-keyword">if</span> (c == <span class="hljs-literal">nullptr</span>) &#123;
    <span class="hljs-comment">// This object will bother HprofReader, because it has a null</span>
    <span class="hljs-comment">// class, so just don't dump it. It could be</span>
    <span class="hljs-comment">// gDvm.unlinkedJavaLangClass or it could be an object just</span>
    <span class="hljs-comment">// allocated which hasn't been initialized yet.</span>
  &#125; <span class="hljs-keyword">else</span> &#123;
    <span class="hljs-keyword">if</span> (obj-&gt;IsClass()) &#123;
      DumpHeapClass(obj-&gt;AsClass());
    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (c-&gt;IsArrayClass()) &#123;
      DumpHeapArray(obj-&gt;AsArray(), c);
    &#125; <span class="hljs-keyword">else</span> &#123;
      DumpHeapInstanceObject(obj, c, visitor.GetRoots());
    &#125;
  &#125;    
  
&#125;

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Hprof::DumpHeapClass</span><span class="hljs-params">(mirror::Class* klass)</span> </span>&#123;
  ...
    AddU1(HPROF_PRIMITIVE_ARRAY_DUMP);
  ...
&#125;

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Hprof::DumpHeapArray</span><span class="hljs-params">(mirror::Array* obj, mirror::Class* klass)</span> </span>&#123;
  ...
    AddU1(HPROF_PRIMITIVE_ARRAY_DUMP);
  ...
&#125;

<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">Hprof::DumpHeapInstanceObject</span><span class="hljs-params">(mirror::Object* obj,
                                   mirror::Class* klass,
                                   <span class="hljs-keyword">const</span> <span class="hljs-built_in">std</span>::<span class="hljs-built_in">set</span>&lt;mirror::Object*&gt;&amp; fake_roots)</span> </span>&#123;
  ...
    AddU1(HPROF_PRIMITIVE_ARRAY_DUMP);
  ...
&#125;</code></pre></div>
<h6 id="DumpHeapClass"><a href="#DumpHeapClass" class="headerlink" title="DumpHeapClass"></a>DumpHeapClass</h6><blockquote>
<p>Dump内存的类信息</p>
<p>存放Tag为<code>CLASS_DUMP</code>的<code>Record</code>中</p>
</blockquote>
<h6 id="DumpHeapArray"><a href="#DumpHeapArray" class="headerlink" title="DumpHeapArray"></a>DumpHeapArray</h6><blockquote>
<p>Dump内存的数组信息</p>
<p>存放Tag为<code>OBJECT_ARRAY_DUMP</code>的<code>Record</code>中</p>
</blockquote>
<h6 id="DumpHeapInstanceObject"><a href="#DumpHeapInstanceObject" class="headerlink" title="DumpHeapInstanceObject"></a>DumpHeapInstanceObject</h6><blockquote>
<p>Dump内存的实例信息</p>
<p>存放Tag为<code>INSTANCE_DUMP</code>的<code>Record</code>中。<em>需要分析内存泄漏时一般都是分析其引用关系即实例间的联系。</em></p>
<p><strong>基本只要保留INSTANCE_DUMP这个Tag的Record信息，足以分析内存泄漏。</strong></p>
</blockquote>
<h6 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h6><blockquote>
<p>在Tag为<code>PRIMITIVE_ARRAY_DUMP</code>中基本存放的就是非·上述三种类型的数据.</p>
<p><em>所以这部分空间占用也是最大的！！！也是需要裁剪的</em></p>
</blockquote>
<h2 id="Hprof文件裁剪"><a href="#Hprof文件裁剪" class="headerlink" title="Hprof文件裁剪"></a>Hprof文件裁剪</h2><p><img src="/images/Hprof文件裁剪.png" srcset="/img/loading.gif" alt="Hprof文件裁剪"></p>
<h3 id="Why-裁剪？"><a href="#Why-裁剪？" class="headerlink" title="Why 裁剪？"></a>Why 裁剪？</h3><p>Hprof文件通常比较大，大文件在传输、解析、空间占用上都会产生很大的影响，因此需要进行裁剪。</p>
<ul>
<li><code>存储</code>：通常Hprof文件较大，会占用很大的应用空间，如果空间不足够，将会导致无法<code>dump</code>进行解析。</li>
<li><code>传输</code>：假如需要dump用户的Hprof文件，就需要传回到服务端，耗费的流量也会比较大。</li>
<li><code>隐私</code>：Hprof文件存的是完整的内存数据，可能就包含很多隐私信息，这些都需要进行裁剪隐藏。</li>
</ul>
<h3 id="How-裁剪？"><a href="#How-裁剪？" class="headerlink" title="How 裁剪？"></a>How 裁剪？</h3><p>主要有两套方案：</p>
<h4 id="先Dump后裁剪"><a href="#先Dump后裁剪" class="headerlink" title="先Dump后裁剪"></a>先Dump后裁剪</h4><p><img src="/images/Dump文件后裁剪.png" srcset="/img/loading.gif" alt="Dump文件后裁剪"></p>
<ol>
<li>通过<code>Debug.dumpHprofData()</code>得到一个完整的Hprof文件</li>
<li>再分析Hprof文件，进行裁剪，去掉一些无用的数据</li>
<li>裁剪完成后，得到一份精简的Hprof文件</li>
</ol>
<p>缺陷：</p>
<ul>
<li>直接dump出的Hprof文件过大，存储问题不好解决</li>
<li>裁剪过程涉及到文件IO和hprof文件解析，可能影响APP性能</li>
<li>裁剪过程不彻底，导致隐私数据的泄漏。</li>
</ul>
<h4 id="Dump过程实时裁剪-推荐"><a href="#Dump过程实时裁剪-推荐" class="headerlink" title="Dump过程实时裁剪(推荐)"></a>Dump过程实时裁剪(推荐)</h4><p><img src="/images/Dump实时裁剪.png" srcset="/img/loading.gif" alt="Dump实时裁剪"></p>
<p><img src="/images/Hprof实时裁剪流程.png" srcset="/img/loading.gif" alt="Hprof实时裁剪流程"></p>
<ol>
<li>通过<code>xHook</code>对<code>open()</code>进行hook处理，替换成自身实现</li>
<li>通过<code>xHook</code>对<code>write()</code>进行hook处理，替换成自身实现</li>
<li>调用<code>Debug.dumpHprofData()</code>时，优先执行自身实现的<code>open()</code>，为了过滤出写入目标文件的fd；再然后调用到自身实现的<code>write</code>，对向目标文件写入的数据进行裁剪压缩。</li>
<li>生成Hprof文件完毕后，清除之前的Hook内容。</li>
</ol>
<h4 id="需要裁剪的内容"><a href="#需要裁剪的内容" class="headerlink" title="需要裁剪的内容"></a>需要裁剪的内容</h4><p><img src="/images/Hprof-裁剪的内容.png" srcset="/img/loading.gif" alt="Hprof-裁剪的内容"></p>
<p>需要裁剪掉全部基本类型数组的值，例如<code>char[](字符串)、byte[](图片)</code>，在处理<code>内存泄漏</code>相关问题时，一般也只关心<code>对象间的引用以及对象大小</code>，裁剪掉一些消息不会影响分析。</p>
<p>保证基本Hprof文件功能：</p>
<ul>
<li><p>只对<code>HEAP_DUMP_SEGMENT</code>的<code>Record</code>下进行裁剪，其他保持不变。例如<code>STRING、LOAD_CLASS</code>等</p>
</li>
<li><p>在<code>HEAP_DUMP_SEGMENT</code>的<code>Record</code>下，主要删除<code>PRIMITIVE_ARRAY_DUMP</code>，这一块主要占用80%的内容</p>
</li>
<li><p>在裁剪<code>INSTANCE_DUMP(实例)</code>、<code>OBJECT_ARRAY_DUMP(对象数组)</code>，<code>CLASS_DUMP(类或接口)</code>和<code>HEAP_DUMP_INFO(记录当前堆位置)</code>时需要再去掉<code>Zygote Heap(系统堆)</code>和<code>Image Heap(图像堆)</code></p>
<p>主要通过判断<code>HEAP_DUMP_INFO</code>的<code>heapType</code>是否为<code>HEAP_ZYGOTE(Z)</code>和<code>HEAP_IMAGE(I)</code></p>
</li>
</ul>
<h2 id="拓展知识"><a href="#拓展知识" class="headerlink" title="拓展知识"></a>拓展知识</h2><h3 id="如何解决Dump-hprof时暂停所有线程问题？"><a href="#如何解决Dump-hprof时暂停所有线程问题？" class="headerlink" title="如何解决Dump hprof时暂停所有线程问题？"></a>如何解决Dump hprof时暂停所有线程问题？</h3><p>此时如果在主进程进行Dump操作，也就意味着<strong>主进程上所有线程都会停止，也就无法进行任何操作。</strong>此时就需要启动一个子进程，并且需要从主进程<code>fork</code>出一个子进程，需要遵循<code>COW机制(为了节省fork子进程的内存消耗和耗时，fork出的子进程并不会copy父进程的内存空间，而是共享。)</code>。</p>
<p>后续fork出的子进程在父进程修改时不受影响。</p>
<p><img src="/images/fork子进程" srcset="/img/loading.gif" alt="fork子进程"></p>
<p>头条解决方案</p>
<p><img src="/images/子进程Dump内存流程图" srcset="/img/loading.gif" alt="子进程Dump内存流程图"></p>
<h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="http://hg.openjdk.java.net/jdk6/jdk6/jdk/raw-file/tip/src/share/demo/jvmti/hprof/manual.html#mozTocId848088" target="_blank" rel="noopener">hprof文件格式</a></p>
<p><a href="https://android.googlesource.com/platform/tools/base/+/studio-master-dev/perflib/src/main/java/com/android/tools/perflib/heap/HprofParser.java" target="_blank" rel="noopener">AS中的hprof文件解析</a></p>
<p><a href="https://mp.weixin.qq.com/s?__biz=MzI1MzYzMjE0MQ==&amp;mid=2247487203&amp;idx=1&amp;sn=182584b69910c843ae95f60e74127249&amp;chksm=e9d0c501dea74c178e16f95a2ffc5007c5dbca89a02d56895ed9b05883cf0562da689ac6146b&amp;mpshare=1&amp;scene=23&amp;srcid=1214vdTTpPyczmY38wlcDo94&amp;sharer_sharetime=1607926324661&amp;sharer_shareid=65073698ab9ac2983b955fa53b4ff585%23rd" target="_blank" rel="noopener">Hprof裁剪</a></p>
<p><a href="https://tech.meituan.com/2019/11/14/crash-oom-probe-practice.html" target="_blank" rel="noopener">Android线上OOM问题定位组件</a></p>
<p><a href="https://github.com/KwaiAppTeam/KOOM/blob/master/java-oom/src/main/cpp/hprof_dump.cpp" target="_blank" rel="noopener">KOOM</a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Java/">Java</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://zh.wikipedia.org/wiki/Wikipedia:CC_BY-SA_3.0%E5%8D%8F%E8%AE%AE%E6%96%87%E6%9C%AC" rel="nofollow noopener">CC BY-SA 3.0协议</a> 。转载请注明出处！</p>
              
              
                <div class="post-prevnext row">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2020/12/14/Android性能优化-自动内存分析/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Android性能优化-自动内存分析</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2020/12/12/Android性能优化-布局优化/">
                        <span class="hidden-mobile">Android性能优化-布局优化</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.staticfile.org/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":200})
    NProgress.start()
    document.addEventListener('DOMContentLoaded', function() {
      window.NProgress && window.NProgress.inc();
    })
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.staticfile.org/jquery/3.5.1/jquery.min.js" ></script>
<script  src="https://cdn.staticfile.org/twitter-bootstrap/4.5.3/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.staticfile.org/tocbot/4.12.0/tocbot.min.js" ></script>



  <script  src="https://cdn.staticfile.org/fancybox/3.5.7/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.staticfile.org/anchor-js/4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.staticfile.org/clipboard.js/2.0.6/clipboard.min.js" ></script>







  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
