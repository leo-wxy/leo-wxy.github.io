

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#11527b">
  <meta name="author" content="Leo-Wxy">
  <meta name="keywords" content="">
  
    <meta property="og:type" content="article">
<meta property="og:title" content="View的工作原理">
<meta property="og:url" content="https://leo-wxy.github.io/2018/12/14/View%E7%9A%84%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86/index.html">
<meta property="og:site_name" content="Wxy的个人博客">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://leo-wxy.github.io/images/View%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86xmind.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/View%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-PhoneWindow.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/View%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-DecorView.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/setContentView%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/View%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-ViewRootImpl.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/%E4%B8%89%E8%80%85%E5%85%B3%E7%B3%BB.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/View%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-LayoutInflater-PhoneLayoutInflater.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/LayoutInflater-inflate.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/LayoutInflater-Factory2.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/LayoutInflater-%E9%BB%98%E8%AE%A4View%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/LayoutInflater%E8%BF%87%E7%A8%8B.jpg">
<meta property="og:image" content="https://leo-wxy.github.io/images/View%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/measure-MeasureSpec.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/MeasureSpec%E7%BB%93%E6%9E%84">
<meta property="og:image" content="https://leo-wxy.github.io/images/measure-View%E7%9A%84measure%E8%BF%87%E7%A8%8B.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/View-Measure.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/measure-ViewGroup%E7%9A%84measure%E8%BF%87%E7%A8%8B.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/ViewGroup-Measure.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/layout-View%E7%9A%84layout%E8%BF%87%E7%A8%8B.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/View-Layout.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/layout-ViewGroup%E7%9A%84layout%E8%BF%87%E7%A8%8B.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/ViewGroup-Layout.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/layout-getMeasureWidth(">
<meta property="og:image" content="https://leo-wxy.github.io/images/draw-View%E7%9A%84draw%E8%BF%87%E7%A8%8B.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/View-Draw.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/draw-ViewGroup%E7%9A%84draw%E8%BF%87%E7%A8%8B.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/ViewGroup-Draw.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/draw-ViewGroup%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%98%E5%88%B6%E9%A1%BA%E5%BA%8F.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/%E8%87%AA%E5%AE%9A%E4%B9%89View.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/%E8%87%AA%E5%AE%9A%E4%B9%89View-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/View%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-%E8%A7%A6%E5%8F%91View%E7%9A%84%E9%87%8D%E6%96%B0%E7%BB%98%E5%88%B6.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/View%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-requestLayout.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/View%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-Invalidate.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/View%E9%87%8D%E7%BB%98.png">
<meta property="og:image" content="https://leo-wxy.github.io/images/TextView.setText.png">
<meta property="article:published_time" content="2018-12-14T08:47:21.000Z">
<meta property="article:modified_time" content="2026-02-25T14:35:34.471Z">
<meta property="article:author" content="Leo-Wxy">
<meta property="article:tag" content="Android">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://leo-wxy.github.io/images/View%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86xmind.png">
  
  
  
  <title>View的工作原理 - Wxy的个人博客</title>

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="/lib/hint/hint.min.css" />

  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"leo-wxy.github.io","root":"/","version":"1.9.8","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"always","icon":"#"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"left","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":null,"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null},"gtag":null,"woyaola":null,"cnzz":null},"search_path":"/local-search.xml","include_content_in_search":false};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 8.1.1"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 60vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Wxy&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>友链</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle">View的工作原理</span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2018-12-14 16:47" pubdate>
          2018年12月14日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          <!-- compatible with older versions-->
          13k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          <!-- compatible with older versions-->
          42 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="padding-left: 2rem; margin-right: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">View的工作原理</h1>
            
            
              <div class="markdown-body">
                
                <!--MeasureSpec是什么？有什么作用？，自定义View/ViewGroup需要注意什么？invalidate()和postInvalidate()的区别？,invalidate和postInvalidate的区别及使用 Requestlayout，onlayout，onDraw，DrawChild区别与联系  View刷新机制  View绘制流程  计算一个view的嵌套层级（递归）  onMeasure的具体过程，先measure子view还是自己  onDraw的具体过程，先draw子view还是自己  实现一个自定义view，其中含有若干textview，textview文字可换行且自定义- - view的高度可自适应拓展 view的工作原理及measure、layout、draw流程。哪一个流程可以放在子线程中去执行？draw方法中需要注意的问题？Invalidate、postInvalidate、requestLayout应用场景 TextView.setText()调用什么方法去刷新 -->

<p><img src="/images/View%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86xmind.png" srcset="/img/loading.gif" lazyload alt="View工作原理"></p>
<span id="more"></span>



<h2 id="PhoneWindow"><a href="#PhoneWindow" class="headerlink" title="PhoneWindow"></a>PhoneWindow</h2><p><img src="/images/View%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-PhoneWindow.png" srcset="/img/loading.gif" lazyload alt="View工作原理-PhoneWindow"></p>
<p><code>Window</code>是一个抽象类，提供了各种窗口操作方法。每个Activity都会持有一个<code>Window</code>。</p>
<p><code>PhoneWindow</code>是<code>Window</code>唯一实现类，在Activity被创建时<code>Activity.attach()</code>进行初始化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ActivityThread.java</span><br><span class="hljs-comment">//Activity开始启动</span><br><span class="hljs-keyword">public</span> Activity <span class="hljs-title function_">handleLaunchActivity</span><span class="hljs-params">(ActivityClientRecord r,</span><br><span class="hljs-params">            PendingTransactionActions pendingActions, Intent customIntent)</span> &#123;<br> ... <br>   <span class="hljs-keyword">final</span> <span class="hljs-type">Activity</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> performLaunchActivity(r, customIntent);<br>&#125;<br><br>    <span class="hljs-keyword">private</span> Activity <span class="hljs-title function_">performLaunchActivity</span><span class="hljs-params">(ActivityClientRecord r, Intent customIntent)</span> &#123;<br>      <span class="hljs-comment">//创建Application对象</span><br>            <span class="hljs-type">Application</span> <span class="hljs-variable">app</span> <span class="hljs-operator">=</span> r.packageInfo.makeApplication(<span class="hljs-literal">false</span>, mInstrumentation);      <br>      <span class="hljs-comment">//Activity初始化</span><br>       activity.attach(appContext, <span class="hljs-built_in">this</span>, getInstrumentation(), r.token,<br>                        r.ident, app, r.intent, r.activityInfo, title, r.parent,<br>                        r.embeddedID, r.lastNonConfigurationInstances, config,<br>                        r.referrer, r.voiceInteractor, window, r.configCallback);<br>    &#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Activity.java</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">(Context context, ActivityThread aThread,</span><br><span class="hljs-params">            Instrumentation instr, IBinder token, <span class="hljs-type">int</span> ident,</span><br><span class="hljs-params">            Application application, Intent intent, ActivityInfo info,</span><br><span class="hljs-params">            CharSequence title, Activity parent, String id,</span><br><span class="hljs-params">            NonConfigurationInstances lastNonConfigurationInstances,</span><br><span class="hljs-params">            Configuration config, String referrer, IVoiceInteractor voiceInteractor,</span><br><span class="hljs-params">            Window window, ActivityConfigCallback activityConfigCallback)</span> &#123;<br>      ...<br>        <span class="hljs-comment">//初始化PhoneWindow对象</span><br>        mWindow = <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhoneWindow</span>(<span class="hljs-built_in">this</span>, window, activityConfigCallback);<br>        mWindow.setWindowControllerCallback(<span class="hljs-built_in">this</span>);<br>      <span class="hljs-comment">//绑定Window对象</span><br>        mWindow.setCallback(<span class="hljs-built_in">this</span>);<br>      <br>    &#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//PhoneWindow.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PhoneWindow</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Window</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">MenuBuilder</span>.Callback &#123;<br>    <span class="hljs-comment">// This is the top-level view of the window, containing the window decor.</span><br>    <span class="hljs-keyword">private</span> DecorView mDecor;<span class="hljs-comment">//对应DecorView  </span><br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="DecorView"><a href="#DecorView" class="headerlink" title="DecorView"></a>DecorView</h2><p><img src="/images/View%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-DecorView.png" srcset="/img/loading.gif" lazyload alt="View工作原理-DecorView"></p>
<p><strong>DecorView是整个Window界面的最顶层View。</strong> <em>可以使用Android Studio自带的Layout Inspector查看页面层级</em></p>
<h3 id="DecorView的布局结构"><a href="#DecorView的布局结构" class="headerlink" title="DecorView的布局结构"></a>DecorView的布局结构</h3><p>一般情况下<code>DecorView</code>会包含一个竖直方向的LinearLayout，该LinearLayout分为上下两个部分，上面是标题栏(<code>titlebar</code>)，下面是内容栏(<code>继承自FrameLayout 且id为content</code>)。因此我们设置Activity的布局方法叫做<code>setContentView()</code>，因为他们都被加进了<code>id为content的FrameLayout</code>中。</p>
<p>我们可以利用<code>ViewGroup content = findViewById(R.android.id.content)</code>获取content。使用<code>content.getChildAt(0)</code>获取设置的Activity布局。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ../android/app/Activity.java</span><br>    <span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">View</span>&gt; T <span class="hljs-title function_">findViewById</span><span class="hljs-params">(<span class="hljs-meta">@IdRes</span> <span class="hljs-type">int</span> id)</span> &#123;<br>        <span class="hljs-comment">//从Window中去获取View</span><br>        <span class="hljs-keyword">return</span> getWindow().findViewById(id);<br>    &#125;<br><br><span class="hljs-comment">// ../android/view/Window.java</span><br>    <span class="hljs-keyword">public</span> &lt;T <span class="hljs-keyword">extends</span> <span class="hljs-title class_">View</span>&gt; T <span class="hljs-title function_">findViewById</span><span class="hljs-params">(<span class="hljs-meta">@IdRes</span> <span class="hljs-type">int</span> id)</span> &#123;<br>        <span class="hljs-comment">//从DecorView获取View</span><br>        <span class="hljs-keyword">return</span> getDecorView().findViewById(id);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>所有的View都会从DecorView中开始检索，所以<strong>View层的事件都会先经过DecorView，再传递到我们定义的View上</strong>。</p>
<h3 id="setContentView-过程"><a href="#setContentView-过程" class="headerlink" title="setContentView()过程"></a>setContentView()过程</h3><blockquote>
<p>通过<code>setContentView()</code>将需要加载的布局放到<code>DecorView</code>中</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Activity.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContentView</span><span class="hljs-params">(<span class="hljs-meta">@LayoutRes</span> <span class="hljs-type">int</span> layoutResID)</span> &#123;<br>        getWindow().setContentView(layoutResID);<br>        initWindowDecorActionBar();<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><code>Activity.setContentView()</code>调用<code>PhoneWindow.setContentView()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setContentView</span><span class="hljs-params">(<span class="hljs-type">int</span> layoutResID)</span> &#123;<br>    <span class="hljs-comment">// Note: FEATURE_CONTENT_TRANSITIONS may be set in the process of installing the window</span><br>    <span class="hljs-comment">// decor, when theme attributes and the like are crystalized. Do not check the feature</span><br>    <span class="hljs-comment">// before this happens.</span><br>    <span class="hljs-keyword">if</span> (mContentParent == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-comment">//创建DecorView</span><br>        installDecor();<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;<br>        mContentParent.removeAllViews();<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (hasFeature(FEATURE_CONTENT_TRANSITIONS)) &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Scene</span> <span class="hljs-variable">newScene</span> <span class="hljs-operator">=</span> Scene.getSceneForLayout(mContentParent, layoutResID,<br>                getContext());<br>        transitionTo(newScene);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>      <span class="hljs-comment">//开始加载对应布局</span><br>        mLayoutInflater.inflate(layoutResID, mContentParent);<br>    &#125;<br>    mContentParent.requestApplyInsets();<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">Callback</span> <span class="hljs-variable">cb</span> <span class="hljs-operator">=</span> getCallback();<br>    <span class="hljs-keyword">if</span> (cb != <span class="hljs-literal">null</span> &amp;&amp; !isDestroyed()) &#123;<br>        cb.onContentChanged();<br>    &#125;<br>    mContentParentExplicitlySet = <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>setContentView()</code>主要执行以下两步：</p>
<h4 id="installDecor-——创建DecorView"><a href="#installDecor-——创建DecorView" class="headerlink" title="installDecor()——创建DecorView"></a><code>installDecor()</code>——创建DecorView</h4><blockquote>
<p>基础<code>DecorView</code>主要包含两部分，标题<code>title_bar</code>和内容<code>content</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//PhoneWindow.java</span><br> <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">installDecor</span><span class="hljs-params">()</span> &#123;<br>        mForceDecorInstall = <span class="hljs-literal">false</span>;<br>        <span class="hljs-keyword">if</span> (mDecor == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//生成DecorView</span><br>            mDecor = generateDecor(-<span class="hljs-number">1</span>);<br>            ...<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            mDecor.setWindow(<span class="hljs-built_in">this</span>);<br>        &#125;<br>        <span class="hljs-keyword">if</span> (mContentParent == <span class="hljs-literal">null</span>) &#123;<br>           <span class="hljs-comment">//根据DecorView生成子View</span><br>            mContentParent = generateLayout(mDecor);<br>          ...<br>        &#125;<br> &#125;<br><br>    <span class="hljs-keyword">protected</span> DecorView <span class="hljs-title function_">generateDecor</span><span class="hljs-params">(<span class="hljs-type">int</span> featureId)</span> &#123;<br>        Context context;<br>        <span class="hljs-keyword">if</span> (mUseDecorContext) &#123;<br>            <span class="hljs-type">Context</span> <span class="hljs-variable">applicationContext</span> <span class="hljs-operator">=</span> getContext().getApplicationContext();<br>            <span class="hljs-keyword">if</span> (applicationContext == <span class="hljs-literal">null</span>) &#123;<br>                context = getContext();<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                context = <span class="hljs-keyword">new</span> <span class="hljs-title class_">DecorContext</span>(applicationContext, getContext());<br>                <span class="hljs-keyword">if</span> (mTheme != -<span class="hljs-number">1</span>) &#123;<br>                    context.setTheme(mTheme);<br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            context = getContext();<br>        &#125;<br>      <span class="hljs-comment">// 生成DecorView对象</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DecorView</span>(context, featureId, <span class="hljs-built_in">this</span>, getAttributes());<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> ViewGroup <span class="hljs-title function_">generateLayout</span><span class="hljs-params">(DecorView decor)</span> &#123;<br>      ...<br>        <span class="hljs-type">int</span> layoutResource;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">features</span> <span class="hljs-operator">=</span> getLocalFeatures();<br>        <span class="hljs-keyword">if</span> ((features &amp; (<span class="hljs-number">1</span> &lt;&lt; FEATURE_SWIPE_TO_DISMISS)) != <span class="hljs-number">0</span>) &#123;<br>            layoutResource = R.layout.screen_swipe_dismiss;<br>            setCloseOnSwipeEnabled(<span class="hljs-literal">true</span>);     <br>        &#125;...<br>         <span class="hljs-keyword">else</span>&#123;<br>           layoutResource = R.layout.screen_simple; <span class="hljs-comment">//默认布局</span><br>         &#125;<br>         mDecor.startChanging();<br>         <span class="hljs-comment">//开始加载布局</span><br>         mDecor.onResourcesLoaded(mLayoutInflater, layoutResource);<br>         <span class="hljs-comment">//根据id找到 content</span><br>         <span class="hljs-type">ViewGroup</span> <span class="hljs-variable">contentParent</span> <span class="hljs-operator">=</span> (ViewGroup)findViewById(ID_ANDROID_CONTENT);<span class="hljs-comment">//com.android.internal.R.id.content</span><br>         ...<br>         <span class="hljs-keyword">return</span> contentParent;<br>    &#125;<br><br><span class="hljs-comment">//DecorView.java</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">onResourcesLoaded</span><span class="hljs-params">(LayoutInflater inflater, <span class="hljs-type">int</span> layoutResource)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">root</span> <span class="hljs-operator">=</span> inflater.inflate(layoutResource, <span class="hljs-literal">null</span>);<br>        <span class="hljs-keyword">if</span> (mDecorCaptionView != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (mDecorCaptionView.getParent() == <span class="hljs-literal">null</span>) &#123;<br>                addView(mDecorCaptionView,<br>                        <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewGroup</span>.LayoutParams(MATCH_PARENT, MATCH_PARENT));<br>            &#125;<br>            mDecorCaptionView.addView(root,<br>                    <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewGroup</span>.MarginLayoutParams(MATCH_PARENT, MATCH_PARENT));<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//解析得到的View放到DecorView中</span><br>            addView(root, <span class="hljs-number">0</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewGroup</span>.LayoutParams(MATCH_PARENT, MATCH_PARENT));<br>        &#125;<br>        mContentRoot = (ViewGroup) root;<br>    &#125;<br><br></code></pre></td></tr></table></figure>

<p><code>installDecor()</code>主要负责创建<code>DecorView</code>并执行<code>generateLayout()</code>生成<code>contentParent</code>将自定义的布局放入其中。</p>
<h4 id="inflate-layoutResID-mContentParent-——加载布局"><a href="#inflate-layoutResID-mContentParent-——加载布局" class="headerlink" title="inflate(layoutResID, mContentParent)——加载布局"></a>inflate(layoutResID, mContentParent)——加载布局</h4><p><code>inflate()</code>主要将<code>layoutResID</code>加载成具体的View，并加入到<code>mContentParent</code>中，进行显示。</p>
<p><img src="/images/setContentView%E6%B5%81%E7%A8%8B.png" srcset="/img/loading.gif" lazyload alt="执行流程"></p>
<h2 id="ViewRootImpl"><a href="#ViewRootImpl" class="headerlink" title="ViewRootImpl"></a>ViewRootImpl</h2><p><img src="/images/View%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-ViewRootImpl.png" srcset="/img/loading.gif" lazyload alt="View工作原理-ViewRootImpl"></p>
<blockquote>
<p><em>ViewRoot对应于ViewRootImpl类，是连接WindowManager和DecorView的纽带，View的三大流程均需通过ViewRoot完成。</em></p>
</blockquote>
<h3 id="ViewRootImpl创建时机"><a href="#ViewRootImpl创建时机" class="headerlink" title="ViewRootImpl创建时机"></a>ViewRootImpl创建时机</h3><p>当Activity创建时，最终是调用到<code>ActivityThread</code>的<code>handleLaunchActivity</code>来创建Activity。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ../android/app/ActivityThread.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleLaunchActivity</span><span class="hljs-params">(ActivityClientRecord r, Intent customIntent, String reason)</span> &#123;<br> ...<br>      <span class="hljs-comment">//创建一个Activity 会调用到onCreate()方法 从而完成DecorView的创建</span><br>      <span class="hljs-type">Activity</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> performLaunchActivity(r, customIntent);<br>        <span class="hljs-keyword">if</span> (a != <span class="hljs-literal">null</span>) &#123;<br>            r.createdConfig = <span class="hljs-keyword">new</span> <span class="hljs-title class_">Configuration</span>(mConfiguration);<br>            reportSizeConfigurations(r);<br>            <span class="hljs-type">Bundle</span> <span class="hljs-variable">oldState</span> <span class="hljs-operator">=</span> r.state;<br>            <br>            handleResumeActivity(r.token, <span class="hljs-literal">false</span>, r.isForward,<br>                    !r.activity.mFinished &amp;&amp; !r.startsNotResumed, r.lastProcessedSeq, reason);<br>            ...<br>        &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>上述方法后续调用到了<code>handleResumeActivity()</code>,在这个方法中调用到了<code>WindowManager.addView()</code>将View传递至WindowManager</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ../android/app/ActivityThread.java</span><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleResumeActivity</span><span class="hljs-params">(IBinder token,</span><br><span class="hljs-params">            <span class="hljs-type">boolean</span> clearHide, <span class="hljs-type">boolean</span> isForward, <span class="hljs-type">boolean</span> reallyResume, <span class="hljs-type">int</span> seq, String reason)</span> &#123;<br>         <span class="hljs-type">ActivityClientRecord</span> <span class="hljs-variable">r</span> <span class="hljs-operator">=</span> mActivities.get(token);<br>        <span class="hljs-keyword">if</span> (!checkAndUpdateLifecycleSeq(seq, r, <span class="hljs-string">&quot;resumeActivity&quot;</span>)) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        unscheduleGcIdler();<br>        mSomeActivitiesChanged = <span class="hljs-literal">true</span>;<br><br>        <span class="hljs-comment">// 在这里会调用到生命周期中的onResume方法</span><br>        r = performResumeActivity(token, clearHide, reason);<br>        ...<br>            <span class="hljs-keyword">if</span>(r!=<span class="hljs-literal">null</span>)&#123;<br>                ...<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">Activity</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> r.activity;<br>                ...<br>                <span class="hljs-comment">//获得当前Activty的Window对象</span><br>                r.window = r.activity.getWindow();<br>                <span class="hljs-comment">//获得当前Window的DecorView</span><br>                <span class="hljs-type">View</span> <span class="hljs-variable">decor</span> <span class="hljs-operator">=</span> r.window.getDecorView();<br>                decor.setVisibility(View.INVISIBLE);<br>                <span class="hljs-comment">//获得当前Activity的WindowManager对象</span><br>                <span class="hljs-type">ViewManager</span> <span class="hljs-variable">wm</span> <span class="hljs-operator">=</span> a.getWindowManager();<br>                WindowManager.<span class="hljs-type">LayoutParams</span> <span class="hljs-variable">l</span> <span class="hljs-operator">=</span> r.window.getAttributes();<br>                a.mDecor = decor;<br>                l.type = WindowManager.LayoutParams.TYPE_BASE_APPLICATION;<br>                l.softInputMode |= forwardBit;<br>                <span class="hljs-keyword">if</span> (r.mPreserveWindow) &#123;<br>                    a.mWindowAdded = <span class="hljs-literal">true</span>;<br>                    r.mPreserveWindow = <span class="hljs-literal">false</span>;<br>                    <span class="hljs-type">ViewRootImpl</span> <span class="hljs-variable">impl</span> <span class="hljs-operator">=</span> decor.getViewRootImpl();<br>                    <span class="hljs-keyword">if</span> (impl != <span class="hljs-literal">null</span>) &#123;<br>                        impl.notifyChildRebuilt();<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">if</span> (a.mVisibleFromClient) &#123;<br>                    <span class="hljs-keyword">if</span> (!a.mWindowAdded) &#123;<br>                        a.mWindowAdded = <span class="hljs-literal">true</span>;<br>                        <span class="hljs-comment">//将DecorView添加到PhoneWindow中</span><br>                        wm.addView(decor, l);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        a.onWindowAttributesChanged(l);<br>                    &#125;<br>                &#125;<br><br>            <span class="hljs-comment">// If the window has already been added, but during resume</span><br>            <span class="hljs-comment">// we started another activity, then don&#x27;t yet make the</span><br>            <span class="hljs-comment">// window visible.</span><br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!willBeVisible) &#123;<br>                <span class="hljs-keyword">if</span> (localLOGV) Slog.v(<br>                    TAG, <span class="hljs-string">&quot;Launch &quot;</span> + r + <span class="hljs-string">&quot; mStartedActivity set&quot;</span>);<br>                r.hideForNow = <span class="hljs-literal">true</span>;<br>            &#125;    <br>            &#125;<br>        <span class="hljs-keyword">if</span> (!r.activity.mFinished &amp;&amp; willBeVisible &amp;&amp; r.activity.mDecor != <span class="hljs-literal">null</span> &amp;&amp; !r.hideForNow) &#123;<br>...<br>            <span class="hljs-keyword">if</span> (r.activity.mVisibleFromClient) &#123;<br>              <span class="hljs-comment">//显示DecorView</span><br>                r.activity.makeVisible();<br>            &#125;<br>        &#125;<br>...<br>    &#125;<br><br><span class="hljs-comment">//Activity.java</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">makeVisible</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (!mWindowAdded) &#123;<br>            <span class="hljs-type">ViewManager</span> <span class="hljs-variable">wm</span> <span class="hljs-operator">=</span> getWindowManager();<br>            wm.addView(mDecor, getWindow().getAttributes());<br>            mWindowAdded = <span class="hljs-literal">true</span>;<br>        &#125;<br>      <span class="hljs-comment">//显示DecorView及其内容</span><br>        mDecor.setVisibility(View.VISIBLE);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>后续调用到了<code>wm.addView()</code>。将对应的DecorView传递进去。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ../android/view/WindowManagerImpl.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WindowManagerImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WindowManager</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">WindowManagerGlobal</span> <span class="hljs-variable">mGlobal</span> <span class="hljs-operator">=</span> WindowManagerGlobal.getInstance();<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Window mParentWindow;<br>    ...<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addView</span><span class="hljs-params">(<span class="hljs-meta">@NonNull</span> View view, <span class="hljs-meta">@NonNull</span> ViewGroup.LayoutParams params)</span> &#123;<br>        applyDefaultToken(params);<br>        <span class="hljs-comment">//调用到了WindowManagerGlobal中的addView</span><br>        mGlobal.addView(view, params, mContext.getDisplay(), mParentWindow);<br>    &#125;   <br>    ...<br>&#125;<br><br><span class="hljs-comment">// ../android/view/WindowManagerGlobal.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addView</span><span class="hljs-params">(View view, ViewGroup.LayoutParams params,</span><br><span class="hljs-params">            Display display, Window parentWindow)</span> &#123;<br>        ...<br><br>        ViewRootImpl root;<br>        <span class="hljs-type">View</span> <span class="hljs-variable">panelParentView</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">synchronized</span> (mLock) &#123;<br>            ...<br>            <span class="hljs-comment">//创建了ViewRootImpl实例</span><br>            root = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ViewRootImpl</span>(view.getContext(), display);<span class="hljs-comment">//初始化了ViewRootImpl对象</span><br>            view.setLayoutParams(wparams);<br>            mViews.add(view);<br>            mRoots.add(root);<br>            mParams.add(wparams);<br>            <span class="hljs-comment">// do this last because it fires off messages to start doing things</span><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">//调用setView 将传进来的DecorView添加到PhoneWindow中。 </span><br>                root.setView(view, wparams, panelParentView);<br>            &#125; <span class="hljs-keyword">catch</span> (RuntimeException e) &#123;<br>                <span class="hljs-comment">// BadTokenException or InvalidDisplayException, clean up.</span><br>                <span class="hljs-keyword">if</span> (index &gt;= <span class="hljs-number">0</span>) &#123;<br>                    removeViewLocked(index, <span class="hljs-literal">true</span>);<br>                &#125;<br>                <span class="hljs-keyword">throw</span> e;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>经过<code>ActivityThread.handleResumeActivity() -&gt; WindowManagerGlobal.addView() </code>创建了<code>ViewRootImpl</code>对象</p>
<h3 id="与DecorView的关系"><a href="#与DecorView的关系" class="headerlink" title="与DecorView的关系"></a>与DecorView的关系</h3><p>上述流程走完后，就把DecorView加载到了Window中。<strong>这个流程中将ViewRootImpl对象与DecorView进行了关联</strong>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//view 表示 DecorView </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setView</span><span class="hljs-params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span> &#123;<br>     <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>)&#123;<br>         <span class="hljs-comment">//传进来的DecorView作为全局变量使用</span><br>          mView = view;<br>         ...<br>          <span class="hljs-comment">// Schedule the first layout -before- adding to the window</span><br>                <span class="hljs-comment">// manager, to make sure we do the relayout before receiving</span><br>                <span class="hljs-comment">// any other events from the system.</span><br>          <span class="hljs-comment">//绘制整个布局</span><br>          requestLayout();   <br>         ...<br>          <span class="hljs-comment">//设置ViewRootImpl为DecorView的parentView </span><br>          view.assignParent(<span class="hljs-built_in">this</span>);<br>     &#125;   <br> &#125;<br></code></pre></td></tr></table></figure>

<p>执行到<code>ViewRootImpl.setView()</code>设置<code>DecorView,assignParent(root)</code>。表示<strong>ViewRootImpl是DecorView的parent</strong>。</p>
<p><img src="/images/%E4%B8%89%E8%80%85%E5%85%B3%E7%B3%BB.png" srcset="/img/loading.gif" lazyload alt="三者关系"></p>
<blockquote>
<p><code>Activity</code>、<code>Window(PhoneWindow)</code>、<code>View(DecorView)</code>、<code>ViewRootImpl</code>之间的关系？</p>
<p><code>PhoneWindow</code>是<code>Window</code>的唯一子类，在<code>Activity.attach()</code>构建的实例，是<strong>Activity与View交互的中间层</strong></p>
<p><code>DecorView</code>是<code>所有View</code>的最顶层，<code>ViewRootImpl</code>是<code>DecorView</code>的<code>parent</code>，负责<code>WindowManagerService</code>与<code>DecorView</code>的通信。<strong>掌管View的各种事件，例如<code>刷新、点击</code>事件等</strong></p>
</blockquote>
<h2 id="LayoutInflater"><a href="#LayoutInflater" class="headerlink" title="LayoutInflater"></a>LayoutInflater</h2><blockquote>
<p><code>LayoutInflater</code>是一个抽象类，具体实现类为<code>PhoneLayoutInflater</code>。主要用于进行<code>布局加载</code>。</p>
</blockquote>
<h3 id="PhoneLayoutInflater"><a href="#PhoneLayoutInflater" class="headerlink" title="PhoneLayoutInflater"></a>PhoneLayoutInflater</h3><p><img src="/images/View%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-LayoutInflater-PhoneLayoutInflater.png" srcset="/img/loading.gif" lazyload alt="View工作原理-LayoutInflater-PhoneLayoutInflater"></p>
<blockquote>
<p> 通过系统注册服务可以得到<code>LayoutInflater</code>的实现类<code>PhoneLayoutInflater</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//LayoutInflater.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> LayoutInflater <span class="hljs-title function_">from</span><span class="hljs-params">(Context context)</span> &#123;<br>    <span class="hljs-type">LayoutInflater</span> <span class="hljs-variable">LayoutInflater</span> <span class="hljs-operator">=</span><br>            (LayoutInflater) context.getSystemService(Context.LAYOUT_INFLATER_SERVICE);<span class="hljs-comment">//获取系统配置的加载服务</span><br>    <span class="hljs-keyword">if</span> (LayoutInflater == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AssertionError</span>(<span class="hljs-string">&quot;LayoutInflater not found.&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> LayoutInflater;<br>&#125;<br><br><span class="hljs-comment">//ContextThemeWrapper.java</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getSystemService</span><span class="hljs-params">(String name)</span> &#123;<br>        <span class="hljs-keyword">if</span> (LAYOUT_INFLATER_SERVICE.equals(name)) &#123;<br>          <span class="hljs-comment">//单例获取 LayoutInflater</span><br>            <span class="hljs-keyword">if</span> (mInflater == <span class="hljs-literal">null</span>) &#123;<br>                mInflater = LayoutInflater.from(getBaseContext()).cloneInContext(<span class="hljs-built_in">this</span>);<br>            &#125;<br>            <span class="hljs-keyword">return</span> mInflater;<br>        &#125;<br>        <span class="hljs-keyword">return</span> getBaseContext().getSystemService(name);<br>    &#125;<br><br><span class="hljs-comment">//SystemServerRegistry.java</span><br><span class="hljs-comment">//系统设置 PhoneInflater 为加载类</span><br>registerService(Context.LAYOUT_INFLATER_SERVICE, LayoutInflater.class,<br>            <span class="hljs-keyword">new</span> <span class="hljs-title class_">CachedServiceFetcher</span>&lt;LayoutInflater&gt;() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> LayoutInflater <span class="hljs-title function_">createService</span><span class="hljs-params">(ContextImpl ctx)</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">PhoneLayoutInflater</span>(ctx.getOuterContext());<br>        &#125;&#125;);<br></code></pre></td></tr></table></figure>
<p><code>PhoneLayoutInflater</code>设置的<code>context</code>为<code>ContextImpl.getOuterContext()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ContextImpl.java</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setOuterContext</span><span class="hljs-params">(Context context)</span> &#123;<br>        mOuterContext = context;<br>    &#125;<br><br>    <span class="hljs-keyword">final</span> Context <span class="hljs-title function_">getOuterContext</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> mOuterContext;<br>    &#125;<br><br><span class="hljs-comment">//ActivityThread.java</span><br>    <span class="hljs-keyword">private</span> Activity <span class="hljs-title function_">performLaunchActivity</span><span class="hljs-params">(ActivityClientRecord r, Intent customIntent)</span> &#123;<br>      ...<br>        appContext.setOuterContext(activity);<span class="hljs-comment">//设置外部context为Activity</span><br>    &#125;<br></code></pre></td></tr></table></figure>

<p><strong>一般从<code>Activity、View、Dialog，Fragment</code>获取的<code>layoutInflater.getContext()</code>为Activity</strong></p>
<blockquote>
<p>无论是哪种方式获取<code>LayoutInflater</code>，都是通过<code>ContextImpl.getSystemService()</code>获取的。</p>
</blockquote>
<h3 id="inflate-加载布局"><a href="#inflate-加载布局" class="headerlink" title="inflate()-加载布局"></a>inflate()-加载布局</h3><p><img src="/images/LayoutInflater-inflate.png" srcset="/img/loading.gif" lazyload alt="LayoutInflater-inflate"></p>
<blockquote>
<p><code>source</code>：需要加载的layout id</p>
<p><code>root</code>：根布局(<code>为null则表示创建的是最顶层的布局</code>)</p>
<p>*<code>attachToRoot</code>：是否添加到<code>root</code>中</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//LayoutInflater.java</span><br>   <span class="hljs-keyword">public</span> View <span class="hljs-title function_">inflate</span><span class="hljs-params">(<span class="hljs-meta">@LayoutRes</span> <span class="hljs-type">int</span> resource, <span class="hljs-meta">@Nullable</span> ViewGroup root)</span> &#123;<br>        <span class="hljs-keyword">return</span> inflate(resource, root, root != <span class="hljs-literal">null</span>);<br>   &#125;   <br><br>   <span class="hljs-keyword">public</span> View <span class="hljs-title function_">inflate</span><span class="hljs-params">(<span class="hljs-meta">@LayoutRes</span> <span class="hljs-type">int</span> resource, <span class="hljs-meta">@Nullable</span> ViewGroup root, <span class="hljs-type">boolean</span> attachToRoot)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Resources</span> <span class="hljs-variable">res</span> <span class="hljs-operator">=</span> getContext().getResources();<br>        ...<br>        <span class="hljs-comment">//构造xml解析器</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">XmlResourceParser</span> <span class="hljs-variable">parser</span> <span class="hljs-operator">=</span> res.getLayout(resource);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-keyword">return</span> inflate(parser, root, attachToRoot);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            parser.close();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> View <span class="hljs-title function_">inflate</span><span class="hljs-params">(XmlPullParser parser, <span class="hljs-meta">@Nullable</span> ViewGroup root, <span class="hljs-type">boolean</span> attachToRoot)</span> &#123;<br>        <span class="hljs-keyword">synchronized</span> (mConstructorArgs) &#123;<br>            Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="hljs-string">&quot;inflate&quot;</span>);<br><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">Context</span> <span class="hljs-variable">inflaterContext</span> <span class="hljs-operator">=</span> mContext;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">AttributeSet</span> <span class="hljs-variable">attrs</span> <span class="hljs-operator">=</span> Xml.asAttributeSet(parser);<br>            <span class="hljs-type">Context</span> <span class="hljs-variable">lastContext</span> <span class="hljs-operator">=</span> (Context) mConstructorArgs[<span class="hljs-number">0</span>];<br>            mConstructorArgs[<span class="hljs-number">0</span>] = inflaterContext;<br>            <span class="hljs-type">View</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> root;<br><br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-comment">// Look for the root node.</span><br>                <span class="hljs-type">int</span> type;<br>                <span class="hljs-comment">//非xml起始与结尾标记</span><br>                <span class="hljs-keyword">while</span> ((type = parser.next()) != XmlPullParser.START_TAG &amp;&amp;<br>                        type != XmlPullParser.END_DOCUMENT) &#123;<br>                &#125;<br>            <br>                <span class="hljs-keyword">if</span> (type != XmlPullParser.START_TAG) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InflateException</span>(parser.getPositionDescription()<br>                            + <span class="hljs-string">&quot;: No start tag found!&quot;</span>);<br>                &#125;<br><br>                <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> parser.getName();<br>                <span class="hljs-comment">//处理&lt;merge&gt;标签</span><br>                <span class="hljs-keyword">if</span> (TAG_MERGE.equals(name)) &#123;<br>                    <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span> || !attachToRoot) &#123;<br>                        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InflateException</span>(<span class="hljs-string">&quot;&lt;merge /&gt; can be used only with a valid &quot;</span><br>                                + <span class="hljs-string">&quot;ViewGroup root and attachToRoot=true&quot;</span>);<br>                    &#125;<br>                    <span class="hljs-comment">//传入rootview 解析得到的布局直接加入rootView中</span><br>                    rInflate(parser, root, inflaterContext, attrs, <span class="hljs-literal">false</span>);<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    <span class="hljs-comment">// Temp is the root view that was found in the xml</span><br>                    <span class="hljs-comment">//根据Tag创建对应的View 例如&lt;TextView&gt;</span><br>                    <span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">temp</span> <span class="hljs-operator">=</span> createViewFromTag(root, name, inflaterContext, attrs);<br><br>                    ViewGroup.<span class="hljs-type">LayoutParams</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br><br>                    <span class="hljs-keyword">if</span> (root != <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-comment">// Create layout params that match root, if supplied</span><br>                        params = root.generateLayoutParams(attrs);<br>                        <span class="hljs-keyword">if</span> (!attachToRoot) &#123;<br>                            <span class="hljs-comment">// Set the layout params for temp if we are not</span><br>                            <span class="hljs-comment">// attaching. (If we are, we use addView, below)</span><br>                            temp.setLayoutParams(params);<br>                        &#125;<br>                    &#125;<br><br>                    <span class="hljs-comment">// Inflate all children under temp against its context.</span><br>                    <span class="hljs-comment">//创建temp子View</span><br>                    rInflateChildren(parser, temp, attrs, <span class="hljs-literal">true</span>);<br><br>                    <span class="hljs-comment">// We are supposed to attach all the views we found (int temp)</span><br>                    <span class="hljs-comment">// to root. Do that now.</span><br>                    <span class="hljs-keyword">if</span> (root != <span class="hljs-literal">null</span> &amp;&amp; attachToRoot) &#123;<br>                        <span class="hljs-comment">//将temp添加到rootView中</span><br>                        root.addView(temp, params);<br>                    &#125;<br><br>                    <span class="hljs-comment">// Decide whether to return the root that was passed in or the</span><br>                    <span class="hljs-comment">// top view found in xml.</span><br>                    <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span> || !attachToRoot) &#123;<br>                        <span class="hljs-comment">//attachToRoot：将View添加到RootView中，非就是直接返回解析的子View</span><br>                        result = temp;<br>                    &#125;<br>                &#125;<br><br>            &#125; <span class="hljs-keyword">catch</span> (XmlPullParserException e) &#123;<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">InflateException</span> <span class="hljs-variable">ie</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InflateException</span>(e.getMessage(), e);<br>                ie.setStackTrace(EMPTY_STACK_TRACE);<br>                <span class="hljs-keyword">throw</span> ie;<br>            &#125; <span class="hljs-keyword">catch</span> (Exception e) &#123;<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">InflateException</span> <span class="hljs-variable">ie</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InflateException</span>(parser.getPositionDescription()<br>                        + <span class="hljs-string">&quot;: &quot;</span> + e.getMessage(), e);<br>                ie.setStackTrace(EMPTY_STACK_TRACE);<br>                <span class="hljs-keyword">throw</span> ie;<br>            &#125; <span class="hljs-keyword">finally</span> &#123;<br>                <span class="hljs-comment">// Don&#x27;t retain static reference on context.</span><br>                mConstructorArgs[<span class="hljs-number">0</span>] = lastContext;<br>                mConstructorArgs[<span class="hljs-number">1</span>] = <span class="hljs-literal">null</span>;<br><br>                Trace.traceEnd(Trace.TRACE_TAG_VIEW);<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> result;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">rInflate</span><span class="hljs-params">(XmlPullParser parser, View parent, Context context,</span><br><span class="hljs-params">            AttributeSet attrs, <span class="hljs-type">boolean</span> finishInflate)</span> <span class="hljs-keyword">throws</span> XmlPullParserException, IOException &#123;<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">depth</span> <span class="hljs-operator">=</span> parser.getDepth();<br>        <span class="hljs-type">int</span> type;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">pendingRequestFocus</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-keyword">while</span> (((type = parser.next()) != XmlPullParser.END_TAG ||<br>                parser.getDepth() &gt; depth) &amp;&amp; type != XmlPullParser.END_DOCUMENT) &#123;<br><br>            <span class="hljs-keyword">if</span> (type != XmlPullParser.START_TAG) &#123;<br>                <span class="hljs-keyword">continue</span>;<br>            &#125;<br><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">name</span> <span class="hljs-operator">=</span> parser.getName();<br><br>            <span class="hljs-keyword">if</span> (TAG_REQUEST_FOCUS.equals(name)) &#123;<br>                pendingRequestFocus = <span class="hljs-literal">true</span>;<br>                consumeChildElements(parser);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (TAG_TAG.equals(name)) &#123;<br>                parseViewTag(parser, parent, attrs);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (TAG_INCLUDE.equals(name)) &#123;<span class="hljs-comment">//&lt;include&gt;</span><br>                <span class="hljs-keyword">if</span> (parser.getDepth() == <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InflateException</span>(<span class="hljs-string">&quot;&lt;include /&gt; cannot be the root element&quot;</span>);<br>                &#125;<br>                parseInclude(parser, context, parent, attrs);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (TAG_MERGE.equals(name)) &#123;<span class="hljs-comment">//&lt;merge&gt;</span><br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">InflateException</span>(<span class="hljs-string">&quot;&lt;merge /&gt; must be the root element&quot;</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//创建View</span><br>                <span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> createViewFromTag(parent, name, context, attrs);<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">ViewGroup</span> <span class="hljs-variable">viewGroup</span> <span class="hljs-operator">=</span> (ViewGroup) parent;<br>                <span class="hljs-keyword">final</span> ViewGroup.<span class="hljs-type">LayoutParams</span> <span class="hljs-variable">params</span> <span class="hljs-operator">=</span> viewGroup.generateLayoutParams(attrs);<br>                <span class="hljs-comment">//递归创建子View</span><br>                rInflateChildren(parser, view, attrs, <span class="hljs-literal">true</span>);<br>                <span class="hljs-comment">//创建的子View添加会parent</span><br>                viewGroup.addView(view, params);<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (pendingRequestFocus) &#123;<br>            parent.restoreDefaultFocus();<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> (finishInflate) &#123;<br>            parent.onFinishInflate();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><code>layoutInflater.inflate()</code>主要是调用<code>createViewFromTag()</code>从xml生成view的。</p>
<h4 id="createViewFromTag"><a href="#createViewFromTag" class="headerlink" title="* createViewFromTag()"></a>* createViewFromTag()</h4><blockquote>
<p>主要负责将<code>&lt;tag&gt;</code>创建成<code>View</code>对象</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//LayoutInflater.java</span><br>View <span class="hljs-title function_">createViewFromTag</span><span class="hljs-params">(View parent, String name, Context context, AttributeSet attrs,</span><br><span class="hljs-params">            <span class="hljs-type">boolean</span> ignoreThemeAttr)</span> &#123;<br>        <span class="hljs-comment">/**</span><br><span class="hljs-comment">        * view标签 取class 做为name</span><br><span class="hljs-comment">        */</span><br>        <span class="hljs-keyword">if</span> (name.equals(<span class="hljs-string">&quot;view&quot;</span>)) &#123;<br>            name = attrs.getAttributeValue(<span class="hljs-literal">null</span>, <span class="hljs-string">&quot;class&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-comment">// 设置View的Theme</span><br>        <span class="hljs-keyword">if</span> (!ignoreThemeAttr) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">TypedArray</span> <span class="hljs-variable">ta</span> <span class="hljs-operator">=</span> context.obtainStyledAttributes(attrs, ATTRS_THEME);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">themeResId</span> <span class="hljs-operator">=</span> ta.getResourceId(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>);<br>            <span class="hljs-keyword">if</span> (themeResId != <span class="hljs-number">0</span>) &#123;<br>                context = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ContextThemeWrapper</span>(context, themeResId);<br>            &#125;<br>            ta.recycle();<br>        &#125;<br>        <span class="hljs-comment">//处理 &lt;blink&gt;标签</span><br>        <span class="hljs-keyword">if</span> (name.equals(TAG_1995)) &#123;<br>            <span class="hljs-comment">// Let&#x27;s party like it&#x27;s 1995!</span><br>            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">BlinkLayout</span>(context, attrs);<br>        &#125;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            View view;<br>            <span class="hljs-comment">//通过Factory /Factory2  进行View的实例化</span><br>            <span class="hljs-keyword">if</span> (mFactory2 != <span class="hljs-literal">null</span>) &#123;<br>                view = mFactory2.onCreateView(parent, name, context, attrs);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (mFactory != <span class="hljs-literal">null</span>) &#123;<br>                view = mFactory.onCreateView(name, context, attrs);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                view = <span class="hljs-literal">null</span>;<br>            &#125;<br>            <span class="hljs-comment">//通过 mPrivateFactory实例化View</span><br>            <span class="hljs-keyword">if</span> (view == <span class="hljs-literal">null</span> &amp;&amp; mPrivateFactory != <span class="hljs-literal">null</span>) &#123;<br>                view = mPrivateFactory.onCreateView(parent, name, context, attrs);<br>            &#125;<br>            <span class="hljs-comment">//未设置 Factory，走默认创建View的流程</span><br>            <span class="hljs-keyword">if</span> (view == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lastContext</span> <span class="hljs-operator">=</span> mConstructorArgs[<span class="hljs-number">0</span>];<br>                mConstructorArgs[<span class="hljs-number">0</span>] = context;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-comment">//&lt;tag&gt;中存在 . 可以判断为自定义View，走View自身的创建流程</span><br>                    <span class="hljs-keyword">if</span> (-<span class="hljs-number">1</span> == name.indexOf(<span class="hljs-string">&#x27;.&#x27;</span>)) &#123;<br>                        view = onCreateView(parent, name, attrs);<br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        view = createView(name, <span class="hljs-literal">null</span>, attrs);<br>                    &#125;<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    mConstructorArgs[<span class="hljs-number">0</span>] = lastContext;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">return</span> view;<br>        &#125;<br>        ...<br>    &#125;<br>&#125;<br>      <br></code></pre></td></tr></table></figure>

<p><code>createViewFromTag()</code>主要做了以下几步：</p>
<ol>
<li><p>如果为<code>&lt;view&gt;</code>标签，读取<code>class</code>属性做为类名</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">view</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;LinearLayout&quot;</span>/&gt;</span> 等价于<span class="hljs-tag">&lt;<span class="hljs-name">LinearLayout</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">LinearLayout</span>&gt;</span><br></code></pre></td></tr></table></figure>


</li>
<li><p>应用<code>ContextThemeWrapper</code>为View设置主题<code>Theme</code></p>
</li>
<li><p>使用<code>Factory/Factory2/mPrivateFactory</code>实例化<code>View</code>，相当于<strong>拦截</strong></p>
<blockquote>
<p>实例化<code>View</code>的优先顺序为<code>Factory2 &gt; Factory &gt; mPrivateFactory &gt; PhoneLayoutInflater</code></p>
</blockquote>
</li>
<li><p>未设置<code>以上factory</code>，执行<code>View</code>的默认创建流程</p>
<blockquote>
<p>主要通过<code>PhoneLayoutInflater</code>执行</p>
</blockquote>
</li>
</ol>
<h3 id="Factory-Factory2-拦截View创建"><a href="#Factory-Factory2-拦截View创建" class="headerlink" title="Factory&#x2F;Factory2-拦截View创建"></a>Factory&#x2F;Factory2-拦截View创建</h3><p><img src="/images/LayoutInflater-Factory2.png" srcset="/img/loading.gif" lazyload alt="LayoutInflater-Factory2"></p>
<blockquote>
<p>在上节有说到<code>Factory/Factory2</code>执行相当于拦截的功能，<code>hook</code>View创建的流程</p>
<p><code>mPrivateFactory</code>实现了<code>Factory2</code>接口，主要用于拦截<code>&lt;fragment&gt;</code>标签处理</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> Factory mFactory;<br><span class="hljs-keyword">private</span> Factory2 mFactory2;<br><span class="hljs-keyword">private</span> Factory2 mPrivateFactory;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Factory</span> &#123;<br>    <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(String name, Context context, AttributeSet attrs)</span>;<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">Factory2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">Factory</span> &#123;<br>    <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(View parent, String name, Context context, AttributeSet attrs)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>Factory2</code>相对于<code>Factory</code>在<code>onCreateView()</code>多传入了<code>parent</code></p>
<h4 id="Factory2"><a href="#Factory2" class="headerlink" title="Factory2"></a>Factory2</h4><p>设置<code>Factory2</code>的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFactory2</span><span class="hljs-params">(Factory2 factory)</span> &#123;<br>    <span class="hljs-keyword">if</span> (mFactorySet) &#123; <span class="hljs-comment">//只允许设置一次 Factory2</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalStateException</span>(<span class="hljs-string">&quot;A factory has already been set on this LayoutInflater&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">if</span> (factory == <span class="hljs-literal">null</span>) &#123;<span class="hljs-comment">//设置的factory不能为null</span><br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NullPointerException</span>(<span class="hljs-string">&quot;Given factory can not be null&quot;</span>);<br>    &#125;<br>    mFactorySet = <span class="hljs-literal">true</span>;<br>    <span class="hljs-keyword">if</span> (mFactory == <span class="hljs-literal">null</span>) &#123;<br>        mFactory = mFactory2 = factory;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">//控制factory调用顺序</span><br>        mFactory = mFactory2 = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FactoryMerger</span>(factory, factory, mFactory, mFactory2);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FactoryMerger</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Factory2</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Factory mF1, mF2;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> Factory2 mF12, mF22;<br><br>    FactoryMerger(Factory f1, Factory2 f12, Factory f2, Factory2 f22) &#123;<br>        mF1 = f1;<br>        mF2 = f2;<br>        mF12 = f12;<br>        mF22 = f22;<br>    &#125;<br><br>  <span class="hljs-comment">//此处对应Factory</span><br>    <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(String name, Context context, AttributeSet attrs)</span> &#123;<br>        <span class="hljs-type">View</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> mF1.onCreateView(name, context, attrs);<br>        <span class="hljs-keyword">if</span> (v != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> v;<br>        <span class="hljs-keyword">return</span> mF2.onCreateView(name, context, attrs);<br>    &#125;<br>   <span class="hljs-comment">//此处对应Factory2</span><br>    <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(View parent, String name, Context context, AttributeSet attrs)</span> &#123;<br>        <span class="hljs-type">View</span> <span class="hljs-variable">v</span> <span class="hljs-operator">=</span> mF12 != <span class="hljs-literal">null</span> ? mF12.onCreateView(parent, name, context, attrs)<br>                : mF1.onCreateView(name, context, attrs);<br>        <span class="hljs-keyword">if</span> (v != <span class="hljs-literal">null</span>) <span class="hljs-keyword">return</span> v;<br>        <span class="hljs-keyword">return</span> mF22 != <span class="hljs-literal">null</span> ? mF22.onCreateView(parent, name, context, attrs)<br>                : mF2.onCreateView(name, context, attrs);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最终都是通过<code>FactoryMerger</code>执行的<code>onCreateView</code></p>
<h5 id="何处调用setFactory2"><a href="#何处调用setFactory2" class="headerlink" title="何处调用setFactory2()"></a>何处调用setFactory2()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//AppCompatActivity.onCreate() -&gt; AppCompatDelegate.installViewFactory() -&gt;</span><br><span class="hljs-comment">//AppCompatDelegateImpl.installViewFactory()</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">installViewFactory</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">LayoutInflater</span> <span class="hljs-variable">layoutInflater</span> <span class="hljs-operator">=</span> LayoutInflater.from(<span class="hljs-built_in">this</span>.mContext);<br>        <span class="hljs-keyword">if</span> (layoutInflater.getFactory() == <span class="hljs-literal">null</span>) &#123;<br>            LayoutInflaterCompat.setFactory2(layoutInflater, <span class="hljs-built_in">this</span>);<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (!(layoutInflater.getFactory2() <span class="hljs-keyword">instanceof</span> AppCompatDelegateImpl)) &#123;<br>            Log.i(<span class="hljs-string">&quot;AppCompatDelegate&quot;</span>, <span class="hljs-string">&quot;The Activity&#x27;s LayoutInflater already has a Factory installed so we can not install AppCompat&#x27;s&quot;</span>);<br>        &#125;<br>    &#125;<br><br><span class="hljs-comment">//设置Factory2执行到 onCreateView()</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(View parent, String name, Context context, AttributeSet attrs)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.createView(parent, name, context, attrs);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> View <span class="hljs-title function_">createView</span><span class="hljs-params">(View parent, String name, <span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-meta">@NonNull</span> AttributeSet attrs)</span> &#123;<br>        <span class="hljs-keyword">if</span> (<span class="hljs-built_in">this</span>.mAppCompatViewInflater == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">TypedArray</span> <span class="hljs-variable">a</span> <span class="hljs-operator">=</span> <span class="hljs-built_in">this</span>.mContext.obtainStyledAttributes(styleable.AppCompatTheme);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">viewInflaterClassName</span> <span class="hljs-operator">=</span> a.getString(styleable.AppCompatTheme_viewInflaterClass);<br>            <span class="hljs-keyword">if</span> (viewInflaterClassName != <span class="hljs-literal">null</span> &amp;&amp; !AppCompatViewInflater.class.getName().equals(viewInflaterClassName)) &#123;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-type">Class</span> <span class="hljs-variable">viewInflaterClass</span> <span class="hljs-operator">=</span> Class.forName(viewInflaterClassName);<br>                    <span class="hljs-built_in">this</span>.mAppCompatViewInflater = (AppCompatViewInflater)viewInflaterClass.getDeclaredConstructor().newInstance();<br>                &#125; <span class="hljs-keyword">catch</span> (Throwable var8) &#123;<br>                    Log.i(<span class="hljs-string">&quot;AppCompatDelegate&quot;</span>, <span class="hljs-string">&quot;Failed to instantiate custom view inflater &quot;</span> + viewInflaterClassName + <span class="hljs-string">&quot;. Falling back to default.&quot;</span>, var8);<br>                    <span class="hljs-built_in">this</span>.mAppCompatViewInflater = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppCompatViewInflater</span>();<br>                &#125;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-built_in">this</span>.mAppCompatViewInflater = <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppCompatViewInflater</span>();<br>            &#125;<br>        &#125;<br><br>        ...<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>.mAppCompatViewInflater.createView(...);<br>    &#125;<br><br></code></pre></td></tr></table></figure>

<p>通过<code>AppCompatViewInflater</code>去执行View的创建</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//AppCompatViewInflater.java</span><br>    <span class="hljs-keyword">final</span> View <span class="hljs-title function_">createView</span><span class="hljs-params">(View parent, String name, <span class="hljs-meta">@NonNull</span> Context context, <span class="hljs-meta">@NonNull</span> AttributeSet attrs, <span class="hljs-type">boolean</span> inheritContext, <span class="hljs-type">boolean</span> readAndroidTheme, <span class="hljs-type">boolean</span> readAppTheme, <span class="hljs-type">boolean</span> wrapContext)</span> &#123;<br>  ...<br>     <span class="hljs-keyword">switch</span> (name) &#123;<br>            <span class="hljs-keyword">case</span> <span class="hljs-string">&quot;TextView&quot;</span>:<br>                view = createTextView(context, attrs);<br>                verifyNotNull(view, name);<br>                <span class="hljs-keyword">break</span>;<br>         ...<br>     &#125;<br>&#125;<br><br>    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-keyword">protected</span> AppCompatTextView <span class="hljs-title function_">createTextView</span><span class="hljs-params">(Context context, AttributeSet attrs)</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">AppCompatTextView</span>(context, attrs);<br>    &#125;<br><br><br></code></pre></td></tr></table></figure>

<p>此处可以在使用到<code>AppCompatActivity</code>时，将原先的<code>&lt;TextView&gt;</code>转换为<code>AppCompatTextView</code></p>
<h4 id="mPrivateFactory"><a href="#mPrivateFactory" class="headerlink" title="mPrivateFactory"></a>mPrivateFactory</h4><blockquote>
<p>系统hide对象，无法被外界使用，主要处理<code>&lt;fragment&gt;</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setPrivateFactory</span><span class="hljs-params">(Factory2 factory)</span> &#123;<br>    <span class="hljs-keyword">if</span> (mPrivateFactory == <span class="hljs-literal">null</span>) &#123;<br>        mPrivateFactory = factory;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        mPrivateFactory = <span class="hljs-keyword">new</span> <span class="hljs-title class_">FactoryMerger</span>(factory, factory, mPrivateFactory, mPrivateFactory);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h5 id="何处调用setPrivateFactory"><a href="#何处调用setPrivateFactory" class="headerlink" title="何处调用setPrivateFactory()"></a>何处调用setPrivateFactory()</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//Activity.java</span><br><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">attach</span><span class="hljs-params">(Context context, ActivityThread aThread,</span><br><span class="hljs-params">            Instrumentation instr, IBinder token, <span class="hljs-type">int</span> ident,</span><br><span class="hljs-params">            Application application, Intent intent, ActivityInfo info,</span><br><span class="hljs-params">            CharSequence title, Activity parent, String id,</span><br><span class="hljs-params">            NonConfigurationInstances lastNonConfigurationInstances,</span><br><span class="hljs-params">            Configuration config, String referrer, IVoiceInteractor voiceInteractor,</span><br><span class="hljs-params">            Window window, ActivityConfigCallback activityConfigCallback)</span> &#123;<br>  ...<br>    mWindow.getLayoutInflater().setPrivateFactory(<span class="hljs-built_in">this</span>); <span class="hljs-comment">//this 表示当前Activity</span><br>  ...<br>&#125;<br><br>    <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(View parent, String name, Context context, AttributeSet attrs)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!<span class="hljs-string">&quot;fragment&quot;</span>.equals(name)) &#123;<br>            <span class="hljs-keyword">return</span> onCreateView(name, context, attrs);<br>        &#125;<br>       <span class="hljs-comment">//&lt;fragment&gt;标签直接解析执行 onCreateView</span><br>        <span class="hljs-keyword">return</span> mFragments.onCreateView(parent, name, context, attrs);<br>    &#125;<br><br></code></pre></td></tr></table></figure>

<h4 id="拓展使用"><a href="#拓展使用" class="headerlink" title="拓展使用"></a>拓展使用</h4><p>系统通过<code>Factory</code>提供<code>hook</code>方法，方便拦截<code>LayoutInflater</code>创建View的过程。支持以下应用场景：</p>
<ul>
<li>支持对自定义标签名称的处理</li>
<li>全局替换系统控件为自定义View</li>
<li><strong>替换字体</strong></li>
<li><strong>全局换肤</strong></li>
<li><strong>获取控件加载耗时</strong></li>
</ul>
<p>针对以上场景，实现部分关键代码以供参考</p>
<h5 id="获取控件加载耗时"><a href="#获取控件加载耗时" class="headerlink" title="获取控件加载耗时"></a>获取控件加载耗时</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//XXActivity.java</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onCreate</span><span class="hljs-params">(<span class="hljs-meta">@Nullable</span> Bundle savedInstanceState)</span> &#123;<br>      <span class="hljs-comment">//设置自定义Factory</span><br>        setFactory2();<br>        <span class="hljs-built_in">super</span>.onCreate(savedInstanceState);<br>        setContentView(R.layout.act_xx);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFactory2</span><span class="hljs-params">()</span>&#123;<br>        LayoutInflaterCompat.setFactory2(getLayoutInflater(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">LayoutInflater</span>.Factory2() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(View parent, String name, Context context, AttributeSet attrs)</span> &#123;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">startTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis();<span class="hljs-comment">//加载开始时间</span><br>                <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> getDelegate().createView(parent, name, context, attrs);<span class="hljs-comment">//开始加载</span><br>                <span class="hljs-type">long</span> <span class="hljs-variable">costTime</span> <span class="hljs-operator">=</span> System.currentTimeMillis() - startTime;<span class="hljs-comment">//加载结束时间</span><br>                Log.e(<span class="hljs-string">&quot;costTime&quot;</span>,costTime+<span class="hljs-string">&quot;&quot;</span>);<br>                <span class="hljs-keyword">return</span> view;<br>            &#125;<br><br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(String name, Context context, AttributeSet attrs)</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>        &#125;);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><code>setFactory2()</code>不可以放到<code>super.onCreate()</code>之后，会触发<code>A factory has already been set on this LayoutInflater</code>异常，原因就在于<code>setFactory2()</code>最多支持设置一个。</p>
<h5 id="替换字体"><a href="#替换字体" class="headerlink" title="替换字体"></a>替换字体</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setFontFactory2</span><span class="hljs-params">()</span> &#123;<br>    LayoutInflaterCompat.setFactory2(getLayoutInflater(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">LayoutInflater</span>.Factory2() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(View parent, String name, Context context, AttributeSet attrs)</span> &#123;<br>            <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> getDelegate().createView(parent, name, context, attrs);<br>            <span class="hljs-keyword">if</span> (view <span class="hljs-keyword">instanceof</span> TextView ) &#123;<br>                ((TextView) view).setTypeface(XX);<span class="hljs-comment">//设置对应字体</span><br>            &#125;<br>            <span class="hljs-keyword">return</span> view;<br>        &#125;<br><br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(String name, Context context, AttributeSet attrs)</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>



<p>只要执行了<code>getDelegate().createView()</code>可以保证<code>原生控件-&gt;兼容控件</code>功能正常。</p>
<h3 id="View默认创建流程"><a href="#View默认创建流程" class="headerlink" title="View默认创建流程"></a>View默认创建流程</h3><p><img src="/images/LayoutInflater-%E9%BB%98%E8%AE%A4View%E5%88%9B%E5%BB%BA%E6%B5%81%E7%A8%8B.png" srcset="/img/loading.gif" lazyload alt="LayoutInflater-默认View创建流程"></p>
<blockquote>
<p>未设置<code>Factory/Factory2</code>就会执行默认的View创建流程</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//LayoutInflater.java</span><br>    View <span class="hljs-title function_">createViewFromTag</span><span class="hljs-params">(View parent, String name, Context context, AttributeSet attrs,</span><br><span class="hljs-params">            <span class="hljs-type">boolean</span> ignoreThemeAttr)</span> &#123;<br>      ...<br>        <span class="hljs-keyword">if</span> (view == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">Object</span> <span class="hljs-variable">lastContext</span> <span class="hljs-operator">=</span> mConstructorArgs[<span class="hljs-number">0</span>];<br>                mConstructorArgs[<span class="hljs-number">0</span>] = context;<br>                <span class="hljs-keyword">try</span> &#123;<br>                    <span class="hljs-keyword">if</span> (-<span class="hljs-number">1</span> == name.indexOf(<span class="hljs-string">&#x27;.&#x27;</span>)) &#123;<br>                        view = onCreateView(parent, name, attrs);<span class="hljs-comment">//系统提供View</span><br>                    &#125; <span class="hljs-keyword">else</span> &#123;<br>                        view = createView(name, <span class="hljs-literal">null</span>, attrs);<span class="hljs-comment">//自定义View</span><br>                    &#125;<br>                &#125; <span class="hljs-keyword">finally</span> &#123;<br>                    mConstructorArgs[<span class="hljs-number">0</span>] = lastContext;<br>                &#125;<br>            &#125;<br>      ...<br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="系统提供View"><a href="#系统提供View" class="headerlink" title="系统提供View"></a>系统提供View</h4><blockquote>
<p>例如<code>&lt;TextView/&gt;、&lt;Button/&gt;</code>等</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">PhoneLayoutInflater</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">LayoutInflater</span> &#123;<br>     <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> String[] sClassPrefixList = &#123;<br>        <span class="hljs-string">&quot;android.widget.&quot;</span>,<br>        <span class="hljs-string">&quot;android.webkit.&quot;</span>,<br>        <span class="hljs-string">&quot;android.app.&quot;</span><br>    &#125;;<br><br>     <span class="hljs-meta">@Override</span> <span class="hljs-keyword">protected</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(String name, AttributeSet attrs)</span> <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        <span class="hljs-keyword">for</span> (String prefix : sClassPrefixList) &#123;<br>            <span class="hljs-keyword">try</span> &#123;<br>                <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> createView(name, prefix, attrs);<br>                <span class="hljs-keyword">if</span> (view != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">return</span> view;<br>                &#125;<br>            &#125; <span class="hljs-keyword">catch</span> (ClassNotFoundException e) &#123;<br>                <span class="hljs-comment">// In this case we want to let the base class take a crack</span><br>                <span class="hljs-comment">// at it.</span><br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">super</span>.onCreateView(name, attrs);<br>    &#125;<br>  <br>&#125;<br><br><span class="hljs-comment">//LayoutInflater.java</span><br>    <span class="hljs-keyword">protected</span> View <span class="hljs-title function_">onCreateView</span><span class="hljs-params">(String name, AttributeSet attrs)</span><br>            <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>        <span class="hljs-keyword">return</span> createView(name, <span class="hljs-string">&quot;android.view.&quot;</span>, attrs);<br>    &#125;<br><br></code></pre></td></tr></table></figure>

<p>优先判断</p>
<ul>
<li><code>android.widget.*</code> 例如<code>android.widget.TextView</code></li>
<li><code>android.webkit.*</code> 例如<code>android.webkit.WebView</code></li>
<li><code>android.app.*</code> 例如<code>android.app.ActionBar</code></li>
</ul>
<p>是否有对应<code>nmae</code>的View实例存在</p>
<p>都不存在，就在<code>android.view.*</code>找寻对应View实例 例如<code>android.view.ViewStub</code></p>
<h4 id="自定义View"><a href="#自定义View" class="headerlink" title="自定义View"></a>自定义View</h4><blockquote>
<p>例如<code>android.support.v7.widget.RecyclerView</code>等</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> View <span class="hljs-title function_">createView</span><span class="hljs-params">(String name, String prefix, AttributeSet attrs)</span><br>            <span class="hljs-keyword">throws</span> ClassNotFoundException, InflateException &#123;<br>       <span class="hljs-comment">//构建缓存，缓存已加载的View</span><br>        Constructor&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">View</span>&gt; constructor = sConstructorMap.get(name);<br>        <span class="hljs-keyword">if</span> (constructor != <span class="hljs-literal">null</span> &amp;&amp; !verifyClassLoader(constructor)) &#123;<br>            constructor = <span class="hljs-literal">null</span>;<br>            sConstructorMap.remove(name);<br>        &#125;<br>        Class&lt;? <span class="hljs-keyword">extends</span> <span class="hljs-title class_">View</span>&gt; clazz = <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            Trace.traceBegin(Trace.TRACE_TAG_VIEW, name);<br>            <span class="hljs-comment">//新建View构造器</span><br>            <span class="hljs-keyword">if</span> (constructor == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// 得到全限定名 例如android,widget.TextView</span><br>                clazz = mContext.getClassLoader().loadClass(<br>                        prefix != <span class="hljs-literal">null</span> ? (prefix + name) : name).asSubclass(View.class);<br><br>                <span class="hljs-keyword">if</span> (mFilter != <span class="hljs-literal">null</span> &amp;&amp; clazz != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-type">boolean</span> <span class="hljs-variable">allowed</span> <span class="hljs-operator">=</span> mFilter.onLoadClass(clazz);<br>                    <span class="hljs-keyword">if</span> (!allowed) &#123;<br>                        failNotAllowed(name, prefix, attrs);<br>                    &#125;<br>                &#125;<br>                constructor = clazz.getConstructor(mConstructorSignature);<br>                constructor.setAccessible(<span class="hljs-literal">true</span>);<br>                sConstructorMap.put(name, constructor);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">// If we have a filter, apply it to cached constructor</span><br>                <span class="hljs-keyword">if</span> (mFilter != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-comment">// Have we seen this name before?</span><br>                    <span class="hljs-type">Boolean</span> <span class="hljs-variable">allowedState</span> <span class="hljs-operator">=</span> mFilterMap.get(name);<br>                    <span class="hljs-keyword">if</span> (allowedState == <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-comment">// New class -- remember whether it is allowed</span><br>                        clazz = mContext.getClassLoader().loadClass(<br>                                prefix != <span class="hljs-literal">null</span> ? (prefix + name) : name).asSubclass(View.class);<br><br>                        <span class="hljs-type">boolean</span> <span class="hljs-variable">allowed</span> <span class="hljs-operator">=</span> clazz != <span class="hljs-literal">null</span> &amp;&amp; mFilter.onLoadClass(clazz);<br>                        mFilterMap.put(name, allowed);<br>                        <span class="hljs-keyword">if</span> (!allowed) &#123;<br>                            failNotAllowed(name, prefix, attrs);<br>                        &#125;<br>                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (allowedState.equals(Boolean.FALSE)) &#123;<br>                        failNotAllowed(name, prefix, attrs);<br>                    &#125;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-type">Object</span> <span class="hljs-variable">lastContext</span> <span class="hljs-operator">=</span> mConstructorArgs[<span class="hljs-number">0</span>];<br>            <span class="hljs-keyword">if</span> (mConstructorArgs[<span class="hljs-number">0</span>] == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// Fill in the context if not already within inflation.</span><br>                mConstructorArgs[<span class="hljs-number">0</span>] = mContext;<br>            &#125;<br>            Object[] args = mConstructorArgs;<br>            args[<span class="hljs-number">1</span>] = attrs;<br>            <span class="hljs-comment">//根据得到的 constuctor 实例化View对象</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> constructor.newInstance(args);<br>            <span class="hljs-comment">//针对ViewStub特殊处理</span><br>            <span class="hljs-keyword">if</span> (view <span class="hljs-keyword">instanceof</span> ViewStub) &#123;<br>                <span class="hljs-comment">// Use the same context when inflating ViewStub later.</span><br>                <span class="hljs-keyword">final</span> <span class="hljs-type">ViewStub</span> <span class="hljs-variable">viewStub</span> <span class="hljs-operator">=</span> (ViewStub) view;<br>                viewStub.setLayoutInflater(cloneInContext((Context) args[<span class="hljs-number">0</span>]));<br>            &#125;<br>            mConstructorArgs[<span class="hljs-number">0</span>] = lastContext;<br>            <span class="hljs-keyword">return</span> view;<br><br>        &#125; <br>  ...<br>    &#125;<br></code></pre></td></tr></table></figure>

<h4 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h4><p><code>View默认创建</code>流程分为：</p>
<ul>
<li><code>&lt;tag&gt;</code>不包含<code>.</code>，用于处理<code>&lt;TextView&gt;、&lt;WebView&gt;</code>等标签，此时需要拼接<code>android.widget. 或 android.webkit. 或 android.app. </code>前缀(<strong>实现位于<code>PhoneLayoutInflater</code></strong>)，都没有找到对应的<code>View实例</code>时，就会在添加<code>android.view.</code>再去加载。</li>
<li><code>&lt;tag&gt;</code>包含<code>.</code>，此时的实例View分为以下几步：<ul>
<li>构建View的缓存，缓存的是<code>constructor</code>，根据<code>name</code>获取<code>constructor</code></li>
<li>缓存中不存在时，需要根据<code>prefix+name</code>获取View的<code>constructor</code>，并存入缓存中</li>
<li>根据<code>constructor</code>构造<code>View实例</code>——<code>constructor.newInstance()</code></li>
<li>如果需要处理<code>ViewStub</code>，为<code>ViewStub</code>指定加载类</li>
</ul>
</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p><img src="/images/LayoutInflater%E8%BF%87%E7%A8%8B.jpg" srcset="/img/loading.gif" lazyload alt="LayoutInflater过程"></p>
<h2 id="View的绘制流程触发"><a href="#View的绘制流程触发" class="headerlink" title="View的绘制流程触发"></a>View的绘制流程触发</h2><p>调用了<code>ViewRootImpl.setView(decorView)</code>将DecorView与ViewRootImpl进行了关联。View的绘制流程就是从ViewRoot开始的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setView</span><span class="hljs-params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span> &#123;<br>     <span class="hljs-keyword">synchronized</span>(<span class="hljs-built_in">this</span>)&#123;<br>         <span class="hljs-comment">//传进来的DecorView作为全局变量使用</span><br>          mView = view;<br>         ...<br>          <span class="hljs-comment">// Schedule the first layout -before- adding to the window</span><br>                <span class="hljs-comment">// manager, to make sure we do the relayout before receiving</span><br>                <span class="hljs-comment">// any other events from the system.</span><br>          <span class="hljs-comment">//绘制整个布局</span><br>          requestLayout();   <br>         ...<br>          <span class="hljs-comment">//设置ViewRootImpl为DecorView的parentView </span><br>          view.assignParent(<span class="hljs-built_in">this</span>);<br>     &#125;   <br> &#125;<br><br><span class="hljs-comment">//请求刷新整个布局</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestLayout</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (!mHandlingLayoutInLayoutRequest) &#123;<br>            checkThread();<br>            mLayoutRequested = <span class="hljs-literal">true</span>;<br>            scheduleTraversals();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">scheduleTraversals</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (!mTraversalScheduled) &#123;<br>            mTraversalScheduled = <span class="hljs-literal">true</span>;<br>            <span class="hljs-comment">//添加同步屏障</span><br>            mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();<br>            mChoreographer.postCallback(<br>                    Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="hljs-literal">null</span>);<br>            <span class="hljs-keyword">if</span> (!mUnbufferedInputDispatch) &#123;<br>                scheduleConsumeBatchedInput();<br>            &#125;<br>            notifyRendererOfFramePending();<br>            pokeDrawLockIfNeeded();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">final</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TraversalRunnable</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span> &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>            doTraversal();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">TraversalRunnable</span> <span class="hljs-variable">mTraversalRunnable</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">TraversalRunnable</span>();<br><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">doTraversal</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (mTraversalScheduled) &#123;<br>            mTraversalScheduled = <span class="hljs-literal">false</span>;<br>            <span class="hljs-comment">//移除同步屏障</span><br>            mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);<br><br>            <span class="hljs-keyword">if</span> (mProfile) &#123;<br>                Debug.startMethodTracing(<span class="hljs-string">&quot;ViewAncestor&quot;</span>);<br>            &#125;<br>            <span class="hljs-comment">//这里开始View的绘制流程</span><br>            performTraversals();<br><br>            <span class="hljs-keyword">if</span> (mProfile) &#123;<br>                Debug.stopMethodTracing();<br>                mProfile = <span class="hljs-literal">false</span>;<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><code>ViewRootImpl.setView()</code>中最后调用到了<code>performTraversals()</code>在这个方法中开始View的绘制流程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performTraversals</span><span class="hljs-params">()</span> &#123;<br>  ...<br>   <span class="hljs-type">boolean</span> <span class="hljs-variable">layoutRequested</span> <span class="hljs-operator">=</span> mLayoutRequested &amp;&amp; (!mStopped || mReportNextDraw);<br>   <br>   ...<br>   <span class="hljs-keyword">if</span> (!mStopped || mReportNextDraw) &#123;<br>      <span class="hljs-type">int</span> <span class="hljs-variable">childHeightMeasureSpec</span> <span class="hljs-operator">=</span> getRootMeasureSpec(mHeight, lp.height);<br>	  <span class="hljs-type">int</span> <span class="hljs-variable">childHeightMeasureSpec</span> <span class="hljs-operator">=</span> getRootMeasureSpec(mHeight, lp.height);<br>      ...<br>        <span class="hljs-keyword">if</span>(layoutRequested)&#123;<br>          <span class="hljs-comment">//开始Measure过程，定义View的宽高</span><br>          performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);<br>          ...<br>        &#125;<br>   &#125;<br>  <br>    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">didLayout</span> <span class="hljs-operator">=</span> layoutRequested &amp;&amp; (!mStopped || mReportNextDraw);<br>    <span class="hljs-keyword">if</span>(didLayout)&#123;<br>        <span class="hljs-comment">//开始Layout过程，决定View的位置</span><br>        performLayout(lp, mWidth, mHeight);<br>        ...<br>    &#125;<br>    <br>     <span class="hljs-keyword">if</span> (!cancelDraw &amp;&amp; !newSurface) &#123;<br>            <span class="hljs-keyword">if</span> (mPendingTransitions != <span class="hljs-literal">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mPendingTransitions.size(); ++i) &#123;<br>                    mPendingTransitions.get(i).startChangingAnimations();<br>                &#125;<br>                mPendingTransitions.clear();<br>            &#125;<br>            <span class="hljs-comment">//开始Draw过程，决定了View的显示，这个过程结束才可以看到内容</span><br>            performDraw();<br>     &#125;<br>&#125;        <br></code></pre></td></tr></table></figure>

<p>通过以上流程分析：<strong>View的绘制流程是从<code>ViewRootImpl</code>中开始的，先调用<code>performTraversals()</code>开始绘制，随后调用内部的<code>performMeasure()</code>开始Measure过程，调用<code>performLayout()</code>，开始Layout过程，最后调用<code>performDraw()</code>开始Draw，完成后就可以现在在屏幕上。</strong></p>
<p><img src="/images/View%E7%BB%98%E5%88%B6%E6%B5%81%E7%A8%8B.png" srcset="/img/loading.gif" lazyload alt="View绘制流程"></p>
<p>如上图所示，<code>performTraversals()</code>依次调用<code>performMeasure()，performLayout(),performDraw()</code>完成View的绘制。</p>
<h2 id="View工作流程"><a href="#View工作流程" class="headerlink" title="View工作流程"></a>View工作流程</h2><blockquote>
<p>主要是指<code>measure(测量)</code>,<code>layout(布局)</code>,<code>draw(绘制)</code>三大流程。</p>
</blockquote>
<h3 id="measure-测量"><a href="#measure-测量" class="headerlink" title="measure-测量"></a>measure-测量</h3><blockquote>
<p>起点位于<code>performMeasure()</code>。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ViewRootImpl.java</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performMeasure</span><span class="hljs-params">(<span class="hljs-type">int</span> childWidthMeasureSpec, <span class="hljs-type">int</span> childHeightMeasureSpec)</span> &#123;<br>       ...<br>        <span class="hljs-keyword">try</span> &#123;<br>            mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            Trace.traceEnd(Trace.TRACE_TAG_VIEW);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>



<h4 id="MeasureSpec"><a href="#MeasureSpec" class="headerlink" title="MeasureSpec"></a>MeasureSpec</h4><p><img src="/images/measure-MeasureSpec.png" srcset="/img/loading.gif" lazyload alt="measure-MeasureSpec"></p>
<blockquote>
<p>MeasureSpec代表一个32位int值，高2位代表SpecMode(测量模式)，低30位代表SpecSize(某种测量模式下的规格大小)。</p>
</blockquote>
<p>作用：父控件提供给子View的一个参数，作为设定自身大小参考，实际大小还是有子View自身决定。</p>
<p><img src="/images/MeasureSpec%E7%BB%93%E6%9E%84" srcset="/img/loading.gif" lazyload alt="MeasureSpec结构"></p>
<h5 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MeasureSpec</span> &#123;<br>       <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MODE_SHIFT</span> <span class="hljs-operator">=</span> <span class="hljs-number">30</span>;<br>       <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">MODE_MASK</span>  <span class="hljs-operator">=</span> <span class="hljs-number">0x3</span> &lt;&lt; MODE_SHIFT;<br><br>       <span class="hljs-comment">/** <span class="hljs-doctag">@hide</span> */</span><br>       <span class="hljs-meta">@IntDef(&#123;UNSPECIFIED, EXACTLY, AT_MOST&#125;)</span><br>       <span class="hljs-meta">@Retention(RetentionPolicy.SOURCE)</span><br>       <span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> MeasureSpecMode &#123;&#125;<br>    <br>     <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">UNSPECIFIED</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span> &lt;&lt; MODE_SHIFT;<br>     <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">EXACTLY</span>     <span class="hljs-operator">=</span> <span class="hljs-number">1</span> &lt;&lt; MODE_SHIFT;<br>     <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">AT_MOST</span>     <span class="hljs-operator">=</span> <span class="hljs-number">2</span> &lt;&lt; MODE_SHIFT;<br><br>     <span class="hljs-meta">@MeasureSpecMode</span><br>      <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getMode</span><span class="hljs-params">(<span class="hljs-type">int</span> measureSpec)</span> &#123;<br>           <span class="hljs-comment">//noinspection ResourceType</span><br>           <span class="hljs-keyword">return</span> (measureSpec &amp; MODE_MASK);<br>       &#125;<br>         <br>      <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getSize</span><span class="hljs-params">(<span class="hljs-type">int</span> measureSpec)</span> &#123;<br>           <span class="hljs-keyword">return</span> (measureSpec &amp; ~MODE_MASK);<br>       &#125;<br></code></pre></td></tr></table></figure>

<p><code>SpecMode</code>分为三类：</p>
<ul>
<li><code>UNSPECIFIED</code>：<strong>未指定模式</strong>。父控件不对子控件添加束缚，子元素可以为任意大小，一般用于系统内部的测量。比如<code>ScrollView</code></li>
<li><code>EXACTLY</code>：<strong>精确模式</strong>。父控件为子View指定精确大小，希望子View完全按照自己给的尺寸处理大小。一般是设置了<code>明确的值</code>或是<code>MATCH_PARENT</code></li>
<li><code>AT_MOST</code>：<strong>最大模式</strong>。父控件为子View指定最大尺寸，希望子View不要超过这个尺寸。一般对应<code>WRAP_CONTENT</code></li>
</ul>
<h5 id="MeasureSpec与LayoutParams的关系"><a href="#MeasureSpec与LayoutParams的关系" class="headerlink" title="MeasureSpec与LayoutParams的关系"></a>MeasureSpec与LayoutParams的关系</h5><p>每一个View，都持有一个MeasureSpec，里面保存了View的尺寸。我们也可以使用<code>LayoutParams</code>指定View的尺寸。所以在View测量的时候，系统会将<code>LayoutParams</code>在父容器的约束下转换成<code>MeasureSpec</code>，然后根据转换后的值确定宽高。</p>
<p><strong>转换后的MeasureSpec是由LayoutParams和父容器的MeasureSpec一起决定的。</strong></p>
<table>
<thead>
<tr>
<th>下：childLayoutParams 右：parentSpecMode</th>
<th>EXACTLY</th>
<th>AT_MOST</th>
<th>UNSPECIFIED</th>
</tr>
</thead>
<tbody><tr>
<td>固定大小</td>
<td>Exactly<br>childSize</td>
<td>Exactly<br/>childSize</td>
<td>Exactly<br/>childSize</td>
</tr>
<tr>
<td>match_parent</td>
<td>Exactly<br/>parentSize(父容器剩余空间)</td>
<td>AT_MOST<br/>parentSize(最大父容器剩余空间)</td>
<td>UNSPECIFIED<br>0 或 parentSize(最大父容器剩余空间)</td>
</tr>
<tr>
<td>wrap_content</td>
<td>AT_MOST<br/>parentSize(最大父容器剩余空间)</td>
<td>AT_MOST<br/>parentSize(最大父容器剩余空间)</td>
<td>UNSPECIFIED<br/>0 或 parentSize(最大父容器剩余空间)</td>
</tr>
</tbody></table>
<p>根据<code>ViewGroup.getChildMeasureSpec()</code>得出上表。</p>
<h6 id="DecorView转换MeasureSpec"><a href="#DecorView转换MeasureSpec" class="headerlink" title="DecorView转换MeasureSpec"></a>DecorView转换MeasureSpec</h6><blockquote>
<p>DecorView的转换由Window的尺寸和自身的LayoutParams决定。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ../android/view/ViewRootImpl.java</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performTraversals</span><span class="hljs-params">()</span> &#123;<br>    ...<br>       <span class="hljs-comment">//DecorView Measure过程</span><br>       <span class="hljs-type">int</span> <span class="hljs-variable">childWidthMeasureSpec</span> <span class="hljs-operator">=</span> getRootMeasureSpec(mWidth, lp.width);<br>       <span class="hljs-type">int</span> <span class="hljs-variable">childHeightMeasureSpec</span> <span class="hljs-operator">=</span> getRootMeasureSpec(mHeight, lp.height);<br>       performMeasure(childWidthMeasureSpec,childHeightMeasureSpec)<br>    ...  <br>&#125;<br><br><span class="hljs-comment">//在方法中生成了DecorView的MeasureSpec 根据Window的尺寸和自身的LayoutParams</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getRootMeasureSpec</span><span class="hljs-params">(<span class="hljs-type">int</span> windowSize<span class="hljs-comment">/*Window尺寸*/</span>, <span class="hljs-type">int</span> rootDimension)</span> &#123;<br>        <span class="hljs-type">int</span> measureSpec;<br>        <span class="hljs-keyword">switch</span> (rootDimension) &#123;<br>       <br>        <span class="hljs-keyword">case</span> ViewGroup.LayoutParams.MATCH_PARENT:<br>            <span class="hljs-comment">//MeasureSpec中的specSize就是窗口尺寸,specMode为EXACTLY 精确模式</span><br>            measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.EXACTLY);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> ViewGroup.LayoutParams.WRAP_CONTENT:<br>            <span class="hljs-comment">//MeasureSpec中的specSize为窗口尺寸,specMode为AT_MOST 最大模式，最大值为窗口尺寸</span><br>            measureSpec = MeasureSpec.makeMeasureSpec(windowSize, MeasureSpec.AT_MOST);<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">default</span>:<br>            <span class="hljs-comment">//MeasureSpec中的specSize为固定尺寸,specMode为EXACTLY 精确模式</span><br>            measureSpec = MeasureSpec.makeMeasureSpec(rootDimension, MeasureSpec.EXACTLY);<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> measureSpec;<br>    &#125;<br><br></code></pre></td></tr></table></figure>



<h4 id="View的measure过程"><a href="#View的measure过程" class="headerlink" title="View的measure过程"></a>View的measure过程</h4><p><img src="/images/measure-View%E7%9A%84measure%E8%BF%87%E7%A8%8B.png" srcset="/img/loading.gif" lazyload alt="measure-View的measure过程"></p>
<p>主要是由<code>measure()</code>方法完成</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ../android/view/View.java</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">measure</span><span class="hljs-params">(<span class="hljs-type">int</span> widthMeasureSpec, <span class="hljs-type">int</span> heightMeasureSpec)</span> &#123;<br>      ...<br>        <span class="hljs-comment">//需要执行onMeasure</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">forceLayout</span> <span class="hljs-operator">=</span> (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT;<br>        <span class="hljs-comment">// 布局发生变化</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">needsLayout</span> <span class="hljs-operator">=</span> specChanged<br>                &amp;&amp; (sAlwaysRemeasureExactly || !isSpecExactly || !matchesSpecSize);      <br>      ...<br>        <span class="hljs-keyword">if</span> (forceLayout<span class="hljs-comment">/*强制测量*/</span> || needsLayout<span class="hljs-comment">/*需要测量*/</span>) &#123;<br>          ...<br>          <span class="hljs-type">int</span> <span class="hljs-variable">cacheIndex</span> <span class="hljs-operator">=</span> forceLayout ? -<span class="hljs-number">1</span> : mMeasureCache.indexOfKey(key);<br>          <span class="hljs-comment">//需要强制测量布局 或者。缓存无效</span><br>            <span class="hljs-keyword">if</span> (cacheIndex &lt; <span class="hljs-number">0</span> || sIgnoreMeasureCache) &#123;<br>                <span class="hljs-comment">// measure ourselves, this should set the measured dimension flag back</span><br>                onMeasure(widthMeasureSpec, heightMeasureSpec);<br>                mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-type">long</span> <span class="hljs-variable">value</span> <span class="hljs-operator">=</span> mMeasureCache.valueAt(cacheIndex);<br>                <span class="hljs-comment">// Casting a long to int drops the high 32 bits, no mask needed</span><br>                setMeasuredDimensionRaw((<span class="hljs-type">int</span>) (value &gt;&gt; <span class="hljs-number">32</span>), (<span class="hljs-type">int</span>) value);<br>              <span class="hljs-comment">//需要在layout 再次执行 onMeasure</span><br>                mPrivateFlags3 |= PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;<br>            &#125;<br>          ...<br>            <span class="hljs-comment">//添加 PFLAG_LAYOUT_REQUIRED标记，表示需要执行 layout流程</span><br>             mPrivateFlags |= PFLAG_LAYOUT_REQUIRED;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>在<code>measure()</code>中调用<code>onMeasure()</code>去进行实际的测量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//../android/view/View.java</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMeasure</span><span class="hljs-params">(<span class="hljs-type">int</span> widthMeasureSpec, <span class="hljs-type">int</span> heightMeasureSpec)</span> &#123;<br>        setMeasuredDimension(<br>            getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),<br>            getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));<br>    &#125;<br><br>   <span class="hljs-comment">//设置View的宽高</span><br>   <span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMeasuredDimension</span><span class="hljs-params">(<span class="hljs-type">int</span> measuredWidth, <span class="hljs-type">int</span> measuredHeight)</span> &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">optical</span> <span class="hljs-operator">=</span> isLayoutModeOptical(<span class="hljs-built_in">this</span>);<br>        <span class="hljs-keyword">if</span> (optical != isLayoutModeOptical(mParent)) &#123;<br>            <span class="hljs-type">Insets</span> <span class="hljs-variable">insets</span> <span class="hljs-operator">=</span> getOpticalInsets();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">opticalWidth</span>  <span class="hljs-operator">=</span> insets.left + insets.right;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">opticalHeight</span> <span class="hljs-operator">=</span> insets.top  + insets.bottom;<br><br>            measuredWidth  += optical ? opticalWidth  : -opticalWidth;<br>            measuredHeight += optical ? opticalHeight : -opticalHeight;<br>        &#125;<br>        setMeasuredDimensionRaw(measuredWidth, measuredHeight);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMeasuredDimensionRaw</span><span class="hljs-params">(<span class="hljs-type">int</span> measuredWidth, <span class="hljs-type">int</span> measuredHeight)</span> &#123;<br>        mMeasuredWidth = measuredWidth;<br>        mMeasuredHeight = measuredHeight;<br>        mPrivateFlags |= PFLAG_MEASURED_DIMENSION_SET;<br>    &#125;<br><br>    <span class="hljs-comment">//返回View的MeasureSpec中的specSize</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getDefaultSize</span><span class="hljs-params">(<span class="hljs-type">int</span> size, <span class="hljs-type">int</span> measureSpec)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> size;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">specMode</span> <span class="hljs-operator">=</span> MeasureSpec.getMode(measureSpec);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">specSize</span> <span class="hljs-operator">=</span> MeasureSpec.getSize(measureSpec);<br><br>        <span class="hljs-keyword">switch</span> (specMode) &#123;<br>        <span class="hljs-keyword">case</span> MeasureSpec.UNSPECIFIED:<br>            result = size;<br>            <span class="hljs-keyword">break</span>;<br>        <span class="hljs-keyword">case</span> MeasureSpec.AT_MOST:<span class="hljs-comment">//wrap_content</span><br>        <span class="hljs-keyword">case</span> MeasureSpec.EXACTLY:<span class="hljs-comment">//match_parent / XX </span><br>        <span class="hljs-comment">//这段代码中可以分析得出 一个直接继承View的自定义View 定义为wrap_content和match_parent大小都是一致的.</span><br>            result = specSize;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getSuggestedMinimumHeight</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> (mBackground == <span class="hljs-literal">null</span>) ? mMinHeight : max(mMinHeight, mBackground.getMinimumHeight());<br>    &#125;<br><br><span class="hljs-comment">//如果View没有设置背景，返回minWidth值，默认为0。若设置了背景就取背景宽度和最小宽度中的最大值返回。</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getSuggestedMinimumWidth</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> (mBackground == <span class="hljs-literal">null</span>) ? mMinWidth : max(mMinWidth, mBackground.getMinimumWidth());<br>    &#125;<br><br>    <br><span class="hljs-comment">// ../android/graphics/drawable/Drawable.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getMinimumWidth</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">intrinsicWidth</span> <span class="hljs-operator">=</span> getIntrinsicWidth();<br>    <span class="hljs-keyword">return</span> intrinsicWidth &gt; <span class="hljs-number">0</span> ? intrinsicWidth : <span class="hljs-number">0</span>;<br>&#125;<br><br><br></code></pre></td></tr></table></figure>



<p><img src="/images/View-Measure.png" srcset="/img/loading.gif" lazyload alt="View-Measure"></p>
<p>结合上述流程图，简单分析View的Measure过程</p>
<ul>
<li>系统在绘制开始时会调用<code>View.measure()</code>，这个方法是final的，无法被重写</li>
<li>后续调用<code>View.onMeasure()</code>,自定义View时可以按照自己的需求对这个方法进行重写</li>
<li><code>onMeasure()</code>中调用到<code>setMeasuredDimension()</code>对View进行宽高的设置</li>
<li>需要使用<code>getDefaultSize()</code>去获取最终显示出的宽高</li>
<li>在<code>getDefaultSize()</code>中需要对传进来的<code>MeasureSpec</code>进行分析处理<ul>
<li>SpecMode若为<code>UNSPECIFIED</code>，则最终尺寸为传进来的<code>SpecSize</code></li>
<li>SpecMode为<code>AT_MOST</code>,<code>EXACTLY</code>，还需要额外判断View是否有背景<ul>
<li>有背景，最终尺寸就为View的最小尺寸和背景尺寸的最大值</li>
<li>没背景，最终尺寸就为View的最小尺寸</li>
</ul>
</li>
</ul>
</li>
<li>取到最终尺寸后，数据回溯到<code>onMeasure()</code>中，即完成测量(<code>Measure</code>)过程</li>
</ul>
<p>在上述分析中，自定义View中使用<code>wrap_content</code>时，specMode为<code>AT_MOST</code>，尺寸为父控件剩余大小，效果与使用<code>match_parent</code>一致。这也是自定义View中常碰到的问题 <em>为何自定义View是wrap_content无效？</em> 解决方法就是 自己重写<code>onMeasure()</code>对<code>wrap_content</code>特殊处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMeasure</span><span class="hljs-params">(<span class="hljs-type">int</span> widthMeasureSpec,<span class="hljs-type">int</span> heightMeasureSpec)</span>&#123;<br>    <span class="hljs-built_in">super</span>.onMeasure(widthMeasureSpec,heightMeasureSpec);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">widthSpecMode</span> <span class="hljs-operator">=</span> MeasureSpec.getMode(widthMeasureSpec);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">heightSpecMode</span> <span class="hljs-operator">=</span> MeasureSpec.getMode(heightMeasureSpec);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">widthSpecSize</span> <span class="hljs-operator">=</span> MeasureSpec.getSize(widthMeasureSpec);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">heightSpecSize</span> <span class="hljs-operator">=</span> MeasureSpec.getSize(heightMeasureSpec);<br>    <br>    <span class="hljs-keyword">if</span>(widthSpecMode == MeasureSpec.AT_MOST &amp;&amp; heightSpecMode == MeasureSpec.AT_MOST)&#123;<br>        setMeasuredDimension(mWidth,mHeight);<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(widthSpecMode == MeasureSpec.AT_MOST)&#123;<br>        setMeasuredDimension(mWidth,heightSpecSize);<br>    &#125;<span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(heightSpecMode == MeasureSpec.AT_MOST)&#123;<br>        setMeasuredDimension(widthSpecSize,mHeight);<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="ViewGroup的measure过程"><a href="#ViewGroup的measure过程" class="headerlink" title="ViewGroup的measure过程"></a>ViewGroup的measure过程</h4><p><img src="/images/measure-ViewGroup%E7%9A%84measure%E8%BF%87%E7%A8%8B.png" srcset="/img/loading.gif" lazyload alt="measure-ViewGroup的measure过程"></p>
<blockquote>
<p>除了完成自身的measure过程之外，还要去遍历调用所有子元素的measure方法，各个子元素再去递归执行这个过程。</p>
<p><strong>先Measure子View，再Measure自己</strong></p>
</blockquote>
<p>ViewGroup中没有定义<code>onMeasure()</code>，定义了一个<code>measureChildren()</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ../android/view/ViewGroup.java</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">measureChildren</span><span class="hljs-params">(<span class="hljs-type">int</span> widthMeasureSpec, <span class="hljs-type">int</span> heightMeasureSpec)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> mChildrenCount;<br>        <span class="hljs-keyword">final</span> View[] children = mChildren;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; size; ++i) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> children[i];<br>            <span class="hljs-keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) != GONE) &#123;<br>                <span class="hljs-comment">//遍历对每一个子元素进行测量过程</span><br>                measureChild(child, widthMeasureSpec, heightMeasureSpec);<br>            &#125;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>循环调用<code>measureChild()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ../android/view/ViewGroup.java</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">measureChild</span><span class="hljs-params">(View child, <span class="hljs-type">int</span> parentWidthMeasureSpec,</span><br><span class="hljs-params">            <span class="hljs-type">int</span> parentHeightMeasureSpec)</span> &#123;<br>        <span class="hljs-comment">//获得子View的LayoutParams</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">LayoutParams</span> <span class="hljs-variable">lp</span> <span class="hljs-operator">=</span> child.getLayoutParams();<br>        <span class="hljs-comment">//</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">childWidthMeasureSpec</span> <span class="hljs-operator">=</span> getChildMeasureSpec(parentWidthMeasureSpec,<br>                mPaddingLeft + mPaddingRight, lp.width);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">childHeightMeasureSpec</span> <span class="hljs-operator">=</span> getChildMeasureSpec(parentHeightMeasureSpec,<br>                mPaddingTop + mPaddingBottom, lp.height);<br><br>        child.measure(childWidthMeasureSpec, childHeightMeasureSpec);<br>    &#125;<br><br> <span class="hljs-comment">//子View的MeasureSpec由父View的MeasureSpec以及自身的LayoutParams共同决定</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getChildMeasureSpec</span><span class="hljs-params">(<span class="hljs-type">int</span> spec, <span class="hljs-type">int</span> padding, <span class="hljs-type">int</span> childDimension)</span> &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">specMode</span> <span class="hljs-operator">=</span> MeasureSpec.getMode(spec);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">specSize</span> <span class="hljs-operator">=</span> MeasureSpec.getSize(spec);<br><br>        <span class="hljs-comment">//padding代指父View已占用的空间，子View无法使用，所以子View的空间需要减去padding部分</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">size</span> <span class="hljs-operator">=</span> Math.max(<span class="hljs-number">0</span>, specSize - padding);<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">resultSize</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">resultMode</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br><br>        <span class="hljs-keyword">switch</span> (specMode) &#123;<br>        <span class="hljs-comment">// Parent has imposed an exact size on us</span><br>        <span class="hljs-keyword">case</span> MeasureSpec.EXACTLY:<br>            <span class="hljs-keyword">if</span> (childDimension &gt;= <span class="hljs-number">0</span>) &#123;<br>                resultSize = childDimension;<br>                resultMode = MeasureSpec.EXACTLY;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;<br>                <span class="hljs-comment">// Child wants to be our size. So be it.</span><br>                resultSize = size;<br>                resultMode = MeasureSpec.EXACTLY;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;<br>                <span class="hljs-comment">// Child wants to determine its own size. It can&#x27;t be</span><br>                <span class="hljs-comment">// bigger than us.</span><br>                resultSize = size;<br>                resultMode = MeasureSpec.AT_MOST;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-comment">// Parent has imposed a maximum size on us</span><br>        <span class="hljs-keyword">case</span> MeasureSpec.AT_MOST:<br>            <span class="hljs-keyword">if</span> (childDimension &gt;= <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// Child wants a specific size... so be it</span><br>                resultSize = childDimension;<br>                resultMode = MeasureSpec.EXACTLY;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;<br>                <span class="hljs-comment">// Child wants to be our size, but our size is not fixed.</span><br>                <span class="hljs-comment">// Constrain child to not be bigger than us.</span><br>                resultSize = size;<br>                resultMode = MeasureSpec.AT_MOST;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;<br>                <span class="hljs-comment">// Child wants to determine its own size. It can&#x27;t be</span><br>                <span class="hljs-comment">// bigger than us.</span><br>                resultSize = size;<br>                resultMode = MeasureSpec.AT_MOST;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br><br>        <span class="hljs-comment">// Parent asked to see how big we want to be</span><br>        <span class="hljs-keyword">case</span> MeasureSpec.UNSPECIFIED:<br>            <span class="hljs-keyword">if</span> (childDimension &gt;= <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-comment">// Child wants a specific size... let him have it</span><br>                resultSize = childDimension;<br>                resultMode = MeasureSpec.EXACTLY;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (childDimension == LayoutParams.MATCH_PARENT) &#123;<br>                <span class="hljs-comment">// Child wants to be our size... find out how big it should</span><br>                <span class="hljs-comment">// be</span><br>                resultSize = View.sUseZeroUnspecifiedMeasureSpec ? <span class="hljs-number">0</span> : size;<br>                resultMode = MeasureSpec.UNSPECIFIED;<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (childDimension == LayoutParams.WRAP_CONTENT) &#123;<br>                <span class="hljs-comment">// Child wants to determine its own size.... find out how</span><br>                <span class="hljs-comment">// big it should be</span><br>                resultSize = View.sUseZeroUnspecifiedMeasureSpec ? <span class="hljs-number">0</span> : size;<br>                resultMode = MeasureSpec.UNSPECIFIED;<br>            &#125;<br>            <span class="hljs-keyword">break</span>;<br>        &#125;<br>        <span class="hljs-comment">//noinspection ResourceType</span><br>        <span class="hljs-keyword">return</span> MeasureSpec.makeMeasureSpec(resultSize, resultMode);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>由于ViewGroup有不同布局的需要，很难统一，所以没有提供统一的<code>onMeasure()</code>方法，而是让子类自己去实现<code>onMeasure()</code>。</p>
<p><img src="/images/ViewGroup-Measure.png" srcset="/img/loading.gif" lazyload alt="ViewGroup-Measure"></p>
<p>根据上述流程图，简单总结一下：</p>
<ul>
<li>ViewGroup调用自身的<code>measureChildren()</code>，里面遍历自己的子View</li>
<li>遍历后调用<code>measureChild()</code>，准备给每一个子View计算它的<code>MeasureSpec</code></li>
<li>调用<code>getChildMeasureSpec()</code>计算子View的<code>MeasureSpec</code>，需要结合父布局的<code>MeasureSpec</code>以及子View的<code>LayoutParams</code>共同得出结果</li>
<li>调用子View的<code>measure()</code>，完成子View的测量过程。</li>
<li>合并子View的测量值，得到ViewGroup的测量值</li>
</ul>
<h4 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h4><ol>
<li><p>在Activity启动时获取View的尺寸？</p>
<ul>
<li>在 Activity#onWindowFocusChanged 回调中获取宽高。<br><code>当Activity得到焦点或失去焦点的时候，这个方法都会被频繁调用</code></li>
<li>view.post(runnable)，在 runnable 中获取宽高。<br><code>利用Handler通信机制，发送一个Runnable在MessageQueue中，当layout处理结束时会发送消息通知UI线程，可以获取到实际宽高。</code></li>
<li>ViewTreeObserver 添加 OnGlobalLayoutListener，在 onGlobalLayout 回调中获取宽高。<br><code>监听全局View的变化事件，使用后需要注意移除OnGlobalLayoutListener 监听，以免造成内存泄露</code></li>
<li>调用 view.measure()，再通过 getMeasuredWidth 和 getMeasuredHeight 获取宽高<br><code>手动对view进行measure来得到View的尺寸。</code></li>
</ul>
</li>
<li><p>不同ViewGroup实现的<code>getChildMeasureSpec()</code>可能导致不同结果</p>
<blockquote>
<p>每种ViewGroup的子类测量策略(<code>getChildMeasureSpec()</code>)不尽相同，就会导致显示结果不一致。</p>
</blockquote>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">FrameLayout</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;300dp&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:background</span>=<span class="hljs-string">&quot;@color/colorAccent&quot;</span>&gt;</span><br>   <br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;400dp&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">FrameLayout</span>&gt;</span><br>   <br><span class="hljs-tag">&lt;<span class="hljs-name">RelativeLayout</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">    <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;300dp&quot;</span>&gt;</span><br>   <br>    <span class="hljs-tag">&lt;<span class="hljs-name">Button</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_width</span>=<span class="hljs-string">&quot;match_parent&quot;</span></span><br><span class="hljs-tag">        <span class="hljs-attr">android:layout_height</span>=<span class="hljs-string">&quot;400dp&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">RelativeLayout</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在<code>FrameLayout</code>和<code>RelativeLayout</code>中，<code>Button</code>显示效果不一致，</p>
<ul>
<li><code>FrameLayout</code>中<code>Button</code>高度为<code>400dp</code></li>
<li><code>RelativeLayout</code>中<code>Button</code>高度为<code>300dp</code></li>
</ul>
<p><code>FrameLayout</code>遵循默认的<code>ViewGroup.getChildMeasureSpec()</code>，<code>RelativeLayout</code>重写<code>getChildMeasureSpec()</code>。</p>
</li>
</ol>
<h3 id="layout-布局"><a href="#layout-布局" class="headerlink" title="layout-布局"></a>layout-布局</h3><blockquote>
<p>ViewGroup用来确定子元素的位置，当ViewGroup位置被确定后，在<code>onLayout()</code>中遍历所有子View，并调用其<code>layout()</code>。</p>
<p><strong>先layout自身后layout子元素。</strong></p>
<p>起点位于<code>performLayout()</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performLayout</span><span class="hljs-params">(WindowManager.LayoutParams lp, <span class="hljs-type">int</span> desiredWindowWidth,</span><br><span class="hljs-params">        <span class="hljs-type">int</span> desiredWindowHeight)</span> &#123;<br>   <span class="hljs-comment">//正在执行layout流程</span><br>   mInLayout = <span class="hljs-literal">true</span>;<br><br>   <span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> mView;<span class="hljs-comment">//对应DecorView</span><br>  <span class="hljs-comment">//执行DecorView的layout过程</span><br>  host.layout(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());<br>   <span class="hljs-comment">//在layout过程中 尚未执行requestLayout的view</span><br>   <span class="hljs-type">int</span> <span class="hljs-variable">numViewsRequestingLayout</span> <span class="hljs-operator">=</span> mLayoutRequesters.size();<br>   <span class="hljs-keyword">if</span> (numViewsRequestingLayout &gt; <span class="hljs-number">0</span>) &#123;<br>      <span class="hljs-comment">//寻找mPrivateFlags为PFLAG_FORCE_LAYOUT的View</span><br>       ArrayList&lt;View&gt; validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters,<br>                    <span class="hljs-literal">false</span>);<br>            <span class="hljs-keyword">if</span> (validLayoutRequesters != <span class="hljs-literal">null</span>) &#123;<br>              <span class="hljs-comment">//当前View重新measure</span><br>                 measureHierarchy(host, lp, mView.getContext().getResources(),<br>                        desiredWindowWidth, desiredWindowHeight);     <br>              <span class="hljs-comment">//重新执行layout</span><br>                 host.layout(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());  <br>              ...<br>                <span class="hljs-comment">//寻找尚未设置 PFLAG_FORCE_LAYOUT的View</span><br>                 validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters, <span class="hljs-literal">true</span>);                   <br>                 <span class="hljs-keyword">if</span> (validLayoutRequesters != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">final</span> ArrayList&lt;View&gt; finalRequesters = validLayoutRequesters;<br>                    <span class="hljs-comment">// 执行requestLayout在下一帧执行时</span><br>                    getRunQueue().post(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>                        <span class="hljs-meta">@Override</span><br>                        <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                            <span class="hljs-type">int</span> <span class="hljs-variable">numValidRequests</span> <span class="hljs-operator">=</span> finalRequesters.size();<br>                            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; numValidRequests; ++i) &#123;<br>                                <span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> finalRequesters.get(i);<br>                                Log.w(<span class="hljs-string">&quot;View&quot;</span>, <span class="hljs-string">&quot;requestLayout() improperly called by &quot;</span> + view +<br>                                        <span class="hljs-string">&quot; during second layout pass: posting in next frame&quot;</span>);<br>                                view.requestLayout();<br>                            &#125;<br>                        &#125;<br>                    &#125;);<br>                &#125;                 <br>            &#125;<br>   &#125;<br>  <br>&#125;<br></code></pre></td></tr></table></figure>

<p>主要执行了三步：</p>
<ul>
<li>执行<code>DecorView</code>的<code>layout</code>过程</li>
<li>执行调用过<code>requestLayout()</code>的View(包含<code>PFLAG_FORCE_LAYOUT</code>标志)的<code>measure</code>和<code>layout</code></li>
<li>还没调用过<code>requestLayout()</code>的View加入到队列中，等待下一帧绘制时执行</li>
</ul>
<h4 id="View的layout过程"><a href="#View的layout过程" class="headerlink" title="View的layout过程"></a>View的layout过程</h4><p><img src="/images/layout-View%E7%9A%84layout%E8%BF%87%E7%A8%8B.png" srcset="/img/loading.gif" lazyload alt="layout-View的layout过程"></p>
<p>主要是由View的<code>layout()</code>方法实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ../android/view/View.java   </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">layout</span><span class="hljs-params">(<span class="hljs-type">int</span> l, <span class="hljs-type">int</span> t, <span class="hljs-type">int</span> r, <span class="hljs-type">int</span> b)</span> &#123;<br>        <span class="hljs-keyword">if</span> ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-comment">//需要再次测量 可能缓存无效</span><br>            onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec);<br>            mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;<br>        &#125;<br>        <br>        <span class="hljs-comment">//左上角顶点距父容器左边的距离</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">oldL</span> <span class="hljs-operator">=</span> mLeft;<br>        <span class="hljs-comment">//左上角顶点距父容器上边的距离</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">oldT</span> <span class="hljs-operator">=</span> mTop;<br>        <span class="hljs-comment">//右下角顶点距父容器上边的距离</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">oldB</span> <span class="hljs-operator">=</span> mBottom;<br>        <span class="hljs-comment">//右下角顶点距父容器上边的距离</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">oldR</span> <span class="hljs-operator">=</span> mRight;<br>        <span class="hljs-comment">//判断本次布局流程是否发生了布局的变化</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">changed</span> <span class="hljs-operator">=</span> isLayoutModeOptical(mParent) ?<br>                setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);<br><br>        <span class="hljs-keyword">if</span> (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) &#123;<br>          <span class="hljs-comment">//通知View进行布局过程</span><br>            onLayout(changed, l, t, r, b);<br>            ...<br>              <span class="hljs-comment">//通知View布局发生变化</span><br>            listenersCopy.get(i).onLayoutChange(<span class="hljs-built_in">this</span>, l, t, r, b, oldL, oldT, oldR, oldB);              <br>        &#125;<br>        ...<br>    &#125;<br><br><span class="hljs-comment">//由于子View下是没有子类了，所以该方法内不没有任何代码实现 一般自定义View是不需要重写该方法的</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLayout</span><span class="hljs-params">(<span class="hljs-type">boolean</span> changed, <span class="hljs-type">int</span> left, <span class="hljs-type">int</span> top, <span class="hljs-type">int</span> right, <span class="hljs-type">int</span> bottom)</span> &#123;<br>    <br>    &#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setOpticalFrame</span><span class="hljs-params">(<span class="hljs-type">int</span> left, <span class="hljs-type">int</span> top, <span class="hljs-type">int</span> right, <span class="hljs-type">int</span> bottom)</span> &#123;<br>        <span class="hljs-type">Insets</span> <span class="hljs-variable">parentInsets</span> <span class="hljs-operator">=</span> mParent <span class="hljs-keyword">instanceof</span> View ?<br>                ((View) mParent).getOpticalInsets() : Insets.NONE;<br>        <span class="hljs-type">Insets</span> <span class="hljs-variable">childInsets</span> <span class="hljs-operator">=</span> getOpticalInsets();<br>        <span class="hljs-comment">//根据特效边框重新计算四个顶点的位置，然后调用setFrame重新计算</span><br>        <span class="hljs-keyword">return</span> setFrame(<br>                left   + parentInsets.left - childInsets.left,<br>                top    + parentInsets.top  - childInsets.top,<br>                right  + parentInsets.left + childInsets.right,<br>                bottom + parentInsets.top  + childInsets.bottom);<br>    &#125;<br><br><span class="hljs-comment">//保存本次布局信息</span><br><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setFrame</span><span class="hljs-params">(<span class="hljs-type">int</span> left, <span class="hljs-type">int</span> top, <span class="hljs-type">int</span> right, <span class="hljs-type">int</span> bottom)</span> &#123;<br>             <span class="hljs-type">boolean</span> <span class="hljs-variable">changed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br><br>        <span class="hljs-keyword">if</span> (mLeft != left || mRight != right || mTop != top || mBottom != bottom) &#123;<br>            changed = <span class="hljs-literal">true</span>;<br><br>            <span class="hljs-comment">// Remember our drawn bit</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">drawn</span> <span class="hljs-operator">=</span> mPrivateFlags &amp; PFLAG_DRAWN;<br><br>            <span class="hljs-type">int</span> <span class="hljs-variable">oldWidth</span> <span class="hljs-operator">=</span> mRight - mLeft;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">oldHeight</span> <span class="hljs-operator">=</span> mBottom - mTop;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">newWidth</span> <span class="hljs-operator">=</span> right - left;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">newHeight</span> <span class="hljs-operator">=</span> bottom - top;<br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">sizeChanged</span> <span class="hljs-operator">=</span> (newWidth != oldWidth) || (newHeight != oldHeight);<br><br>            <span class="hljs-comment">// 布局发生变化 需要执行重绘流程</span><br>            invalidate(sizeChanged);<br>            <span class="hljs-comment">//重新计算View的四个顶点距父布局左上边框的距离</span><br>            mLeft = left;<br>            mTop = top;<br>            mRight = right;<br>            mBottom = bottom;<br>            mRenderNode.setLeftTopRightBottom(mLeft, mTop, mRight, mBottom);<br>            ...<br>        &#125;<br>&#125;<br><br><br><span class="hljs-comment">//判断当前View是否存在阴影或者外发光等边框效果</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isLayoutModeOptical</span><span class="hljs-params">(Object o)</span> &#123;<br>        <span class="hljs-keyword">return</span> o <span class="hljs-keyword">instanceof</span> ViewGroup &amp;&amp; ((ViewGroup) o).isLayoutModeOptical();<br>    &#125;<br></code></pre></td></tr></table></figure>



<p><img src="/images/View-Layout.png" srcset="/img/loading.gif" lazyload alt="View-Layout"></p>
<p>按照流程图总结一下：</p>
<ul>
<li>View调用<code>layout()</code>开始布局过程(<code>确定最终宽高以及四个顶点的位置</code>)</li>
<li>根据是否有边缘效果(<code>例如发光，阴影</code>)<ul>
<li>有边缘效果，调用<code>setOpticalFrame()</code>去除边缘的影响，最终还是调用<code>setFrame()</code>设立自己的四个顶点</li>
<li>无边缘效果，调用<code>setFrame()</code>设立自己的四个顶点</li>
</ul>
</li>
<li>最后调用<code>onLayout()</code>最终确立宽高以及四点坐标。</li>
</ul>
<h4 id="ViewGroup的layout过程"><a href="#ViewGroup的layout过程" class="headerlink" title="ViewGroup的layout过程"></a>ViewGroup的layout过程</h4><p><img src="/images/layout-ViewGroup%E7%9A%84layout%E8%BF%87%E7%A8%8B.png" srcset="/img/loading.gif" lazyload alt="layout-ViewGroup的layout过程"></p>
<p>当有子View存在的时候，需要遍历子View进行<code>layout</code>过程。即需要在<code>onLayout()</code>方法实现子View的<code>layout</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ViewGroup.java</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">layout</span><span class="hljs-params">(<span class="hljs-type">int</span> l, <span class="hljs-type">int</span> t, <span class="hljs-type">int</span> r, <span class="hljs-type">int</span> b)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!mSuppressLayout &amp;&amp; (mTransition == <span class="hljs-literal">null</span> || !mTransition.isChangingLayout())) &#123;<br>            <span class="hljs-keyword">if</span> (mTransition != <span class="hljs-literal">null</span>) &#123;<br>                mTransition.layoutChange(<span class="hljs-built_in">this</span>);<br>            &#125;<br>          <span class="hljs-comment">//调用View.layout()</span><br>            <span class="hljs-built_in">super</span>.layout(l, t, r, b);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// record the fact that we noop&#x27;d it; request layout when transition finishes</span><br>            mLayoutCalledWhileSuppressed = <span class="hljs-literal">true</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLayout</span><span class="hljs-params">(<span class="hljs-type">boolean</span> changed,</span><br><span class="hljs-params">            <span class="hljs-type">int</span> l, <span class="hljs-type">int</span> t, <span class="hljs-type">int</span> r, <span class="hljs-type">int</span> b)</span>;<br><br><span class="hljs-comment">//源码与上述相同 由于ViewGroup中所有子View的layout都需要实现，所以需要实现 onLayout() 方法</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onLayout</span><span class="hljs-params">(<span class="hljs-type">boolean</span> changed,<span class="hljs-type">int</span> left,<span class="hljs-type">int</span> top,<span class="hljs-type">int</span> right,<span class="hljs-type">int</span> bottom)</span>&#123;<br>    <span class="hljs-comment">//遍历子View</span><br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span><span class="hljs-number">0</span> ; i &lt;getChildCount();i++)&#123;<br>        <span class="hljs-type">View</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> getChildAt(i);<br>        <br>        <span class="hljs-comment">//在这里可以添加 顶点变化逻辑</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">childTop</span> <span class="hljs-operator">=</span> Top;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">childLeft</span> <span class="hljs-operator">=</span> Left;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">childBottom</span> <span class="hljs-operator">=</span> Bottom;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">childRight</span> <span class="hljs-operator">=</span> Right;<br>         <br>        ...<br>        setChildFrame(child,childLeft,childTop,childRight,childBottom);<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setChildFrame</span><span class="hljs-params">(child,<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> t,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> b)</span>&#123;<br>    <span class="hljs-comment">//按照上一节流程走</span><br>    child.layout(l,t,r,b);<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="/images/ViewGroup-Layout.png" srcset="/img/loading.gif" lazyload alt="ViewGroup-Layout"></p>
<p>按照流程图简单总结一下：</p>
<ul>
<li>先调用ViewGroup的<code>layout()</code>，先对ViewGroup进行布局过程</li>
<li>在ViewGroup的<code>onLayout()</code>中实现子View的遍历布局过程</li>
<li>对遍历的子View按照ViewGroup的要求进行顶点坐标的计算，计算完成后调用子View的<code>layout()</code></li>
</ul>
<p>拓展：</p>
<ol>
<li><p>View的测量宽&#x2F;高(<code>getMeasuredWidth()/getMeasuredHeight()</code>)与最终得到的宽&#x2F;高(<code>getWidth()/getHeight()</code>)有什么区别？</p>
<p><img src="/images/layout-getMeasureWidth(" srcset="/img/loading.gif" lazyload alt="layout-getMeasureWidth() 与 getWidth()区别"> 与 getWidth()区别.png)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//	获得View在测量过程中的宽</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getMeasuredWidth</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> mMeasuredWidth &amp; MEASURED_SIZE_MASK;<br>    &#125;<br><span class="hljs-comment">//	获得View在测量过程中的高</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getMeasuredHeight</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> mMeasuredHeight &amp; MEASURED_SIZE_MASK;<br>    &#125;<br><span class="hljs-comment">//	上节 measure 源码分析中就是调用了该方法 进行View的测量</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setMeasuredDimensionRaw</span><span class="hljs-params">(<span class="hljs-type">int</span> measuredWidth, <span class="hljs-type">int</span> measuredHeight)</span> &#123;<br>        mMeasuredWidth = measuredWidth;<br>        mMeasuredHeight = measuredHeight;<br>        mPrivateFlags |= PFLAG_MEASURED_DIMENSION_SET;<br>    &#125;<br><span class="hljs-comment">//获得View最终宽</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getWidth</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> mRight - mLeft;<br>    &#125;<br><span class="hljs-comment">//获得View最终高</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getHeight</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> mBottom - mTop;<br> &#125;<br></code></pre></td></tr></table></figure></li>
</ol>
<blockquote>
<p>两者的比较</p>
</blockquote>
<table>
<thead>
<tr>
<th align="left">类型</th>
<th>何时赋值</th>
<th>赋值方法</th>
<th>使用场景</th>
</tr>
</thead>
<tbody><tr>
<td align="left">View测量结束宽&#x2F;高<br>getMeasuredWidth()&#x2F;getMeasuredHeight()</td>
<td>View的<code>measure</code>过程</td>
<td><code>setMeasuredDimension()</code></td>
<td>在<code>onLayout()</code>获取View的宽&#x2F;高</td>
</tr>
<tr>
<td align="left">View最终宽&#x2F;高<br>getWidth()&#x2F;getHeight()</td>
<td>View的<code>layout</code>过程</td>
<td><code>layout()</code>对top,left,right,bottom进行操作</td>
<td><code>onLayout()</code>结束后获取最终宽&#x2F;高</td>
</tr>
</tbody></table>
<p>   <strong>一般情况下，二者返回的数据是相同的，除非人为对View的<code>layout()</code>进行重写。</strong></p>
   <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">layout</span><span class="hljs-params">(<span class="hljs-type">int</span> l,<span class="hljs-type">int</span> t,<span class="hljs-type">int</span> r,<span class="hljs-type">int</span> b)</span>&#123;<br>    <span class="hljs-built_in">super</span>.layout(l,t,r+<span class="hljs-number">100</span>,b+<span class="hljs-number">100</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>   上述代码就会导致View最终结果与测量时不同。</p>
<h3 id="draw-绘制"><a href="#draw-绘制" class="headerlink" title="draw-绘制"></a>draw-绘制</h3><blockquote>
<p>draw作用主要将View绘制在屏幕上面</p>
<p><strong>draw过程，先draw自身再draw子View</strong></p>
<p>起点是<code>performDraw()</code></p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ViewRootImpl.java</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performDraw</span><span class="hljs-params">()</span> &#123;<br>      ...<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">canUseAsync</span> <span class="hljs-operator">=</span> draw(fullRedrawNeeded);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">draw</span><span class="hljs-params">(<span class="hljs-type">boolean</span> fullRedrawNeeded)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!dirty.isEmpty() || mIsAnimating || accessibilityFocusDirty) &#123;<br>            <span class="hljs-keyword">if</span> (mAttachInfo.mThreadedRenderer != <span class="hljs-literal">null</span> &amp;&amp; mAttachInfo.mThreadedRenderer.isEnabled()) &#123;<br>              <span class="hljs-comment">//硬件绘制</span><br>              ...<br>                mAttachInfo.mThreadedRenderer.draw(mView, mAttachInfo, <span class="hljs-built_in">this</span>, callback);              <br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              <span class="hljs-comment">//软件绘制</span><br>              ...<br>              <span class="hljs-keyword">if</span> (!drawSoftware(surface, mAttachInfo, xOffset, yOffset,<br>                        scalingRequired, dirty, surfaceInsets)) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br>          ...<br>    &#125;<br></code></pre></td></tr></table></figure>



<h4 id="View的draw过程"><a href="#View的draw过程" class="headerlink" title="View的draw过程"></a>View的draw过程</h4><p><img src="/images/draw-View%E7%9A%84draw%E8%BF%87%E7%A8%8B.png" srcset="/img/loading.gif" lazyload alt="draw-View的draw过程"></p>
<p>View的draw过程，从<code>View.draw()</code>开始</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// ../android/view/View.java</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">draw</span><span class="hljs-params">(Canvas canvas)</span> &#123;<br>    <span class="hljs-comment">//标记当前View是否背景透明</span><br>    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">dirtyOpaque</span> <span class="hljs-operator">=</span> (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp;<br>                (mAttachInfo == <span class="hljs-literal">null</span> || !mAttachInfo.mIgnoreDirtyState);<br>    <br>    <span class="hljs-type">int</span> saveCount;<br>        <span class="hljs-comment">//1. 绘制背景</span><br>    <span class="hljs-keyword">if</span> (!dirtyOpaque) &#123;<br>            drawBackground(canvas);<br>        &#125;<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">viewFlags</span> <span class="hljs-operator">=</span> mViewFlags;<br>    <span class="hljs-comment">//是否有水平边缘</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">horizontalEdges</span> <span class="hljs-operator">=</span> (viewFlags &amp; FADING_EDGE_HORIZONTAL) != <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">//是否有竖直边缘</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">verticalEdges</span> <span class="hljs-operator">=</span> (viewFlags &amp; FADING_EDGE_VERTICAL) != <span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">if</span>(!horizontalEdges &amp;&amp; !verticalEdges)&#123;<br>       <span class="hljs-comment">// 3.绘制View本身</span><br>          <span class="hljs-keyword">if</span> (!dirtyOpaque) onDraw(canvas);<br><br>       <span class="hljs-comment">// 4.绘制子View</span><br>          dispatchDraw(canvas);<br>        <br>       <span class="hljs-comment">// 6.绘制装饰 例如滚动条</span><br>          onDrawForeground(canvas);<br>        <br>    ...<br>       <span class="hljs-keyword">return</span>; <br>    &#125;<br>    <br>    <span class="hljs-comment">//如果有竖直边缘或者水平边缘 例如divide</span><br>    <br>    <span class="hljs-comment">// 2. 保存当前Canvas层</span><br>        saveCount = canvas.getSaveCount();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">solidColor</span> <span class="hljs-operator">=</span> getSolidColor();<br>        <span class="hljs-keyword">if</span> (solidColor == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">flags</span> <span class="hljs-operator">=</span> Canvas.HAS_ALPHA_LAYER_SAVE_FLAG;<br>            <span class="hljs-keyword">if</span> (drawTop) &#123;<br>                canvas.saveLayer(left, top, right, top + length, <span class="hljs-literal">null</span>, flags);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (drawBottom) &#123;<br>                canvas.saveLayer(left, bottom - length, right, bottom, <span class="hljs-literal">null</span>, flags);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (drawLeft) &#123;<br>                canvas.saveLayer(left, top, left + length, bottom, <span class="hljs-literal">null</span>, flags);<br>            &#125;<br>            <span class="hljs-keyword">if</span> (drawRight) &#123;<br>                canvas.saveLayer(right - length, top, right, bottom, <span class="hljs-literal">null</span>, flags);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            scrollabilityCache.setFadeColor(solidColor);<br>        &#125;<br>    ...<br>        <span class="hljs-comment">// 3.绘制View本身</span><br>          <span class="hljs-keyword">if</span> (!dirtyOpaque) onDraw(canvas);<br><br>       <span class="hljs-comment">// 4.绘制子View</span><br>          dispatchDraw(canvas);<br>    <br>    ...<br>        <span class="hljs-comment">// 5.绘制边缘效果 例如阴影</span><br>        canvas.restoreToCount(saveCount);<br>    ...<br>        <br>       <span class="hljs-comment">// 6.绘制装饰 例如滚动条</span><br>          onDrawForeground(canvas);<br>    ...<br>    <br>&#125;<br><br><span class="hljs-comment">//绘制View本身的背景</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">drawBackground</span><span class="hljs-params">(Canvas canvas)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Drawable</span> <span class="hljs-variable">background</span> <span class="hljs-operator">=</span> mBackground;<br>        <span class="hljs-keyword">if</span> (background == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br>        <span class="hljs-comment">//设置View的背景边界</span><br>        setBackgroundBounds();<br>        ...<br>          <br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">scrollX</span> <span class="hljs-operator">=</span> mScrollX;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">scrollY</span> <span class="hljs-operator">=</span> mScrollY;<br>        <span class="hljs-keyword">if</span> ((scrollX | scrollY) == <span class="hljs-number">0</span>) &#123;<br>            background.draw(canvas);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">//将画布偏移 然后在偏移后的画布上进行背景绘制</span><br>            canvas.translate(scrollX, scrollY);<br>            background.draw(canvas);<br>            canvas.translate(-scrollX, -scrollY);<br>        &#125;<br>    &#125;<br><br><span class="hljs-comment">//绘制View本身的内容</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDraw</span><span class="hljs-params">(Canvas canvas)</span> &#123;<br>    <span class="hljs-comment">// 默认空实现 需要子类复写该方法以实现内容的绘制 ，自定义View中必须执行该方法</span><br>    &#125;<br><br><span class="hljs-comment">//绘制子View的内容</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dispatchDraw</span><span class="hljs-params">(Canvas canvas)</span> &#123;<br>    <span class="hljs-comment">//由于View不存在子View，所以不需要实现</span><br>    &#125;<br><br><span class="hljs-comment">//绘制装饰 例如滚动条 前景图片</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onDrawForeground</span><span class="hljs-params">(Canvas canvas)</span> &#123;<br>        onDrawScrollIndicators(canvas);<br>        onDrawScrollBars(canvas);<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Drawable</span> <span class="hljs-variable">foreground</span> <span class="hljs-operator">=</span> mForegroundInfo != <span class="hljs-literal">null</span> ? mForegroundInfo.mDrawable : <span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">if</span> (foreground != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">if</span> (mForegroundInfo.mBoundsChanged) &#123;<br>                mForegroundInfo.mBoundsChanged = <span class="hljs-literal">false</span>;<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">Rect</span> <span class="hljs-variable">selfBounds</span> <span class="hljs-operator">=</span> mForegroundInfo.mSelfBounds;<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">Rect</span> <span class="hljs-variable">overlayBounds</span> <span class="hljs-operator">=</span> mForegroundInfo.mOverlayBounds;<br><br>                <span class="hljs-keyword">if</span> (mForegroundInfo.mInsidePadding) &#123;<br>                    selfBounds.set(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, getWidth(), getHeight());<br>                &#125; <span class="hljs-keyword">else</span> &#123;<br>                    selfBounds.set(getPaddingLeft(), getPaddingTop(),<br>                            getWidth() - getPaddingRight(), getHeight() - getPaddingBottom());<br>                &#125;<br><br>                <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">ld</span> <span class="hljs-operator">=</span> getLayoutDirection();<br>                Gravity.apply(mForegroundInfo.mGravity, foreground.getIntrinsicWidth(),<br>                        foreground.getIntrinsicHeight(), selfBounds, overlayBounds, ld);<br>                foreground.setBounds(overlayBounds);<br>            &#125;<br><br>            foreground.draw(canvas);<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><img src="/images/View-Draw.png" srcset="/img/loading.gif" lazyload alt="View-Draw"></p>
<p>结合上述流程图分析Draw过程：</p>
<ul>
<li>先调用<code>View.draw()</code>方法开始Draw流程</li>
<li>如果需要<code>dirtyOpaque</code>，就绘制背景<code>drawBackground()</code></li>
<li>如果需要显示边缘效果，就进行保存画布<code>canvas.saveLayer()</code></li>
<li>如果需要<code>dirtyOpaque</code>，绘制自身的内容<code>onDraw()</code> – <strong>自定义View必须实现</strong></li>
<li>调用<code>dispatchDraw()</code>绘制子View</li>
<li>如果需要显示边缘效果，绘制后，还原画布<code>canvas.restore()</code></li>
<li>调用<code>drawForeground()</code>绘制装饰，例如滚动条或前景</li>
</ul>
<h4 id="ViewGroup的draw过程"><a href="#ViewGroup的draw过程" class="headerlink" title="ViewGroup的draw过程"></a>ViewGroup的draw过程</h4><p><img src="/images/draw-ViewGroup%E7%9A%84draw%E8%BF%87%E7%A8%8B.png" srcset="/img/loading.gif" lazyload alt="draw-ViewGroup的draw过程"></p>
<p>ViewGroup的draw过程主要调整了上述源码中的<code>dispatchDraw()</code>，在其内部进行了子View的遍历以及绘制过程</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs java"> <span class="hljs-comment">// ../android/view/ViewGroup.java</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dispatchDraw</span><span class="hljs-params">(Canvas canvas)</span> &#123;<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">usingRenderNodeProperties</span> <span class="hljs-operator">=</span> canvas.isRecordingFor(mRenderNode);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">childrenCount</span> <span class="hljs-operator">=</span> mChildrenCount;<br>        <span class="hljs-keyword">final</span> View[] children = mChildren;<br>    ...<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; childrenCount; i++) &#123;<br>            <span class="hljs-keyword">while</span> (transientIndex &gt;= <span class="hljs-number">0</span> &amp;&amp; mTransientIndices.get(transientIndex) == i) &#123;<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">transientChild</span> <span class="hljs-operator">=</span> mTransientViews.get(transientIndex);<br>                <span class="hljs-keyword">if</span> ((transientChild.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE ||<br>                        transientChild.getAnimation() != <span class="hljs-literal">null</span>) &#123;<br>                    more |= drawChild(canvas, transientChild, drawingTime);<br>                &#125;<br>                transientIndex++;<br>                <span class="hljs-keyword">if</span> (transientIndex &gt;= transientCount) &#123;<br>                    transientIndex = -<span class="hljs-number">1</span>;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">childIndex</span> <span class="hljs-operator">=</span> getAndVerifyPreorderedIndex(childrenCount, i, customOrder);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> getAndVerifyPreorderedView(preorderedList, children, childIndex);<br>            <span class="hljs-keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || child.getAnimation() != <span class="hljs-literal">null</span>) &#123;<br>                more |= drawChild(canvas, child, drawingTime);<br>            &#125;<br>        &#125;<br>    ...<br>&#125;<br><br><span class="hljs-comment">//绘制子View</span><br><span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">drawChild</span><span class="hljs-params">(Canvas canvas, View child, <span class="hljs-type">long</span> drawingTime)</span> &#123;<br>      <span class="hljs-comment">//调用子View的draw方法</span><br>      <span class="hljs-keyword">return</span> child.draw(canvas, <span class="hljs-built_in">this</span>, drawingTime);<br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p><img src="/images/ViewGroup-Draw.png" srcset="/img/loading.gif" lazyload alt="ViewGroup-Draw"></p>
<p>结合上述流程图分析ViewGroup的Draw过程：</p>
<ul>
<li>draw过程与上述<code>View的draw过程一致</code></li>
<li><code>dispatchDraw()</code>默认实现，内部包含了子View的遍历以及绘制</li>
</ul>
<p>拓展：</p>
<ol>
<li><p><code>View.setWillNotDraw()</code>有什么意义?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setWillNotDraw</span><span class="hljs-params">(<span class="hljs-type">boolean</span> willNotDraw)</span> &#123;<br>    <span class="hljs-comment">//设置 不需绘制 标记位</span><br>    setFlags(willNotDraw ? WILL_NOT_DRAW : <span class="hljs-number">0</span>, DRAW_MASK);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>如果一个View不需要绘制任何内容，设置这个标记为<code>true</code>，系统就会进行相应优化。</p>
<p><em><strong>View默认不开启<code>willNotDraw</code>标记位，ViewGroup默认开启。</strong></em></p>
</li>
<li><p><code>ViewGroup</code>修改子View绘制顺序</p>
<p><img src="/images/draw-ViewGroup%E8%87%AA%E5%AE%9A%E4%B9%89%E7%BB%98%E5%88%B6%E9%A1%BA%E5%BA%8F.png" srcset="/img/loading.gif" lazyload alt="draw-ViewGroup自定义绘制顺序"></p>
<figure class="highlight java"><figcaption><span>ViewGroup.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dispatchDraw</span><span class="hljs-params">(Canvas canvas)</span>&#123;<br>  ...<br>    <span class="hljs-comment">//设置自定义绘制顺序</span><br>   <span class="hljs-keyword">final</span> ArrayList&lt;View&gt; preorderedList = usingRenderNodeProperties<br>                ? <span class="hljs-literal">null</span> : buildOrderedChildList();<br>        <span class="hljs-comment">//是否允许自定义绘制顺序</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">customOrder</span> <span class="hljs-operator">=</span> preorderedList == <span class="hljs-literal">null</span><br>                &amp;&amp; isChildrenDrawingOrderEnabled();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; childrenCount; i++) &#123;<br>            <span class="hljs-keyword">while</span> (transientIndex &gt;= <span class="hljs-number">0</span> &amp;&amp; mTransientIndices.get(transientIndex) == i) &#123;<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">transientChild</span> <span class="hljs-operator">=</span> mTransientViews.get(transientIndex);<br>                <span class="hljs-keyword">if</span> ((transientChild.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE ||<br>                        transientChild.getAnimation() != <span class="hljs-literal">null</span>) &#123;<br>                    more |= drawChild(canvas, transientChild, drawingTime);<br>                &#125;<br>                transientIndex++;<br>                <span class="hljs-keyword">if</span> (transientIndex &gt;= transientCount) &#123;<br>                    transientIndex = -<span class="hljs-number">1</span>;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">childIndex</span> <span class="hljs-operator">=</span> getAndVerifyPreorderedIndex(childrenCount, i, customOrder);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">child</span> <span class="hljs-operator">=</span> getAndVerifyPreorderedView(preorderedList, children, childIndex);<br>            <span class="hljs-keyword">if</span> ((child.mViewFlags &amp; VISIBILITY_MASK) == VISIBLE || child.getAnimation() != <span class="hljs-literal">null</span>) &#123;<br>                more |= drawChild(canvas, child, drawingTime);<br>            &#125;<br>        &#125;<br> ...<br>&#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">isChildrenDrawingOrderEnabled</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> (mGroupFlags &amp; FLAG_USE_CHILD_DRAWING_ORDER) == FLAG_USE_CHILD_DRAWING_ORDER;<br>    &#125;<br><span class="hljs-comment">//设置是否允许自定义绘制顺序</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setChildrenDrawingOrderEnabled</span><span class="hljs-params">(<span class="hljs-type">boolean</span> enabled)</span> &#123;<br>        setBooleanFlag(FLAG_USE_CHILD_DRAWING_ORDER, enabled);<br>    &#125;<br><br> <span class="hljs-comment">//初始子View的绘制顺序 按照z轴的值调整绘制顺序，z轴从大到小绘制</span><br>    ArrayList&lt;View&gt; <span class="hljs-title function_">buildOrderedChildList</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">childrenCount</span> <span class="hljs-operator">=</span> mChildrenCount;<br>        <span class="hljs-keyword">if</span> (childrenCount &lt;= <span class="hljs-number">1</span> || !hasChildWithZ()) <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br><br>        <span class="hljs-keyword">if</span> (mPreSortedChildren == <span class="hljs-literal">null</span>) &#123;<br>            mPreSortedChildren = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;(childrenCount);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// callers should clear, so clear shouldn&#x27;t be necessary, but for safety...</span><br>            mPreSortedChildren.clear();<br>            mPreSortedChildren.ensureCapacity(childrenCount);<br>        &#125;<br><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">customOrder</span> <span class="hljs-operator">=</span> isChildrenDrawingOrderEnabled();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; childrenCount; i++) &#123;<br>            <span class="hljs-comment">// add next child (in child order) to end of list</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">childIndex</span> <span class="hljs-operator">=</span> getAndVerifyPreorderedIndex(childrenCount, i, customOrder);<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">nextChild</span> <span class="hljs-operator">=</span> mChildren[childIndex];<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">float</span> <span class="hljs-variable">currentZ</span> <span class="hljs-operator">=</span> nextChild.getZ();<br><br>            <span class="hljs-comment">// insert ahead of any Views with greater Z</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">insertIndex</span> <span class="hljs-operator">=</span> i;<br>            <span class="hljs-keyword">while</span> (insertIndex &gt; <span class="hljs-number">0</span> &amp;&amp; mPreSortedChildren.get(insertIndex - <span class="hljs-number">1</span>).getZ() &gt; currentZ) &#123;<br>                insertIndex--;<br>            &#125;<br>            mPreSortedChildren.add(insertIndex, nextChild);<br>        &#125;<br>        <span class="hljs-keyword">return</span> mPreSortedChildren;<br>    &#125;<br><br>    <span class="hljs-comment">//确定当前子View的绘制顺序</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getAndVerifyPreorderedIndex</span><span class="hljs-params">(<span class="hljs-type">int</span> childrenCount, <span class="hljs-type">int</span> i, <span class="hljs-type">boolean</span> customOrder)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> childIndex;<br>        <span class="hljs-keyword">if</span> (customOrder) &#123;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">childIndex1</span> <span class="hljs-operator">=</span> getChildDrawingOrder(childrenCount, i);<br>            <span class="hljs-keyword">if</span> (childIndex1 &gt;= childrenCount) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IndexOutOfBoundsException</span>(<span class="hljs-string">&quot;getChildDrawingOrder() &quot;</span><br>                        + <span class="hljs-string">&quot;returned invalid index &quot;</span> + childIndex1<br>                        + <span class="hljs-string">&quot; (child count is &quot;</span> + childrenCount + <span class="hljs-string">&quot;)&quot;</span>);<br>            &#125;<br>            childIndex = childIndex1;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            childIndex = i;<br>        &#125;<br>        <span class="hljs-keyword">return</span> childIndex;<br>    &#125;<br><span class="hljs-comment">//需要重写该方法，调整绘制顺序</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getChildDrawingOrder</span><span class="hljs-params">(<span class="hljs-type">int</span> childCount, <span class="hljs-type">int</span> i)</span> &#123;<br>        <span class="hljs-keyword">return</span> i;<br>    &#125;<br><br><span class="hljs-comment">//调整当前子View顺序</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> View <span class="hljs-title function_">getAndVerifyPreorderedView</span><span class="hljs-params">(ArrayList&lt;View&gt; preorderedList, View[] children,</span><br><span class="hljs-params">            <span class="hljs-type">int</span> childIndex)</span> &#123;<br>        <span class="hljs-keyword">final</span> View child;<br>        <span class="hljs-keyword">if</span> (preorderedList != <span class="hljs-literal">null</span>) &#123;<br>            child = preorderedList.get(childIndex);<br>            <span class="hljs-keyword">if</span> (child == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;Invalid preorderedList contained null child at index &quot;</span><br>                        + childIndex);<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            child = children[childIndex];<br>        &#125;<br>        <span class="hljs-keyword">return</span> child;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>根据上述源码，默认的绘制<strong>按照z轴从大到小的顺序</strong>进行绘制，如果需要修改绘制顺序的话，需要执行以下两步：</p>
<ol>
<li><code>setChildrenDrawingOrderEnabled(true)</code>打开自定义设置开关</li>
<li>继承<code>ViewGroup</code>后，重写<code>getChildDrawingOrder()</code>方法，设置对应的绘制顺序</li>
</ol>
<p>常用的<code>RecyclerView</code>、<code>ViewPager</code>都实现了该方法，其中<code>RecyclerView</code>通过设置<code>ChildDrawingOrderCallback</code>也可以实现这个功能。</p>
</li>
</ol>
<p>如果在<code>addView()</code>的场景下，可通过<code>setElevation()</code>或<code>setTranslationZ()</code>或<code>setZ()</code>去修改Z轴的坐标值。</p>
<h2 id="自定义View-1"><a href="#自定义View-1" class="headerlink" title="自定义View"></a>自定义View</h2><p><img src="/images/%E8%87%AA%E5%AE%9A%E4%B9%89View.png" srcset="/img/loading.gif" lazyload alt="自定义View"></p>
<blockquote>
<p>自定义View需要了解View的层次、View的事件分发机制以及View的工作流程。</p>
</blockquote>
<h3 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h3><h4 id="1-继承View重写onDraw"><a href="#1-继承View重写onDraw" class="headerlink" title="1.继承View重写onDraw()"></a>1.继承View重写<code>onDraw()</code></h4><blockquote>
<p>主要用于实现一些不规则的效果，不方便通过布局的组合方法可以直接实现，往往需要静态或者动态的显示一些不规则图形(圆形啥的)。</p>
<p>特殊形状的这种就需要重写<code>onDraw()</code>实现。<strong>一般需要额外支持wrap_content，并且也需要处理padding方法。</strong></p>
</blockquote>
<h4 id="2-继承ViewGroup派生特殊的Layout"><a href="#2-继承ViewGroup派生特殊的Layout" class="headerlink" title="2.继承ViewGroup派生特殊的Layout"></a>2.继承ViewGroup派生特殊的Layout</h4><blockquote>
<p>主要用于实现自定义的布局，除了常用的一些布局外。实现的是几种View的组合形式</p>
<p><strong>实现稍微复杂，需要合适的处理ViewGroup的<code>onMeasure()，onLayout()</code>以及子View的<code>onMeasure()，onLayout()</code></strong></p>
</blockquote>
<h4 id="3-继承特定的View-例如TextView"><a href="#3-继承特定的View-例如TextView" class="headerlink" title="3.继承特定的View(例如TextView)"></a>3.继承特定的View(例如TextView)</h4><blockquote>
<p>这种比较常见，一般用于拓展已有View的功能。</p>
<p><strong>实现比较简单，无需自己处理wrap_content以及padding</strong></p>
</blockquote>
<h4 id="4-继承特定的ViewGroup-例如LinearLayout"><a href="#4-继承特定的ViewGroup-例如LinearLayout" class="headerlink" title="4.继承特定的ViewGroup(例如LinearLayout)"></a>4.继承特定的ViewGroup(例如LinearLayout)</h4><blockquote>
<p>比较常见，当某种效果看起来很像几种View组合在一起的时候</p>
<p><strong>实现比较简单，无需自己处理测量以及布局过程</strong></p>
</blockquote>
<h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p><img src="/images/%E8%87%AA%E5%AE%9A%E4%B9%89View-%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A1%B9.png" srcset="/img/loading.gif" lazyload alt="自定义View-注意事项"></p>
<h4 id="1-让View支持wrap-content"><a href="#1-让View支持wrap-content" class="headerlink" title="1.让View支持wrap_content"></a>1.让View支持wrap_content</h4><blockquote>
<p>直接继承View或ViewGroup的控件，不重写<code>onMeasure()</code>并对<code>AT_MOST</code>进行处理，就无法达到需要的显示效果。</p>
</blockquote>
<h4 id="2-需要的话，让View支持padding"><a href="#2-需要的话，让View支持padding" class="headerlink" title="2.需要的话，让View支持padding"></a>2.需要的话，让View支持padding</h4><blockquote>
<p>直接继承View的控件，需要在<code>draw</code>过程处理padding属性，不然padding属性无法起作用。</p>
<p>直接继承ViewGroup的控件，需要在<code>onMeasure()，onLayout()</code>处理自身的padding以及子View的margin<code>measureChildWithMargin()</code></p>
</blockquote>
<h4 id="3-尽量不要在View中使用Handler"><a href="#3-尽量不要在View中使用Handler" class="headerlink" title="3.尽量不要在View中使用Handler"></a>3.尽量不要在View中使用Handler</h4><blockquote>
<p>View内部提供了<code>post</code>方法，可以替代Handler使用</p>
</blockquote>
<h4 id="4-View中如果有线程或动画，需要及时停止"><a href="#4-View中如果有线程或动画，需要及时停止" class="headerlink" title="4.View中如果有线程或动画，需要及时停止"></a>4.View中如果有线程或动画，需要及时停止</h4><blockquote>
<ol>
<li>不处理有可能造成内存泄漏，View不可见时也需要停止线程和动画</li>
<li>包含View的Activity启动时，View的<code>onAttachedToWindow()</code>会调用</li>
<li>包含View的Activity退出或当前View被移除时，调用<code>View.onDetachedFromWindow()</code>时关闭线程和动画</li>
</ol>
</blockquote>
<h4 id="5-View若有滑动冲突情况，需要处理"><a href="#5-View若有滑动冲突情况，需要处理" class="headerlink" title="5.View若有滑动冲突情况，需要处理"></a>5.View若有滑动冲突情况，需要处理</h4><blockquote>
<p>滑动冲突处理方法：</p>
<ul>
<li><p><code>外部拦截法</code>：点击事件都先经过<strong>父容器的拦截处理</strong>，如果父容器需要此事件就拦截，不需要就放行</p>
<p>重写父容器的<code>onInterceptTouchEvent()</code>，在方法内部拦截</p>
</li>
<li><p><code>内部拦截法</code>：父容器不拦截任何事件，所有事件交由子容器进行处理，如果子容器需要就消耗事件，不需要就返给父容器处理。</p>
<p>重写父容器的<code>onInterceptTouchEvent()</code>，以及子容器的<code>dispatchTouchEvent()</code>。关键在于调用<code>requestDisallowInterceptTouchEvent()</code>控制父布局是否进行拦截。</p>
</li>
</ul>
<p>一般推荐使用<code>外部拦截法</code>，符合事件分发流程。</p>
</blockquote>
<h3 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h3><a href="/2019/01/02/%E8%87%AA%E5%AE%9A%E4%B9%89View%E5%AE%9E%E8%B7%B5/" title="自定义View实践">自定义View实践</a>

<a href="/2019/01/02/%E8%87%AA%E5%AE%9A%E4%B9%89ViewGroup%E5%AE%9E%E8%B7%B5/" title="自定义ViewGroup实践">自定义ViewGroup实践</a>

<h2 id="拓展-1"><a href="#拓展-1" class="headerlink" title="拓展"></a>拓展</h2><h3 id="如何触发View的重新绘制？"><a href="#如何触发View的重新绘制？" class="headerlink" title="如何触发View的重新绘制？"></a>如何触发View的重新绘制？</h3><p>通过调用<code>invalidate()/postInvalidate()</code>或<code>requestLayout()</code>实现。</p>
<p><img src="/images/View%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-%E8%A7%A6%E5%8F%91View%E7%9A%84%E9%87%8D%E6%96%B0%E7%BB%98%E5%88%B6.png" srcset="/img/loading.gif" lazyload alt="View工作原理-触发View的重新绘制"></p>
<h4 id="requestLayout"><a href="#requestLayout" class="headerlink" title="requestLayout"></a>requestLayout</h4><p><img src="/images/View%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-requestLayout.png" srcset="/img/loading.gif" lazyload alt="View工作原理-requestLayout"></p>
<blockquote>
<p>在需要刷新<code>View</code>的布局时会调用该函数。不应该在布局的过程中调用这个函数。</p>
<p>这个请求可能会在以下场景执行：当前布局结束、当前帧绘制完成，下次布局发生时</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//View.java</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestLayout</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (mMeasureCache != <span class="hljs-literal">null</span>) mMeasureCache.clear();<br><br>        <span class="hljs-keyword">if</span> (mAttachInfo != <span class="hljs-literal">null</span> &amp;&amp; mAttachInfo.mViewRequestingLayout == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// Only trigger request-during-layout logic if this is the view requesting it,</span><br>            <span class="hljs-comment">// not the views in its parent hierarchy</span><br>            <span class="hljs-type">ViewRootImpl</span> <span class="hljs-variable">viewRoot</span> <span class="hljs-operator">=</span> getViewRootImpl();<br>            <span class="hljs-keyword">if</span> (viewRoot != <span class="hljs-literal">null</span> &amp;&amp; viewRoot.isInLayout()) &#123;<br>                <span class="hljs-keyword">if</span> (!viewRoot.requestLayoutDuringLayout(<span class="hljs-built_in">this</span>)) &#123;<br>                  <span class="hljs-comment">//如果当前在layout过程中，且调用了 requestLayout，就需要直接返回</span><br>                  <span class="hljs-comment">//等待下一次信号到来时执行</span><br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>            &#125;<br>            mAttachInfo.mViewRequestingLayout = <span class="hljs-built_in">this</span>;<br>        &#125;<br>        <span class="hljs-comment">//设置强制刷新标记</span><br>        mPrivateFlags |= PFLAG_FORCE_LAYOUT;<span class="hljs-comment">//该标记可执行onMeasure()</span><br>        mPrivateFlags |= PFLAG_INVALIDATED;<span class="hljs-comment">//</span><br><br>        <span class="hljs-keyword">if</span> (mParent != <span class="hljs-literal">null</span> &amp;&amp; !mParent.isLayoutRequested()) &#123;<br>            <span class="hljs-comment">//向父布局继续请求刷新布局</span><br>            mParent.requestLayout();<br>        &#125;<br>        <span class="hljs-keyword">if</span> (mAttachInfo != <span class="hljs-literal">null</span> &amp;&amp; mAttachInfo.mViewRequestingLayout == <span class="hljs-built_in">this</span>) &#123;<br>            mAttachInfo.mViewRequestingLayout = <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br><br></code></pre></td></tr></table></figure>

<p><code>mParent</code>对应父节点，一层层向上递归调用父节点<code>requestLayout()。</code>直到调用<code>ViewRootImpl.requestLayout()</code>结束.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ViewRootImpl.java</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">requestLayout</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (!mHandlingLayoutInLayoutRequest) &#123;<br>          <span class="hljs-comment">//检查当前是否主线程</span><br>            checkThread();<br>          <span class="hljs-comment">//需要执行measure、layout</span><br>            mLayoutRequested = <span class="hljs-literal">true</span>;<br>            scheduleTraversals();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>调用到<code>scheduleTraversals()</code>就是开始了<code>View的绘制流程</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ViewRootImpl.java </span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performTraversals</span><span class="hljs-params">()</span> &#123;<br>  <span class="hljs-comment">//是否执行measure、layout过程</span><br>   <span class="hljs-type">boolean</span> <span class="hljs-variable">layoutRequested</span> <span class="hljs-operator">=</span> mLayoutRequested &amp;&amp; (!mStopped || mReportNextDraw);<br>  ...<br>    <span class="hljs-keyword">if</span> (!mStopped || mReportNextDraw) &#123;<br>         <span class="hljs-keyword">if</span> (focusChangedDueToTouchMode || mWidth != host.getMeasuredWidth()<br>                  || mHeight != host.getMeasuredHeight() || contentInsetsChanged ||<br>                   updatedConfiguration) &#123; <br>                  <span class="hljs-comment">//执行测量流程</span><br>                    performMeasure(childWidthMeasureSpec, childHeightMeasureSpec);<br>         &#125;<br>    &#125;<br>  ...<br>    <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">didLayout</span> <span class="hljs-operator">=</span> layoutRequested &amp;&amp; (!mStopped || mReportNextDraw);<br>     <span class="hljs-keyword">if</span> (didLayout) &#123;<br>       <span class="hljs-comment">//执行布局流程</span><br>            performLayout(lp, mWidth, mHeight);<br>     &#125;<br>  ...<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">cancelDraw</span> <span class="hljs-operator">=</span> mAttachInfo.mTreeObserver.dispatchOnPreDraw() || !isViewVisible;<br><br>        <span class="hljs-keyword">if</span> (!cancelDraw &amp;&amp; !newSurface) &#123;<br>            <span class="hljs-keyword">if</span> (mPendingTransitions != <span class="hljs-literal">null</span> &amp;&amp; mPendingTransitions.size() &gt; <span class="hljs-number">0</span>) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; mPendingTransitions.size(); ++i) &#123;<br>                    mPendingTransitions.get(i).startChangingAnimations();<br>                &#125;<br>                mPendingTransitions.clear();<br>            &#125;<br>          <span class="hljs-comment">//执行绘制流程</span><br>            performDraw();<br>        &#125;    <br> &#125;<br></code></pre></td></tr></table></figure>



<p>一开始调用的<code>performMeasure()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ViewRootImpl.java</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performMeasure</span><span class="hljs-params">(<span class="hljs-type">int</span> childWidthMeasureSpec, <span class="hljs-type">int</span> childHeightMeasureSpec)</span> &#123;<br>       ...<br>        <span class="hljs-keyword">try</span> &#123;<br>            mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            Trace.traceEnd(Trace.TRACE_TAG_VIEW);<br>        &#125;<br>    &#125;<br><br><br><span class="hljs-comment">//View.java</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">measure</span><span class="hljs-params">(<span class="hljs-type">int</span> widthMeasureSpec, <span class="hljs-type">int</span> heightMeasureSpec)</span> &#123;<br>      ...<br>        <span class="hljs-comment">//需要执行onMeasure</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">forceLayout</span> <span class="hljs-operator">=</span> (mPrivateFlags &amp; PFLAG_FORCE_LAYOUT) == PFLAG_FORCE_LAYOUT;<br>      ...<br>        <span class="hljs-keyword">if</span> (forceLayout || needsLayout) &#123;<br>          ...<br>            onMeasure(widthMeasureSpec, heightMeasureSpec);<br>          ...<br>            <span class="hljs-comment">//添加 PFLAG_LAYOUT_REQUIRED标记，表示需要执行 layout流程</span><br>             mPrivateFlags |= PFLAG_LAYOUT_REQUIRED;<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>继续向下调用<code>performLayout()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ViewRootImpl.java</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performLayout</span><span class="hljs-params">(WindowManager.LayoutParams lp, <span class="hljs-type">int</span> desiredWindowWidth,</span><br><span class="hljs-params">            <span class="hljs-type">int</span> desiredWindowHeight)</span> &#123;<br>       <span class="hljs-comment">//正在执行layout流程</span><br>       mInLayout = <span class="hljs-literal">true</span>;<br><br>       <span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">host</span> <span class="hljs-operator">=</span> mView;<span class="hljs-comment">//对应DecorView</span><br>       <span class="hljs-comment">//在layout过程中 尚未执行requestLayout的view</span><br>       <span class="hljs-type">int</span> <span class="hljs-variable">numViewsRequestingLayout</span> <span class="hljs-operator">=</span> mLayoutRequesters.size();<br>       <span class="hljs-keyword">if</span> (numViewsRequestingLayout &gt; <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-comment">//寻找mPrivateFlags为PFLAG_FORCE_LAYOUT的View</span><br>           ArrayList&lt;View&gt; validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters,<br>                        <span class="hljs-literal">false</span>);<br>                <span class="hljs-keyword">if</span> (validLayoutRequesters != <span class="hljs-literal">null</span>) &#123;<br>                  <span class="hljs-comment">//当前View重新measure</span><br>                     measureHierarchy(host, lp, mView.getContext().getResources(),<br>                            desiredWindowWidth, desiredWindowHeight);     <br>                  <span class="hljs-comment">//重新执行layout</span><br>                     host.layout(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());  <br>                  ...<br>                    <span class="hljs-comment">//寻找尚未设置 PFLAG_FORCE_LAYOUT的View</span><br>                     validLayoutRequesters = getValidLayoutRequesters(mLayoutRequesters, <span class="hljs-literal">true</span>);                   <br>                     <span class="hljs-keyword">if</span> (validLayoutRequesters != <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-keyword">final</span> ArrayList&lt;View&gt; finalRequesters = validLayoutRequesters;<br>                        <span class="hljs-comment">// 执行requestLayout在下一帧执行时</span><br>                        getRunQueue().post(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Runnable</span>() &#123;<br>                            <span class="hljs-meta">@Override</span><br>                            <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>                                <span class="hljs-type">int</span> <span class="hljs-variable">numValidRequests</span> <span class="hljs-operator">=</span> finalRequesters.size();<br>                                <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; numValidRequests; ++i) &#123;<br>                                    <span class="hljs-keyword">final</span> <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> finalRequesters.get(i);<br>                                    Log.w(<span class="hljs-string">&quot;View&quot;</span>, <span class="hljs-string">&quot;requestLayout() improperly called by &quot;</span> + view +<br>                                            <span class="hljs-string">&quot; during second layout pass: posting in next frame&quot;</span>);<br>                                    view.requestLayout();<br>                                &#125;<br>                            &#125;<br>                        &#125;);<br>                    &#125;                 <br>                &#125;<br>       &#125;<br>      <br>    &#125;<br></code></pre></td></tr></table></figure>

<p>主要执行了三步：</p>
<ul>
<li>执行<code>DecorView</code>的<code>layout</code>过程</li>
<li>执行调用过<code>requestLayout()</code>的View(包含<code>PFLAG_FORCE_LAYOUT</code>标志)的<code>measure</code>和<code>layout</code></li>
<li>还没调用过<code>requestLayout()</code>的View加入到队列中，等待下一帧绘制时执行</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//View.java</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">layout</span><span class="hljs-params">(<span class="hljs-type">int</span> l, <span class="hljs-type">int</span> t, <span class="hljs-type">int</span> r, <span class="hljs-type">int</span> b)</span> &#123;<br>      <span class="hljs-comment">//判断当前位置是否发生变化</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">changed</span> <span class="hljs-operator">=</span> isLayoutModeOptical(mParent) ?<br>                setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);      <br>      <span class="hljs-comment">//位置发生变化。或 需要layout</span><br>        <span class="hljs-keyword">if</span> (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) &#123;<br>          <span class="hljs-comment">//回调onLayout()</span><br>            onLayout(changed, l, t, r, b);<br>          ...<br>         <span class="hljs-comment">//移除 PFLAG_LAYOUT_REQUIRED标志 在measure过程添加   </span><br>          mPrivateFlags &amp;= ~PFLAG_LAYOUT_REQUIRED;<br>          ...<br>        &#125;<br>      ...<br>        <span class="hljs-comment">//layout过程完成后 移除 PFLAG_FORCE_LAYOUT标志</span><br>        mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;        <br>      <br>    &#125;<br><br>    <span class="hljs-keyword">protected</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">setFrame</span><span class="hljs-params">(<span class="hljs-type">int</span> left, <span class="hljs-type">int</span> top, <span class="hljs-type">int</span> right, <span class="hljs-type">int</span> bottom)</span> &#123;<br>      <span class="hljs-comment">//位置发生变化时，就需要执行 invalidate()重绘View</span><br>      <span class="hljs-keyword">if</span> (mLeft != left || mRight != right || mTop != top || mBottom != bottom) &#123;<br>         <span class="hljs-type">boolean</span> <span class="hljs-variable">sizeChanged</span> <span class="hljs-operator">=</span> (newWidth != oldWidth) || (newHeight != oldHeight);<br>          <span class="hljs-comment">//需要重绘视图</span><br>            invalidate(sizeChanged);<br>      &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>



<blockquote>
<p><code>requestLayout()</code>主要执行了以下几步：</p>
<ul>
<li>添加<code>PFLAG_FORCE_LAYOUT</code>和<code>PFLAG_INVALIDATED</code>标记</li>
<li><code>measure</code>执行需要判断<code>PFLAG_FORCE_LAYOUT</code>标记是否存在</li>
<li><code>measure</code>执行后，添加<code>PFLAG_LAYOUT_REQUIRED</code>标记，可以去执行<code>onLayout()</code></li>
<li><code>layout</code>执行后，移除<code>PFLAG_LAYOUT_REQUIRED</code>和<code>PFLAG_FORCE_LAYOUT</code>标记</li>
<li>在<code>layout</code>过程中，如果位置发生了变化，会执行到<code>invalidate()</code>，可能会执行<code>draw</code>过程；如果未发生变化，就不会执行<code>draw</code>过程</li>
</ul>
</blockquote>
<h4 id="invalidate-postInvalidate"><a href="#invalidate-postInvalidate" class="headerlink" title="invalidate&#x2F;postInvalidate"></a>invalidate&#x2F;postInvalidate</h4><p><img src="/images/View%E5%B7%A5%E4%BD%9C%E5%8E%9F%E7%90%86-Invalidate.png" srcset="/img/loading.gif" lazyload alt="View工作原理-Invalidate"></p>
<blockquote>
<p><code>invalidate()</code>必须在主线程调用。<code>postInvalidate()</code>可以在子线程调用(通过handler发送消息到主线程调用)</p>
<p>主要用于请求View的重绘，只会影响到View的<code>draw</code>过程</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//View.java</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postInvalidate</span><span class="hljs-params">()</span> &#123;<br>        postInvalidateDelayed(<span class="hljs-number">0</span>);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">dispatchInvalidateDelayed</span><span class="hljs-params">(View view, <span class="hljs-type">long</span> delayMilliseconds)</span> &#123;<br>        <span class="hljs-type">Message</span> <span class="hljs-variable">msg</span> <span class="hljs-operator">=</span> mHandler.obtainMessage(MSG_INVALIDATE, view);<br>        mHandler.sendMessageDelayed(msg, delayMilliseconds);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(Message msg)</span> &#123;<br>            <span class="hljs-keyword">switch</span> (msg.what) &#123;<br>                <span class="hljs-keyword">case</span> MSG_INVALIDATE:<br>                    ((View) msg.obj).invalidate();<span class="hljs-comment">//继续执行到invalidate()</span><br>                    <span class="hljs-keyword">break</span>;<br>                ...<br>            &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invalidate</span><span class="hljs-params">()</span> &#123;<br>        invalidate(<span class="hljs-literal">true</span>);<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>最终执行到<code>invalidateInternal()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//View.java</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">invalidateInternal</span><span class="hljs-params">(<span class="hljs-type">int</span> l, <span class="hljs-type">int</span> t, <span class="hljs-type">int</span> r, <span class="hljs-type">int</span> b, <span class="hljs-type">boolean</span> invalidateCache,</span><br><span class="hljs-params">            <span class="hljs-type">boolean</span> fullInvalidate)</span> &#123;<br>        ...<br>        <span class="hljs-comment">//当前View不可见</span><br>        <span class="hljs-keyword">if</span> (skipInvalidate()) &#123;<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-keyword">if</span> ((mPrivateFlags &amp; (PFLAG_DRAWN | PFLAG_HAS_BOUNDS)) == (PFLAG_DRAWN | PFLAG_HAS_BOUNDS)<br>                || (invalidateCache &amp;&amp; (mPrivateFlags &amp; PFLAG_DRAWING_CACHE_VALID) == PFLAG_DRAWING_CACHE_VALID)<br>                || (mPrivateFlags &amp; PFLAG_INVALIDATED) != PFLAG_INVALIDATED<span class="hljs-comment">//当前没有执行invalidate</span><br>                || (fullInvalidate &amp;&amp; isOpaque() != mLastIsOpaque)) &#123;<br>          <span class="hljs-comment">//需要全量重绘</span><br>            <span class="hljs-keyword">if</span> (fullInvalidate) &#123;<br>                mLastIsOpaque = isOpaque();<br>              <span class="hljs-comment">//添加重绘标记</span><br>                mPrivateFlags &amp;= ~PFLAG_DRAWN;<br>            &#125;<br>           <span class="hljs-comment">//添加当前View重绘标记</span><br>            mPrivateFlags |= PFLAG_DIRTY;<br>           <span class="hljs-comment">//是否刷新缓存</span><br>            <span class="hljs-keyword">if</span> (invalidateCache) &#123;<br>                mPrivateFlags |= PFLAG_INVALIDATED;<br>                mPrivateFlags &amp;= ~PFLAG_DRAWING_CACHE_VALID;<br>            &#125;<br><br>            <span class="hljs-comment">// Propagate the damage rectangle to the parent view.</span><br>            <span class="hljs-keyword">final</span> <span class="hljs-type">AttachInfo</span> <span class="hljs-variable">ai</span> <span class="hljs-operator">=</span> mAttachInfo;<br>            <span class="hljs-keyword">final</span> <span class="hljs-type">ViewParent</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> mParent;<br>            <span class="hljs-keyword">if</span> (p != <span class="hljs-literal">null</span> &amp;&amp; ai != <span class="hljs-literal">null</span> &amp;&amp; l &lt; r &amp;&amp; t &lt; b) &#123;<br>                <span class="hljs-keyword">final</span> <span class="hljs-type">Rect</span> <span class="hljs-variable">damage</span> <span class="hljs-operator">=</span> ai.mTmpInvalRect;<br>                damage.set(l, t, r, b);<br>              <span class="hljs-comment">//设置重绘区域 并把自身传递到父布局</span><br>                p.invalidateChild(<span class="hljs-built_in">this</span>, damage);<br>            &#125;<br>          ...<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>上述代码修改标记完成后，调用父类的<code>invalidateChild()</code>将需要重绘的区域(<code>脏区域</code>)传入。(<code>ViewGroup以及ViewRootImpl都继承自ViewParent类</code>)</p>
<blockquote>
<p>脏区域：<em>为了保证绘制的效率，控件树仅对需要绘制的区域进行重绘，需要重绘的区域成为<code>脏区域</code></em>。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ViewGroup.java</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invalidateChild</span><span class="hljs-params">(View child, <span class="hljs-keyword">final</span> Rect dirty)</span> &#123;<br>      <span class="hljs-comment">//开启硬件加速</span><br>        <span class="hljs-keyword">if</span> (attachInfo != <span class="hljs-literal">null</span> &amp;&amp; attachInfo.mHardwareAccelerated) &#123;<br>            <span class="hljs-comment">// 更新DisplayList</span><br>            onDescendantInvalidated(child, child);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;      <br>         <span class="hljs-comment">//当前View是否 不透明</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">isOpaque</span> <span class="hljs-operator">=</span> child.isOpaque() &amp;&amp; !drawAnimation &amp;&amp;<br>                    child.getAnimation() == <span class="hljs-literal">null</span> &amp;&amp; childMatrix.isIdentity(); <br>        <span class="hljs-comment">//全不透明 标记为 PFLAG_DIRTY_OPAQUE</span><br>        <span class="hljs-comment">//部分透明 标记为 PFLAG_DIRTY</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">opaqueFlag</span> <span class="hljs-operator">=</span> isOpaque ? PFLAG_DIRTY_OPAQUE : PFLAG_DIRTY;<br>      ...<br>        <span class="hljs-keyword">do</span> &#123;<br>                <span class="hljs-type">View</span> <span class="hljs-variable">view</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>                <span class="hljs-keyword">if</span> (parent <span class="hljs-keyword">instanceof</span> View) &#123;<br>                    view = (View) parent;<br>                &#125;<br><br>                <span class="hljs-keyword">if</span> (drawAnimation) &#123;<br>                    <span class="hljs-keyword">if</span> (view != <span class="hljs-literal">null</span>) &#123;<br>                        view.mPrivateFlags |= PFLAG_DRAW_ANIMATION;<br>                    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (parent <span class="hljs-keyword">instanceof</span> ViewRootImpl) &#123;<br>                        ((ViewRootImpl) parent).mIsAnimating = <span class="hljs-literal">true</span>;<br>                    &#125;<br>                &#125;<br><br>                <span class="hljs-comment">// If the parent is dirty opaque or not dirty, mark it dirty with the opaque</span><br>                <span class="hljs-comment">// flag coming from the child that initiated the invalidate</span><br>                <span class="hljs-keyword">if</span> (view != <span class="hljs-literal">null</span>) &#123;<br>                    <span class="hljs-keyword">if</span> ((view.mViewFlags &amp; FADING_EDGE_MASK) != <span class="hljs-number">0</span> &amp;&amp;<br>                            view.getSolidColor() == <span class="hljs-number">0</span>) &#123;<br>                        opaqueFlag = PFLAG_DIRTY;<br>                    &#125;<br>                    <span class="hljs-keyword">if</span> ((view.mPrivateFlags &amp; PFLAG_DIRTY_MASK) != PFLAG_DIRTY) &#123;<br>                        view.mPrivateFlags = (view.mPrivateFlags &amp; ~PFLAG_DIRTY_MASK) | opaqueFlag;<br>                    &#125;<br>                &#125;<br>                <span class="hljs-comment">//递归调用父布局的重绘方法</span><br>                parent = parent.invalidateChildInParent(location, dirty);<br>                <span class="hljs-comment">//计算需要重绘区域</span><br>                dirty.set((<span class="hljs-type">int</span>) Math.floor(boundingRect.left),<br>                                (<span class="hljs-type">int</span>) Math.floor(boundingRect.top),<br>                                (<span class="hljs-type">int</span>) Math.ceil(boundingRect.right),<br>                                (<span class="hljs-type">int</span>) Math.ceil(boundingRect.bottom));                <br>          ...<br>            &#125; <span class="hljs-keyword">while</span> (parent != <span class="hljs-literal">null</span>);<br>      <br>    &#125;<br><br><span class="hljs-comment">//ViewGroup.java</span><br>    <span class="hljs-keyword">public</span> ViewParent <span class="hljs-title function_">invalidateChildInParent</span><span class="hljs-params">(<span class="hljs-keyword">final</span> <span class="hljs-type">int</span>[] location, <span class="hljs-keyword">final</span> Rect dirty)</span> &#123;<br>        <span class="hljs-keyword">if</span> ((mPrivateFlags &amp; (PFLAG_DRAWN | PFLAG_DRAWING_CACHE_VALID)) != <span class="hljs-number">0</span>) &#123;<br>          <span class="hljs-comment">//将子View转换为当前View显示的位置</span><br>          ...<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>当<code>parent==null</code>时，表示已经到了最顶层<code>ViewRootImpl</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ViewRootImpl.java</span><br>    <span class="hljs-keyword">public</span> ViewParent <span class="hljs-title function_">invalidateChildInParent</span><span class="hljs-params">(<span class="hljs-type">int</span>[] location, Rect dirty)</span> &#123;<br>      <span class="hljs-comment">//检查当前是否主线程</span><br>        checkThread();<br>        <span class="hljs-keyword">if</span> (DEBUG_DRAW) Log.v(mTag, <span class="hljs-string">&quot;Invalidate child: &quot;</span> + dirty);<br><br>        <span class="hljs-keyword">if</span> (dirty == <span class="hljs-literal">null</span>) &#123;<br>            invalidate();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (dirty.isEmpty() &amp;&amp; !mIsAnimating) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>       ...<br>      <span class="hljs-comment">//更新屏幕对应脏区域</span><br>        invalidateRectOnScreen(dirty);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">invalidateRectOnScreen</span><span class="hljs-params">(Rect dirty)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">Rect</span> <span class="hljs-variable">localDirty</span> <span class="hljs-operator">=</span> mDirty;<br>        <span class="hljs-keyword">if</span> (!localDirty.isEmpty() &amp;&amp; !localDirty.contains(dirty)) &#123;<br>            mAttachInfo.mSetIgnoreDirtyState = <span class="hljs-literal">true</span>;<br>            mAttachInfo.mIgnoreDirtyState = <span class="hljs-literal">true</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// Add the new dirty rect to the current one</span><br>        localDirty.union(dirty.left, dirty.top, dirty.right, dirty.bottom);<br>        <span class="hljs-comment">// Intersect with the bounds of the window to skip</span><br>        <span class="hljs-comment">// updates that lie outside of the visible region</span><br>        <span class="hljs-keyword">final</span> <span class="hljs-type">float</span> <span class="hljs-variable">appScale</span> <span class="hljs-operator">=</span> mAttachInfo.mApplicationScale;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">intersected</span> <span class="hljs-operator">=</span> localDirty.intersect(<span class="hljs-number">0</span>, <span class="hljs-number">0</span>,<br>                (<span class="hljs-type">int</span>) (mWidth * appScale + <span class="hljs-number">0.5f</span>), (<span class="hljs-type">int</span>) (mHeight * appScale + <span class="hljs-number">0.5f</span>));<br>        <span class="hljs-keyword">if</span> (!intersected) &#123;<br>            localDirty.setEmpty();<br>        &#125;<br>        <span class="hljs-keyword">if</span> (!mWillDrawSoon &amp;&amp; (intersected || mIsAnimating)) &#123;<br>          <span class="hljs-comment">//执行绘制流程</span><br>            scheduleTraversals();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>通过<code>scheduleTraversals()</code>执行绘制流程，由于未设置<code>mLayoutRequested = true</code>，所以无法进入<code>performMeasure()</code>和<code>performLayout()</code>只能执行到<code>performDraw()</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ViewRootImpl.java</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">performDraw</span><span class="hljs-params">()</span> &#123;<br>      ...<br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">canUseAsync</span> <span class="hljs-operator">=</span> draw(fullRedrawNeeded);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">draw</span><span class="hljs-params">(<span class="hljs-type">boolean</span> fullRedrawNeeded)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!dirty.isEmpty() || mIsAnimating || accessibilityFocusDirty) &#123;<br>            <span class="hljs-keyword">if</span> (mAttachInfo.mThreadedRenderer != <span class="hljs-literal">null</span> &amp;&amp; mAttachInfo.mThreadedRenderer.isEnabled()) &#123;<br>              <span class="hljs-comment">//硬件绘制</span><br>              ...<br>                mAttachInfo.mThreadedRenderer.draw(mView, mAttachInfo, <span class="hljs-built_in">this</span>, callback);              <br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>              <span class="hljs-comment">//软件绘制</span><br>              ...<br>              <span class="hljs-keyword">if</span> (!drawSoftware(surface, mAttachInfo, xOffset, yOffset,<br>                        scalingRequired, dirty, surfaceInsets)) &#123;<br>                    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>                &#125;<br>            &#125;<br>          ...<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>向下调用到<code>View.draw()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//View.java</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">draw</span><span class="hljs-params">(Canvas canvas)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">boolean</span> <span class="hljs-variable">dirtyOpaque</span> <span class="hljs-operator">=</span> (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp;<br>                (mAttachInfo == <span class="hljs-literal">null</span> || !mAttachInfo.mIgnoreDirtyState);<br>        <span class="hljs-keyword">if</span> (!dirtyOpaque) &#123;<br>            drawBackground(canvas);<span class="hljs-comment">//绘制背景</span><br>        &#125;<br>        <span class="hljs-keyword">if</span> (!dirtyOpaque) onDraw(canvas);<span class="hljs-comment">//绘制自身</span><br>        dispatchDraw(canvas); <span class="hljs-comment">//绘制子View </span><br>        onDrawForeground(canvas);<span class="hljs-comment">//绘制前景</span><br>    &#125;<br></code></pre></td></tr></table></figure>

<p>关键在于是否持有<code>PFLAG_DIRTY_OPAQUE</code>标志，这个标志主要是在<code>invalidate()</code>打上的。</p>
<blockquote>
<p><code>invalidate()</code>会设置当前脏区与相关标记，然后执行<code>invalidateChild()</code>，通过层层向上调用<code>parent.invalidateChildInParent()</code>把需要重新绘制的区域传递上去，直到达到<code>ViewRootImpl</code>。最后调用<code>invalidateRectOnScreen()</code>传入最终脏区，开始执行绘制流程。</p>
<p><strong>核心是把重绘请求上传到<code>ViewRootImpl</code>并触发下一帧<code>draw</code>，是否走<code>onDraw()</code>还受透明度、背景与具体脏区状态影响。</strong></p>
</blockquote>
<h4 id="两者区别"><a href="#两者区别" class="headerlink" title="两者区别"></a>两者区别</h4><p><code>requestLayout()</code>和<code>invalidate()</code>都可以触发整个绘制流程，但是触发<code>measure</code>、<code>layout</code>、<code>draw</code>各条件都不同</p>
<ul>
<li><code>measure</code>过程触发：<code>mPrivateFlags</code>包含<code>PFLAG_FORCE_LAYOUT</code></li>
<li><code>layout</code>过程触发：<code>mPrivateFlags</code>包含<code>PFLAG_LAYOUT_REQUIRED(measure执行后添加)</code>或者<code>位置发生变化</code></li>
<li><code>draw</code>过程触发：存在脏区（<code>dirty</code>）或动画等需要重绘的条件</li>
</ul>
<p><code>requestLayout()</code>主要用来设置<code>PFLAG_FORCE_LAYOUT</code>标志以及设置<code>mLayoutRequested=true</code>，会执行到<code>measure、layout</code>过程，如果位置发生变化则可能执行<code>draw</code>过程。</p>
<p><code>invalidate()</code>主要用于标记脏区并上报到<code>ViewRootImpl</code>，在下一次<code>performTraversal()</code>中进入<code>performDraw()</code>完成绘制。</p>
<p><img src="/images/View%E9%87%8D%E7%BB%98.png" srcset="/img/loading.gif" lazyload alt="区别"></p>
<h4 id="同时调用"><a href="#同时调用" class="headerlink" title="同时调用"></a>同时调用</h4><blockquote>
<p>在某些情况下，需要<code>requestLayout</code>和<code>invalidate</code>配合使用，得到最终的结果。</p>
</blockquote>
<p>拿<code>TextView</code>举例：</p>
<p><img src="/images/TextView.setText.png" srcset="/img/loading.gif" lazyload alt="TextView.setText()"></p>
<p>当<code>TextView</code>执行<code>setText()</code>后，TextView可能布局发生改变，也可能需要进行重绘。需要区分不同情况实现对应功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//TextView.java</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setText</span><span class="hljs-params">(CharSequence text, //文本</span><br><span class="hljs-params">                         BufferType type, //缓存类型 NORMAL 默认样式 SPANNABLE 自定义样式 EDITABLE 可以追加字符</span><br><span class="hljs-params">                         <span class="hljs-type">boolean</span> notifyBefore, //是否通知之前</span><br><span class="hljs-params">                         <span class="hljs-type">int</span> oldlen //旧文本长度</span><br><span class="hljs-params">)</span> &#123;<br>      ...<br>        <span class="hljs-keyword">if</span> (mLayout != <span class="hljs-literal">null</span>) &#123;<br>            checkForRelayout();<br>        &#125;<br>      ...<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">checkForRelayout</span><span class="hljs-params">()</span> &#123;<br>      <span class="hljs-comment">//TextView的宽度以及高度固定不变</span><br>        <span class="hljs-keyword">if</span> ((mLayoutParams.width != LayoutParams.WRAP_CONTENT<span class="hljs-comment">//宽度固定</span><br>                || (mMaxWidthMode == mMinWidthMode &amp;&amp; mMaxWidth == mMinWidth))<br>                &amp;&amp; (mHint == <span class="hljs-literal">null</span> || mHintLayout != <span class="hljs-literal">null</span>)<br>                &amp;&amp; (mRight - mLeft - getCompoundPaddingLeft() - getCompoundPaddingRight() &gt; <span class="hljs-number">0</span>)) &#123;<br>            <span class="hljs-comment">// Static width, so try making a new text layout.</span><br><br>            <span class="hljs-type">int</span> <span class="hljs-variable">oldht</span> <span class="hljs-operator">=</span> mLayout.getHeight();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">want</span> <span class="hljs-operator">=</span> mLayout.getWidth();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">hintWant</span> <span class="hljs-operator">=</span> mHintLayout == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> : mHintLayout.getWidth();<br><br>            <span class="hljs-comment">/*</span><br><span class="hljs-comment">             * No need to bring the text into view, since the size is not</span><br><span class="hljs-comment">             * changing (unless we do the requestLayout(), in which case it</span><br><span class="hljs-comment">             * will happen at measure).</span><br><span class="hljs-comment">             */</span><br>            makeNewLayout(want, hintWant, UNKNOWN_BORING, UNKNOWN_BORING,<br>                          mRight - mLeft - getCompoundPaddingLeft() - getCompoundPaddingRight(),<br>                          <span class="hljs-literal">false</span>);<br><br>          <span class="hljs-comment">//非跑马灯格式</span><br>            <span class="hljs-keyword">if</span> (mEllipsize != TextUtils.TruncateAt.MARQUEE) &#123;<br>                <span class="hljs-comment">// In a fixed-height view, so use our new text layout.</span><br>                <span class="hljs-keyword">if</span> (mLayoutParams.height != LayoutParams.WRAP_CONTENT <br>                        &amp;&amp; mLayoutParams.height != LayoutParams.MATCH_PARENT) &#123;<span class="hljs-comment">//高度为&gt;0的值</span><br>                    autoSizeText();<br>                    invalidate();<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br><br>                <span class="hljs-comment">// 除非主动设置高度，否则高度与行数相关，不会为0</span><br>                <span class="hljs-keyword">if</span> (mLayout.getHeight() == oldht<br>                        &amp;&amp; (mHintLayout == <span class="hljs-literal">null</span> || mHintLayout.getHeight() == oldht)) &#123;<span class="hljs-comment">//高度没有发生变化</span><br>                    autoSizeText();<br>                    invalidate();<br>                    <span class="hljs-keyword">return</span>;<br>                &#125;<br>            &#125;<br><br>            <span class="hljs-comment">// We lose: the height has changed and we have a dynamic height.</span><br>            <span class="hljs-comment">// Request a new view layout using our new text layout.</span><br>            requestLayout();<br>            invalidate();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-comment">// Dynamic width, so we have no choice but to request a new</span><br>            <span class="hljs-comment">// view layout with a new text layout.</span><br>            nullLayouts();<br>            requestLayout();<br>            invalidate();<br>        &#125;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p>根据上述源码分析：</p>
<blockquote>
<p><code>TextView.setText()</code>根据不同的情况会执行不同的重绘方法：</p>
<ul>
<li><code>width!=wrap_content</code><ul>
<li>非跑马灯格式(<code>mEllipsize!=MARQUEE</code>) &amp;&amp; (<code>height &gt; 0</code> || <code>height == oldht/*高度没有变化*/</code>)：执行<code>invalidate()</code></li>
<li>others：执行<code>requestLayout()</code>和<code>invalidate()</code></li>
</ul>
</li>
<li><code>width=wrap_content</code>：需要执行<code>requestLayout()</code>和<code>invalidate()</code></li>
</ul>
</blockquote>
<h4 id="拓展-2"><a href="#拓展-2" class="headerlink" title="拓展"></a>拓展</h4><h5 id="forceLayout"><a href="#forceLayout" class="headerlink" title="forceLayout()"></a>forceLayout()</h5><blockquote>
<p>标记当前View需要重新执行<code>测量-布局-绘制</code>流程。一般父ViewGroup调用<code>requestLayout()</code>，子View不会触发整套流程。</p>
<p>调用后，子View也可以执行整套流程。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//View.java   </span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">forceLayout</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">if</span> (mMeasureCache != <span class="hljs-literal">null</span>) mMeasureCache.clear();<br><br>        mPrivateFlags |= PFLAG_FORCE_LAYOUT;<span class="hljs-comment">//标记 执行measure</span><br>        mPrivateFlags |= PFLAG_INVALIDATED;<br>    &#125;<br></code></pre></td></tr></table></figure>

<p><code>forceLayout</code>若要生效，需要<code>直系父View</code>调用<code>requestLayout</code>。</p>
<h3 id="include、merge、ViewStub作用以及实现"><a href="#include、merge、ViewStub作用以及实现" class="headerlink" title="include、merge、ViewStub作用以及实现"></a>include、merge、ViewStub作用以及实现</h3><a href="/2019/01/03/include%E3%80%81merge-ViewStub%E7%9B%B8%E5%85%B3/" title="include、merge及ViewStub相关">include、merge及ViewStub相关</a>

<h3 id="View的层级计算"><a href="#View的层级计算" class="headerlink" title="View的层级计算"></a>View的层级计算</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//实际形成一个二叉树 递归计算深度    </span><br><span class="hljs-keyword">private</span> <span class="hljs-type">int</span> <span class="hljs-title function_">maxViewDeep</span><span class="hljs-params">(View view)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!(view <span class="hljs-keyword">instanceof</span> ViewGroup)) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-type">ViewGroup</span> <span class="hljs-variable">vp</span> <span class="hljs-operator">=</span> (ViewGroup) view;<br>        <span class="hljs-keyword">if</span> (vp.getChildCount() == <span class="hljs-number">0</span>) &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>        &#125;<br><br>        <span class="hljs-type">int</span> <span class="hljs-variable">max</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> vp.getChildCount();<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; count; i++) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">deep</span> <span class="hljs-operator">=</span> maxViewDeep(vp.getChildAt(i)) + <span class="hljs-number">1</span>;<br>            <span class="hljs-keyword">if</span> (deep &gt; max) &#123;<br>                max = deep;<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> max;<br>    &#125;<br></code></pre></td></tr></table></figure>



<h3 id="AsyncLayoutInflater异步加载"><a href="#AsyncLayoutInflater异步加载" class="headerlink" title="AsyncLayoutInflater异步加载"></a>AsyncLayoutInflater异步加载</h3><a href="/2020/11/02/Android-%E5%B8%83%E5%B1%80%E4%BC%98%E5%8C%96-AsyncLayoutInflater%E7%AE%80%E6%9E%90/" title="Android布局优化-AsyncLayoutInflater简析">AsyncLayoutInflater</a>

<h3 id="inflate-时，root与attachToRoot的结果源码"><a href="#inflate-时，root与attachToRoot的结果源码" class="headerlink" title="inflate()时，root与attachToRoot的结果源码"></a>inflate()时，<code>root</code>与<code>attachToRoot</code>的结果源码</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//LayoutInflater.java</span><br>    <span class="hljs-keyword">public</span> View <span class="hljs-title function_">inflate</span><span class="hljs-params">(XmlPullParser parser, <span class="hljs-meta">@Nullable</span> ViewGroup root, <span class="hljs-type">boolean</span> attachToRoot)</span> &#123;<br>            <span class="hljs-type">View</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> root;<br>      <br>                    <span class="hljs-keyword">if</span> (root != <span class="hljs-literal">null</span>) &#123;<br>                        <span class="hljs-comment">// Create layout params that match root, if supplied</span><br>                        params = root.generateLayoutParams(attrs);<br>                        <span class="hljs-keyword">if</span> (!attachToRoot) &#123;<br>                            <span class="hljs-comment">// Set the layout params for temp if we are not</span><br>                            <span class="hljs-comment">// attaching. (If we are, we use addView, below)</span><br>                            temp.setLayoutParams(params);<br>                        &#125;<br>                    &#125;      <br>                    <span class="hljs-comment">// We are supposed to attach all the views we found (int temp)</span><br>                    <span class="hljs-comment">// to root. Do that now.</span><br>                    <span class="hljs-keyword">if</span> (root != <span class="hljs-literal">null</span> &amp;&amp; attachToRoot) &#123;<br>                        <span class="hljs-comment">//将temp添加到rootView中</span><br>                        root.addView(temp, params);<br>                    &#125;<br><br>                    <span class="hljs-comment">// Decide whether to return the root that was passed in or the</span><br>                    <span class="hljs-comment">// top view found in xml.</span><br>                    <span class="hljs-keyword">if</span> (root == <span class="hljs-literal">null</span> || !attachToRoot) &#123;<br>                        <span class="hljs-comment">//attachToRoot：将View添加到RootView中，非就是直接返回解析的子View</span><br>                        result = temp;<br>                    &#125;      <br>      <span class="hljs-keyword">return</span> result;<br>    &#125;<br><br></code></pre></td></tr></table></figure>



<p>根据源码分析到，<code>root</code>与<code>attachToRoot</code>会对<code>inflate()</code>结果产生影响，且实现代码会有差异。</p>
<table>
<thead>
<tr>
<th><code>root</code>与<code>attachToRoot</code>参数</th>
<th>表现</th>
<th><code>inflate()</code>返回结果</th>
</tr>
</thead>
<tbody><tr>
<td><code>root == null &amp;&amp; attachToRoot == false/true</code></td>
<td>直接显示<code>source</code>加载的结果，而且设置的<code>宽高属性</code>也会失效</td>
<td><code>source</code>加载后的<code>View实例</code></td>
</tr>
<tr>
<td><code>root != null &amp;&amp; attachToRoot == false</code></td>
<td>直接显示<code>source</code>加载的结果，且设置的<code>宽高属性</code>保持</td>
<td><code>source</code>加载后的<code>View实例</code></td>
</tr>
<tr>
<td><code>root != null &amp;&amp; attachToRoot == true</code></td>
<td>直接显示<code>root</code>并且<code>source</code>已被<code>add</code>进去且设置的<code>宽高属性</code>保持</td>
<td><code>root</code></td>
</tr>
</tbody></table>
<p><strong><code>root</code>不为null，无论<code>attachToRoot</code>，都会保持需要加载布局的宽高属性。<code>root</code>为null，无论<code>attachToRoot</code>，都不会持有原有的宽高属性。</strong></p>
<h3 id="MeasureSpec-UNSPECIFIED使用场景"><a href="#MeasureSpec-UNSPECIFIED使用场景" class="headerlink" title="MeasureSpec.UNSPECIFIED使用场景"></a><code>MeasureSpec.UNSPECIFIED</code>使用场景</h3><blockquote>
<p><code>UNSPECIFIED</code>就是未指定的意思，在这个模式下 父控件不会干涉子控件的尺寸。</p>
<p><strong>一般用于支持滚动的布局中，例如<code>ScrollView</code>、<code>RecyclerView</code>中。</strong></p>
<p>在可滚动的<code>ViewGroup</code>中，不应该限制子View的尺寸。有可能子View会超出父布局的尺寸，在<code>AT_MOST/EXACTLY</code>都会对子View的尺寸进行限制。</p>
</blockquote>
<p>拿<code>ScrollView</code>举例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//ScrollView.java</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">measureChild</span><span class="hljs-params">(View child, <span class="hljs-type">int</span> parentWidthMeasureSpec,</span><br><span class="hljs-params">            <span class="hljs-type">int</span> parentHeightMeasureSpec)</span> &#123;<br>        ViewGroup.<span class="hljs-type">LayoutParams</span> <span class="hljs-variable">lp</span> <span class="hljs-operator">=</span> child.getLayoutParams();<br><br>        <span class="hljs-type">int</span> childWidthMeasureSpec;<br>        <span class="hljs-type">int</span> childHeightMeasureSpec;<br><br>        childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec, mPaddingLeft<br>                + mPaddingRight, lp.width);<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">verticalPadding</span> <span class="hljs-operator">=</span> mPaddingTop + mPaddingBottom;<br>      <span class="hljs-comment">//强制设置子View的测量模式为`UNSPECIFIED`</span><br>        childHeightMeasureSpec = MeasureSpec.makeSafeMeasureSpec(<br>                Math.max(<span class="hljs-number">0</span>, MeasureSpec.getSize(parentHeightMeasureSpec) - verticalPadding),<br>                MeasureSpec.UNSPECIFIED);<br><br>        child.measure(childWidthMeasureSpec, childHeightMeasureSpec);<br>    &#125;<br></code></pre></td></tr></table></figure>

<h2 id="知识点补全"><a href="#知识点补全" class="headerlink" title="知识点补全"></a>知识点补全</h2><h3 id="Traversal调度与Vsync关系"><a href="#Traversal调度与Vsync关系" class="headerlink" title="Traversal调度与Vsync关系"></a>Traversal调度与Vsync关系</h3><ul>
<li><code>requestLayout()</code>和<code>invalidate()</code>最终都会走到<code>scheduleTraversals()</code>，由<code>Choreographer</code>在下一帧调度<code>performTraversals()</code>。</li>
<li><code>scheduleTraversals()</code>会先插入同步屏障，再通过<code>CALLBACK_TRAVERSAL</code>回调执行<code>doTraversal()</code>；执行前会移除同步屏障。</li>
<li>这也是“频繁调用多次requestLayout&#x2F;invalidate，通常合并到下一帧处理”的根本原因。</li>
</ul>
<h3 id="三大流程的职责边界"><a href="#三大流程的职责边界" class="headerlink" title="三大流程的职责边界"></a>三大流程的职责边界</h3><ul>
<li><code>measure</code>：确定“要多大”（<code>measuredWidth/measuredHeight</code>）。</li>
<li><code>layout</code>：确定“放哪里”（<code>left/top/right/bottom</code>）。</li>
<li><code>draw</code>：确定“画什么”。</li>
</ul>
<p><code>getMeasuredWidth/Height</code>不等于<code>getWidth/Height</code>的常见场景：父容器二次布局、动画&#x2F;手动改<code>layout()</code>边界、自定义容器重新定位子View。</p>
<h3 id="自定义View测量建议"><a href="#自定义View测量建议" class="headerlink" title="自定义View测量建议"></a>自定义View测量建议</h3><p>直接继承<code>View</code>时，建议在<code>onMeasure()</code>里显式处理<code>AT_MOST</code>，并用系统工具方法收敛结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">onMeasure</span><span class="hljs-params">(<span class="hljs-type">int</span> widthMeasureSpec, <span class="hljs-type">int</span> heightMeasureSpec)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">desiredW</span> <span class="hljs-operator">=</span> mWidth;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">desiredH</span> <span class="hljs-operator">=</span> mHeight;<br><br>    <span class="hljs-type">int</span> <span class="hljs-variable">measuredW</span> <span class="hljs-operator">=</span> resolveSize(desiredW, widthMeasureSpec);<br>    <span class="hljs-type">int</span> <span class="hljs-variable">measuredH</span> <span class="hljs-operator">=</span> resolveSize(desiredH, heightMeasureSpec);<br>    setMeasuredDimension(measuredW, measuredH);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>这样既能支持<code>wrap_content</code>，也能在父容器约束下保持稳定行为。</p>
<h3 id="requestLayout与invalidate选择"><a href="#requestLayout与invalidate选择" class="headerlink" title="requestLayout与invalidate选择"></a>requestLayout与invalidate选择</h3><ul>
<li>内容变化但尺寸不变：优先<code>invalidate()</code>（只触发draw）。</li>
<li>尺寸或位置可能变化：用<code>requestLayout()</code>（会触发measure&#x2F;layout，必要时再draw）。</li>
<li>子线程触发重绘：使用<code>postInvalidate()</code>或切回主线程调用<code>invalidate()</code>。</li>
</ul>
<p>简单记忆：<strong>改形状&#x2F;尺寸走<code>requestLayout</code>，改像素内容走<code>invalidate</code>。</strong></p>
<h3 id="onDraw性能实践"><a href="#onDraw性能实践" class="headerlink" title="onDraw性能实践"></a>onDraw性能实践</h3><ul>
<li>避免在<code>onDraw()</code>里频繁创建对象（<code>Paint/Path/Rect</code>），改为成员变量复用。</li>
<li>尺寸相关的计算尽量放在<code>onSizeChanged()</code>，减少每帧重复计算。</li>
<li>大量重绘场景优先局部刷新（脏区），避免无意义全量刷新。</li>
</ul>
<h3 id="inflate参数实战建议"><a href="#inflate参数实战建议" class="headerlink" title="inflate参数实战建议"></a>inflate参数实战建议</h3><ul>
<li><code>RecyclerView.Adapter</code>中通常使用<code>inflate(layout, parent, false)</code>：拿到正确<code>LayoutParams</code>，但不立刻attach。</li>
<li><code>Activity/Fragment</code>初始化根布局时，不要随意传<code>root = null</code>，否则可能丢失父容器相关布局参数语义。</li>
</ul>
<h3 id="线程与生命周期补充"><a href="#线程与生命周期补充" class="headerlink" title="线程与生命周期补充"></a>线程与生命周期补充</h3><ul>
<li>View树的measure&#x2F;layout&#x2F;draw都在主线程，<code>ViewRootImpl.checkThread()</code>会对非法线程调用直接抛异常。</li>
<li>自定义View里若有动画、线程或回调，建议在<code>onAttachedToWindow()</code>启动，在<code>onDetachedFromWindow()</code>停止，避免泄漏和后台无效工作。</li>
</ul>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Android/" class="print-no-link">#Android</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>View的工作原理</div>
      <div>https://leo-wxy.github.io/2018/12/14/View的工作原理/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Leo-Wxy</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2018年12月14日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2018/12/17/%E5%AE%9E%E7%8E%B0%E8%87%AA%E5%AE%9A%E4%B9%89%E5%9B%BE%E7%89%87%E5%8A%A0%E8%BD%BD%E6%A1%86%E6%9E%B6/" title="实现自定义图片加载框架">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">实现自定义图片加载框架</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2018/12/14/Java-%E5%8F%8D%E5%B0%84/" title="Java - 反射">
                        <span class="hidden-mobile">Java - 反射</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>





  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
