

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="description" content="如果我没有见过光明，那我本可以忍受黑暗">
  <meta name="author" content="Leo-Wxy">
  <meta name="keywords" content>
  <meta name="description" content="Transform API存在于AGP中，存在版本为4.2-7.0+，后续在8.0时就会被移除。 Transform AGP 1.5引入的特性，主要用于在构建过程中，在Class-&amp;gt;Dex修改Class字节码，通过Transform可以获得Class文件。 再通过Javassist或ASM对字节码进行修改，插入自定义逻辑。  AGP插件版本说明 后面的分析基于以下版本：  AGP：7.2.1">
<meta name="keywords" content="Gradle">
<meta property="og:type" content="article">
<meta property="og:title" content="Gradle学习笔记-Transform &amp; TransformAction">
<meta property="og:url" content="https://leo-wxy.github.io/2022/03/10/Gradle学习笔记-Transform/index.html">
<meta property="og:site_name" content="Wxy的个人博客">
<meta property="og:description" content="Transform API存在于AGP中，存在版本为4.2-7.0+，后续在8.0时就会被移除。 Transform AGP 1.5引入的特性，主要用于在构建过程中，在Class-&amp;gt;Dex修改Class字节码，通过Transform可以获得Class文件。 再通过Javassist或ASM对字节码进行修改，插入自定义逻辑。  AGP插件版本说明 后面的分析基于以下版本：  AGP：7.2.1">
<meta property="og:locale" content="zh-CN">
<meta property="og:updated_time" content="2022-09-12T08:19:11.510Z">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="Gradle学习笔记-Transform &amp; TransformAction">
<meta name="twitter:description" content="Transform API存在于AGP中，存在版本为4.2-7.0+，后续在8.0时就会被移除。 Transform AGP 1.5引入的特性，主要用于在构建过程中，在Class-&amp;gt;Dex修改Class字节码，通过Transform可以获得Class文件。 再通过Javassist或ASM对字节码进行修改，插入自定义逻辑。  AGP插件版本说明 后面的分析基于以下版本：  AGP：7.2.1">
  
  <title>Gradle学习笔记-Transform &amp; TransformAction - Wxy的个人博客</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">


  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css">
  <link rel="stylesheet" href="/lib/hint/hint.min.css">

  
    
    
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/atom-one-light.min.css">
    
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">
  


<!-- 主题依赖的图标库，不要自行修改 -->
<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">

<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">

<link rel="stylesheet" href="/css/main.css">

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"leo-wxy.github.io","root":"/","version":"1.8.12","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"always","icon":"#"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname"}},"search_path":"/local-search.xml"};
  </script>
  <script src="/js/utils.js"></script>
  <script src="/js/color-schema.js"></script>
</head>


<body>
  <header style="height: 30vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Wxy&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              &nbsp;<i class="iconfont icon-search"></i>&nbsp;
            </a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Gradle学习笔记-Transform &amp; TransformAction">
              
                Gradle学习笔记-Transform & TransformAction
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2022-03-10 21:54" pubdate>
        2022年3月10日 晚上
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      39k 字
    </span>
  

  
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      120 分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Gradle学习笔记-Transform &amp; TransformAction</h1>
            
            <div class="markdown-body">
              <p><code>Transform API</code>存在于<code>AGP</code>中，存在版本为<code>4.2-7.0+</code>，后续在8.0时就会被移除。</p>
<h2 id="Transform"><a href="#Transform" class="headerlink" title="Transform"></a>Transform</h2><blockquote>
<p><code>AGP 1.5</code>引入的特性，<strong>主要用于在构建过程中，在<code>Class-&gt;Dex</code>修改Class字节码，通过Transform可以获得Class文件。</strong></p>
<p>再通过<code>Javassist</code>或<code>ASM</code>对字节码进行修改，插入自定义逻辑。</p>
</blockquote>
<p><a href="https://developer.android.com/studio/releases/gradle-plugin?hl=zh-cn#groovy" target="_blank" rel="noopener">AGP插件版本说明</a></p>
<p>后面的分析基于以下版本：</p>
<ul>
<li>AGP：<a href="https://android.googlesource.com/platform/tools/base/+/studio-master-dev/build-system/README.md" target="_blank" rel="noopener">7.2.1</a> 本次采用依赖 “com.android.tools.build:gradle:7.2.1”来分析</li>
<li>Gradle：<a href="https://github.com/gradle/gradle/tree/v7.3.3" target="_blank" rel="noopener">7.3.3 </a></li>
</ul>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ul>
<li><strong>埋点统计</strong>：在页面展现和退出等生命周期中插入埋点统计代码，以统计页面展现数据</li>
<li><strong>耗时监控</strong>：在指定方法的前后插入耗时计算，以观察方法执行时间</li>
<li><strong>方法替换</strong>：将方法调用替换为调用另一个方法 </li>
<li>信息读取：解析编译产生的.class文件，得到一些有用的数据，做其他操作</li>
</ul>
<h3 id="工作机制"><a href="#工作机制" class="headerlink" title="工作机制"></a>工作机制</h3><blockquote>
<p>使用<code>Transform</code>无需关注相关task的生成与执行，主要在于处理输入的<code>资源文件</code></p>
</blockquote>
<h4 id="工作时机"><a href="#工作时机" class="headerlink" title="工作时机"></a>工作时机</h4><p>工作在Android构建过程中的<code>.class Files -&gt; Dex</code>节点</p>
<h4 id="处理对象"><a href="#处理对象" class="headerlink" title="处理对象"></a>处理对象</h4><ul>
<li>javac 编译后的Class文件</li>
<li>resource资源</li>
<li>本地/远程依赖的jar/aar文件</li>
</ul>
<h4 id="Transform-Task"><a href="#Transform-Task" class="headerlink" title="Transform Task"></a>Transform Task</h4><p>每个Transform都对应一个Task，对应名称为 <code>transform${inputTypes}With${TransformName}For${Variant}</code>，例如<code>transformClassesWithMethodTraceForRelease</code></p>
<p><em>Transform 内的输入输出实际对应的就是Task 的输入输出。</em></p>
<p>最后<code>Transform</code>输出的内容都会存储在<code>${moduleName}/build/intermediates/transforms/${TransformName}/${Variant}</code>，例如<code>app/build/intermediates/transforms/MethodTrace/release</code></p>
<h4 id="Transform链"><a href="#Transform链" class="headerlink" title="Transform链"></a>Transform链</h4><p><code>TaskManager</code>将每个<code>Transform Task</code>串连起来，前一个的输出会做为下一个的输入信息。</p>
<h3 id="相关API"><a href="#相关API" class="headerlink" title="相关API"></a>相关API</h3><p>以下为Transform中的核心方法</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TestTransform</span> : <span class="hljs-type">Transform</span></span>() &#123;<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getName</span><span class="hljs-params">()</span></span>: String &#123;<br>        TODO(<span class="hljs-string">"Not yet implemented"</span>)<br>    &#125;<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInputTypes</span><span class="hljs-params">()</span></span>: MutableSet&lt;QualifiedContent.ContentType&gt; &#123;<br>        TODO(<span class="hljs-string">"Not yet implemented"</span>)<br>    &#125;<br> <br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getOutputTypes</span><span class="hljs-params">()</span></span>: MutableSet&lt;QualifiedContent.ContentType&gt; &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-keyword">super</span>.getOutputTypes()<br>    &#125;<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getScopes</span><span class="hljs-params">()</span></span>: MutableSet&lt;<span class="hljs-keyword">in</span> QualifiedContent.Scope&gt; &#123;<br>        TODO(<span class="hljs-string">"Not yet implemented"</span>)<br>    &#125;<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isIncremental</span><span class="hljs-params">()</span></span>: <span class="hljs-built_in">Boolean</span> &#123;<br>        TODO(<span class="hljs-string">"Not yet implemented"</span>)<br>    &#125;<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">transform</span><span class="hljs-params">(transformInvocation: <span class="hljs-type">TransformInvocation</span>?)</span></span> &#123;<br>        <span class="hljs-keyword">super</span>.transform(transformInvocation)<br>    &#125;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="getName"><a href="#getName" class="headerlink" title="getName"></a>getName</h4><blockquote>
<p>指定<code>Transform</code>名称，后续也是对应的Task名称</p>
<p>Task命名规则为：<strong>transform${inputTypes}With${TransformName}For${Variant}</strong></p>
</blockquote>
<h4 id="getInputTypes-getOutputTypes"><a href="#getInputTypes-getOutputTypes" class="headerlink" title="getInputTypes/getOutputTypes"></a>getInputTypes/getOutputTypes</h4><blockquote>
<p>指定<code>Transform</code>输入/输出类型，对象为<code>ContentType</code>。</p>
<p>其中<code>getOutputTypes</code>默认与<code>getInputTypes</code>一致</p>
</blockquote>
<h5 id="ContentType——内容类型"><a href="#ContentType——内容类型" class="headerlink" title="ContentType——内容类型"></a>ContentType——内容类型</h5><blockquote>
<p>输入或输出的内容类型。</p>
</blockquote>
<h6 id="DefaultContentType-自定义时使用"><a href="#DefaultContentType-自定义时使用" class="headerlink" title="* DefaultContentType(自定义时使用)"></a>* DefaultContentType(自定义时使用)</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">enum</span> DefaultContentType implements ContentType &#123;<br>        <span class="hljs-comment">/**<br>         * The content is compiled Java code. This can be in a Jar file or in a folder. If<br>         * in a folder, it is expected to in sub-folders matching package names.<br>         */</span><br>        CLASSES(<span class="hljs-number">0x01</span>),<br><br>        <span class="hljs-comment">/** The content is standard Java resources. */</span><br>        RESOURCES(<span class="hljs-number">0x02</span>);<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li><strong>CLASSES</strong>：Java字节码，包括Jar文件</li>
<li><strong>RESOURCES</strong>：Java资源文件</li>
</ul>
<h6 id="ExtendedContentType-内部Transform使用"><a href="#ExtendedContentType-内部Transform使用" class="headerlink" title="ExtendedContentType(内部Transform使用)"></a>ExtendedContentType(内部Transform使用)</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> ExtendedContentType implements ContentType &#123;<br>    <span class="hljs-comment">/**<br>     * The content is dex files.<br>     */</span><br>    DEX(<span class="hljs-number">0x1000</span>),<br><br>    <span class="hljs-comment">/**<br>     * Content is a native library.<br>     */</span><br>    NATIVE_LIBS(<span class="hljs-number">0x2000</span>),<br><br>    <span class="hljs-comment">/**<br>     * Instant Run '$override' classes, which contain code of new method bodies.<br>     *<br>     * &lt;p&gt;This stream also contains the AbstractPatchesLoaderImpl class for applying HotSwap<br>     * changes.<br>     */</span><br>    CLASSES_ENHANCED(<span class="hljs-number">0x4000</span>),<br><br>    <span class="hljs-comment">/**<br>     * The content is an artifact exported by the data binding compiler.<br>     */</span><br>    DATA_BINDING(<span class="hljs-number">0x10000</span>),<br><br><br>    <span class="hljs-comment">/** The content is a dex archive. It contains a single DEX file per class. */</span><br>    DEX_ARCHIVE(<span class="hljs-number">0x40000</span>)<br>  <br>&#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>通常使用<code>TransformManager</code>设置类型</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Set&lt;ContentType&gt; CONTENT_CLASS = ImmutableSet.of(CLASSES);<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Set&lt;ContentType&gt; CONTENT_JARS = ImmutableSet.of(CLASSES, RESOURCES);<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Set&lt;ContentType&gt; CONTENT_RESOURCES = ImmutableSet.of(RESOURCES);<br></code></pre></td></tr></table></figure>
<h5 id="示例代码"><a href="#示例代码" class="headerlink" title="示例代码"></a>示例代码</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInputTypes</span><span class="hljs-params">()</span></span>: MutableSet&lt;QualifiedContent.ContentType&gt; &#123;<br>    <span class="hljs-keyword">return</span> TransformManager.CONTENT_CLASS<br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="getScopes"><a href="#getScopes" class="headerlink" title="getScopes"></a>getScopes</h4><blockquote>
<p>指定<code>Transform</code>处理哪些作用域的输入文件</p>
</blockquote>
<h5 id="Scope——处理范围"><a href="#Scope——处理范围" class="headerlink" title="Scope——处理范围"></a>Scope——处理范围</h5><h6 id="Scope-自定义时使用"><a href="#Scope-自定义时使用" class="headerlink" title="* Scope(自定义时使用)"></a>* Scope(自定义时使用)</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">enum</span> Scope implements ScopeType &#123;<br>    <span class="hljs-comment">/** Only the project (module) content */</span><br>    PROJECT(<span class="hljs-number">0x01</span>),<br>    <span class="hljs-comment">/** Only the sub-projects (other modules) */</span><br>    SUB_PROJECTS(<span class="hljs-number">0x04</span>),<br>    <span class="hljs-comment">/** Only the external libraries */</span><br>    EXTERNAL_LIBRARIES(<span class="hljs-number">0x10</span>),<br>    <span class="hljs-comment">/** Code that is being tested by the current variant, including dependencies */</span><br>    TESTED_CODE(<span class="hljs-number">0x20</span>),<br>    <span class="hljs-comment">/** Local or remote dependencies that are provided-only */</span><br>    PROVIDED_ONLY(<span class="hljs-number">0x40</span>)<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li><p><strong>PROJECT</strong>：当前模块</p>
</li>
<li><p><strong>SUB_PROJECTS</strong>：子模块</p>
</li>
<li><p><strong>EXTERNAL_LIBRARIES</strong>：外部依赖，包括当前和子模块所依赖的Jar/AAR</p>
</li>
<li><p><strong>TESTED_CODE</strong>：测试代码</p>
</li>
<li><p><strong>PROVIDED_ONLY</strong>：本地和远程依赖的Jar/AAR</p>
</li>
</ul>
<p><strong>若为子Module注册Transform，则只能使用<code>Scope.PROJECT</code>。</strong></p>
<blockquote>
<p>通常使用<code>TransformManager</code>设置作用域</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Set&lt;ScopeType&gt; PROJECT_ONLY = ImmutableSet.of(Scope.PROJECT); <br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> Set&lt;ScopeType&gt; SCOPE_FULL_PROJECT =<br>        ImmutableSet.of(Scope.PROJECT, Scope.SUB_PROJECTS, Scope.EXTERNAL_LIBRARIES);<span class="hljs-comment">//通常使用较多，若为子Module就别用这个</span><br></code></pre></td></tr></table></figure>
<h6 id="InternalScope-内部Transform使用"><a href="#InternalScope-内部Transform使用" class="headerlink" title="InternalScope(内部Transform使用)"></a>InternalScope(内部Transform使用)</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> InternalScope implements QualifiedContent.ScopeType &#123;<br><br>    <span class="hljs-comment">/**<br>     * Scope to package classes.dex files in the main split APK in InstantRun mode. All other<br>     * classes.dex will be packaged in other split APKs.<br>     */</span><br>    MAIN_SPLIT(<span class="hljs-number">0x10000</span>),<br><br>    <span class="hljs-comment">/**<br>     * Only the project's local dependencies (local jars). This is to be used by the library plugin<br>     * only (and only when building the AAR).<br>     */</span><br>    LOCAL_DEPS(<span class="hljs-number">0x20000</span>),<br><br>    <span class="hljs-comment">/** Only the project's feature or dynamic-feature modules. */</span><br>    FEATURES(<span class="hljs-number">0x40000</span>),<br>    ;<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="示例代码-1"><a href="#示例代码-1" class="headerlink" title="示例代码"></a>示例代码</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getScopes</span><span class="hljs-params">()</span></span>: MutableSet&lt;<span class="hljs-keyword">in</span> QualifiedContent.Scope&gt; &#123;<br>    <span class="hljs-keyword">val</span> <span class="hljs-keyword">set</span> = mutableSetOf&lt;QualifiedContent.Scope&gt;()<br>    <span class="hljs-keyword">set</span>.add(QualifiedContent.Scope.PROJECT)<br>    <span class="hljs-keyword">if</span> (isApp) &#123; <span class="hljs-comment">//是否为app module</span><br>        <span class="hljs-keyword">set</span>.add(QualifiedContent.Scope.EXTERNAL_LIBRARIES)<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-keyword">set</span><br>&#125;<br></code></pre></td></tr></table></figure>
<h4 id="isIncremental"><a href="#isIncremental" class="headerlink" title="isIncremental"></a>isIncremental</h4><blockquote>
<p>当前<code>Transform</code>是否支持增量编译</p>
<p>不是每次的编译都是可以增量编译的，通过<code>isIncremental</code>check当前是否为增量编译</p>
<ul>
<li><code>false</code>：非增量编译 清空output目录，再对每个<code>class/jar</code>进行处理</li>
<li><code>true</code>：增量编译，需要检查每个<code>class/jar</code>的<code>Status</code>，分别处理</li>
</ul>
</blockquote>
<p>存在两个标志位：</p>
<h5 id="Transform-isIncremental"><a href="#Transform-isIncremental" class="headerlink" title="Transform.isIncremental"></a>Transform.isIncremental</h5><blockquote>
<p><code>Transform</code>增量构建的开发</p>
</blockquote>
<p>若为<code>true</code>，对应的<code>TransformTask</code>依然会执行，有可能触发增量构建</p>
<h5 id="TransformInvocation-isIncremental"><a href="#TransformInvocation-isIncremental" class="headerlink" title="TransformInvocation.isIncremental"></a>TransformInvocation.isIncremental</h5><blockquote>
<p>当前<code>Transform</code>对应的<code>Task</code>是否增量执行</p>
</blockquote>
<p>若为<code>true</code>，对应的<code>TransformTask</code>表示增量模式。</p>
<p>在增量模式下，所有的<code>Input</code>都是带<code>Status</code>的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> Status &#123;<br>    <span class="hljs-comment">/**<br>     * The file was not changed since the last build.<br>     */</span><br>    NOTCHANGED, <br>    <span class="hljs-comment">/**<br>     * The file was added since the last build.<br>     */</span><br>    ADDED,<br>    <span class="hljs-comment">/**<br>     * The file was modified since the last build.<br>     */</span><br>    CHANGED,<br>    <span class="hljs-comment">/**<br>     * The file was removed since the last build.<br>     */</span><br>    REMOVED;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>Status</code>分为以下四种：</p>
<ul>
<li>NOTCHANGED：(文件无改变)无操作</li>
<li>ADDED：(文件新增) 按照正常流程处理 class/jar</li>
<li>CHANGED：(文件修改) 按照正常流程处理 class/jar</li>
<li>REMOVED：(文件删除) 清除<code>outputProvider</code>对应路径文件</li>
</ul>
<h4 id="transform"><a href="#transform" class="headerlink" title="* transform"></a>* transform</h4><blockquote>
<p>在这个方法中获取输入的Class文件，经过中间过程的修改，最后输出修改的Class文件。</p>
</blockquote>
<h5 id="TransformInvocation-提供输入-amp-输出相关信息"><a href="#TransformInvocation-提供输入-amp-输出相关信息" class="headerlink" title="TransformInvocation - 提供输入&amp;输出相关信息"></a>TransformInvocation - 提供输入&amp;输出相关信息</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">TransformInvocation</span> </span>&#123;<br><br>    <span class="hljs-comment">/**<br>     * Returns the context in which the transform is run.<br>     * <span class="hljs-doctag">@return</span> the context in which the transform is run.<br>     */</span><br>    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-function">Context <span class="hljs-title">getContext</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-comment">/**<br>     * Returns the inputs/outputs of the transform.<br>     * <span class="hljs-doctag">@return</span> the inputs/outputs of the transform.<br>     */</span><br>    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-function">Collection&lt;TransformInput&gt; <span class="hljs-title">getInputs</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-comment">/**<br>     * Returns the referenced-only inputs which are not consumed by this transformation.<br>     * <span class="hljs-doctag">@return</span> the referenced-only inputs.<br>     */</span><br>    <span class="hljs-meta">@NonNull</span> <span class="hljs-function">Collection&lt;TransformInput&gt; <span class="hljs-title">getReferencedInputs</span><span class="hljs-params">()</span></span>;<br>    <span class="hljs-comment">/**<br>     * Returns the list of secondary file changes since last. Only secondary files that this<br>     * transform can handle incrementally will be part of this change set.<br>     * <span class="hljs-doctag">@return</span> the list of changes impacting a &#123;<span class="hljs-doctag">@link</span> SecondaryInput&#125;<br>     */</span><br>    <span class="hljs-meta">@NonNull</span> <span class="hljs-function">Collection&lt;SecondaryInput&gt; <span class="hljs-title">getSecondaryInputs</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-comment">/**<br>     * Returns the output provider allowing to create content.<br>     * <span class="hljs-doctag">@return</span> he output provider allowing to create content.<br>     */</span><br>    <span class="hljs-meta">@Nullable</span><br>    <span class="hljs-function">TransformOutputProvider <span class="hljs-title">getOutputProvider</span><span class="hljs-params">()</span></span>;<br><br><br>    <span class="hljs-comment">/**<br>     * Indicates whether the transform execution is incremental.<br>     * <span class="hljs-doctag">@return</span> true for an incremental invocation, false otherwise.<br>     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">boolean</span> <span class="hljs-title">isIncremental</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>主要包括以下方法：</p>
<ul>
<li><strong>getContext</strong>：返回<code>Transform</code>运行相关信息</li>
<li><strong>getInputs</strong>：返回<code>TransformInput</code>对象，主要是输入内容信息</li>
<li><strong>getOutputProvider</strong>：返回<code>TransformOutputProvider</code>对象，主要是返回输出文件</li>
<li><strong>isIncremental</strong>：当前<code>Transform</code>对应Task是否增量构建</li>
</ul>
<h6 id="TransformInput-输入文件信息"><a href="#TransformInput-输入文件信息" class="headerlink" title="TransformInput - 输入文件信息"></a>TransformInput - 输入文件信息</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">TransformInput</span> </span>&#123;<br><br>    <span class="hljs-comment">/**<br>     * Returns a collection of &#123;<span class="hljs-doctag">@link</span> JarInput&#125;.<br>     */</span><br>    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-function">Collection&lt;JarInput&gt; <span class="hljs-title">getJarInputs</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-comment">/**<br>     * Returns a collection of &#123;<span class="hljs-doctag">@link</span> DirectoryInput&#125;.<br>     */</span><br>    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-function">Collection&lt;DirectoryInput&gt; <span class="hljs-title">getDirectoryInputs</span><span class="hljs-params">()</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>主要包括以下两个方法：</p>
<ul>
<li>getJarInputs:Collection<jarinput>：以jar和aar的依赖方式参与构建的输入文件，包含本地依赖和远程依赖</jarinput></li>
<li>getDirectoryInputs:Collection<directoryinput>：以源码方式参与项目编译的所有目录结构及其中的源码文件</directoryinput></li>
</ul>
<h6 id="TransformOutputProvider-输出信息"><a href="#TransformOutputProvider-输出信息" class="headerlink" title="TransformOutputProvider - 输出信息"></a>TransformOutputProvider - 输出信息</h6><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">TransformOutputProvider</span> </span>&#123;<br><br>    <span class="hljs-comment">/**<br>     * Delete all content. This is useful when running in non-incremental mode<br>     *<br>     * <span class="hljs-doctag">@throws</span> IOException if deleting the output failed.<br>     */</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">deleteAll</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> IOException</span>;<br><br><br>     <span class="hljs-comment">/**<br>     * Returns the location of content for a given set of Scopes, Content Types, and Format.<br>     *<br>     * &lt;p&gt;If the format is &#123;<span class="hljs-doctag">@link</span> Format#DIRECTORY&#125; then the result is the file location of the<br>     * directory.&lt;br&gt;<br>     * If the format is &#123;<span class="hljs-doctag">@link</span> Format#JAR&#125; then the result is a file representing the jar to create.<br>     */</span><br>    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-function">File <span class="hljs-title">getContentLocation</span><span class="hljs-params">(<br>            @NonNull String name,<br>            @NonNull Set&lt;QualifiedContent.ContentType&gt; types,<br>            @NonNull Set&lt;? <span class="hljs-keyword">super</span> QualifiedContent.Scope&gt; scopes,<br>            @NonNull Format format)</span></span>;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>主要包括以下两个方法：</p>
<ul>
<li><p><strong>deleteAll</strong>：清空输出目录下所有文件，用于非增量构建的情况下(<code>TransformInvocation.isIncremental == false</code>)</p>
</li>
<li><p><strong>getContentLocation</strong>：获取指定范围(<code>Scope</code>)以及指定类型(<code>ContentType</code>)还有文件类型(<code>Format：目前只有Directory，JAR</code>)的输出目标路径</p>
</li>
</ul>
<h5 id="执行流程"><a href="#执行流程" class="headerlink" title="执行流程"></a>执行流程</h5><h6 id="获取输入文件"><a href="#获取输入文件" class="headerlink" title="获取输入文件"></a>获取输入文件</h6><p>主要对象为<code>TransformInput</code>，对应的文件分为两种：</p>
<ul>
<li>源码文件 / <code>DirectoryInput</code></li>
<li>依赖的Jar/aar文件 / <code>JarInput</code></li>
</ul>
<h6 id="获取输出路径"><a href="#获取输出路径" class="headerlink" title="获取输出路径"></a>获取输出路径</h6><p>主要对象为<code>TransformOutputProvider</code>，需要采用指定方法获取，输出路径主要是两种：</p>
<ul>
<li><p>源码文件输出路径 </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> dest = outputProvider.getContentLocation(<br>    dirInput.name,<br>    dirInput.contentTypes,<br>    dirInput.scopes,<br>    Format.DIRECTORY<br>)<br></code></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>依赖的Jar/aar文件输出路径</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">val</span> dest = outputProvider.getContentLocation(<br>    jarInput.name,<br>    jarInput.contentTypes,<br>    jarInput.scopes,<br>    Format.JAR<br>)<br></code></pre></td></tr></table></figure>
</li>
</ul>
<p>主要区别在设置的<code>Format</code>上。</p>
<h6 id="处理输入文件"><a href="#处理输入文件" class="headerlink" title="处理输入文件"></a>处理输入文件</h6><p>处理上按照输入文件类型分开处理</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">transform</span><span class="hljs-params">(transformInvocation: <span class="hljs-type">TransformInvocation</span>)</span></span> &#123;<br>  <span class="hljs-keyword">val</span> context = transformInvocation.context<br>  <span class="hljs-keyword">val</span> inputs = transformInvocation.inputs<br>  <span class="hljs-keyword">val</span> outputProvider = transformInvocation.outputProvider<br>  <span class="hljs-keyword">val</span> isIncremental = transformInvocation.isIncremental<br>  <br>  <br> <span class="hljs-keyword">if</span> (!isIncremental) &#123;<br>        <span class="hljs-comment">//删除所有</span><br>        outputProvider.deleteAll()<br>    &#125;<br>    inputs.forEach &#123; input -&gt;<br>        <span class="hljs-comment">//遍历 src下文件</span><br>        input.directoryInputs.forEach &#123; directoryInput -&gt;<br>            foreachDirectory(context, outputProvider, directoryInput, isIncremental)<br>        &#125;<br>        <span class="hljs-comment">//遍历jar/aar内文件</span><br>        input.jarInputs.forEach &#123; jarInput -&gt;<br>            foreachJar(context, outputProvider, jarInput, isIncremental)<br>        &#125;<br>    &#125; <br>  <br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li><p>源码文件(src下编译生成的class文件)</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">private</span>  <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foreachDirectory</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, outputProvider: <span class="hljs-type">TransformOutputProvider</span>, input: <span class="hljs-type">DirectoryInput</span>, isIncremental: <span class="hljs-type">Boolean</span>)</span></span> &#123;<br>    <span class="hljs-comment">//</span><br>        <span class="hljs-keyword">val</span> dir = input.file<br>        <span class="hljs-keyword">val</span> dest = outputProvider.getContentLocation(<br>            input.name,<br>            input.contentTypes,<br>            input.scopes,<br>            Format.DIRECTORY<br>        )<br>        FileUtils.forceMkdir(dest)<br>        <span class="hljs-keyword">val</span> srcDicPath = dir.absolutePath<br>        <span class="hljs-keyword">val</span> destDicPath = dest.absolutePath<br>  <br>     <span class="hljs-comment">//增量模式处理</span><br>     <span class="hljs-keyword">if</span> (isIncremental) &#123;<br>            <span class="hljs-keyword">val</span> fileStatus = input.changedFiles<br>            fileStatus.forEach &#123; file, status -&gt;<br>                <span class="hljs-keyword">val</span> destFilePath = file.absolutePath.replace(srcDicPath, destDicPath)<br>                <span class="hljs-keyword">val</span> destFile = File(destFilePath)       <br>                <span class="hljs-keyword">when</span> (status) &#123;<br>                    Status.ADDED, Status.CHANGED -&gt; &#123;<br>                        println(<span class="hljs-string">"File is Updated name： <span class="hljs-subst">$&#123;file.name&#125;</span> and path <span class="hljs-subst">$&#123;file.absolutePath&#125;</span>"</span>)<br>                        transformDir(context,dir,inputFile,destFilePath)<br>                    &#125;<br>                    Status.REMOVED               -&gt; &#123;<br>                        println(<span class="hljs-string">"File is Removed name： <span class="hljs-subst">$&#123;file.name&#125;</span>"</span>)<br>                        <span class="hljs-keyword">if</span> (destFile.exists()) &#123;<br>                            destFile.delete()<br>                        &#125;<br>                    &#125;<br>                    <span class="hljs-keyword">else</span>                         -&gt; &#123;<br><br>                    &#125;<br>                &#125;        <br>     &#125;<span class="hljs-keyword">else</span>&#123;<br>            FileUtils.copyDirectory(dir, dest)<br>            dir.walk().asSequence().filter &#123;<span class="hljs-comment">//按照指定格式筛选文件</span><br>                it.isFile &amp;&amp; checkDicClassFile(it.name)<br>            &#125;.forEach &#123; file -&gt;<br>                transformDir(context, dir, file, file.absolutePath.replace(srcDirPath, destDirPath))<br>            &#125;<br>     &#125;<br>  <br>     <span class="hljs-comment">//非增量模式处理</span><br>  <br>&#125;<br>  <br>    <span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">transformDir</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, dir: <span class="hljs-type">File</span>, inputFile: <span class="hljs-type">File</span>, destFilePath: <span class="hljs-type">String</span>)</span></span> &#123;<br>        <span class="hljs-keyword">val</span> destFile = File(destFilePath)<br>        <span class="hljs-keyword">if</span> (destFile.exists()) &#123;<br>            destFile.delete()<br>        &#125;<br>      <span class="hljs-comment">//编辑class文件</span><br>        <span class="hljs-keyword">val</span> modifiedFile = modifyClassFile(dir,inputFile,context.temporaryDir)<br>        <span class="hljs-keyword">if</span> (modifiedFile != <span class="hljs-literal">null</span>) &#123;<br>            FileUtils.copyFile(modifiedFile, destFile)<br>            modifiedFile.delete()<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            FileUtils.copyFile(inputFile, destFile)<br>        &#125;<br><br>    &#125;<br></code></pre></td></tr></table></figure>
<blockquote>
<p>注意⚠️：就算不想修改class文件，也需要<strong>原样拷贝过去</strong>。否则该文件就会丢失！</p>
</blockquote>
</li>
<li><p>Jar/aar文件</p>
<blockquote>
<p>相比于class文件多了解压缩过程，解压后得到的class文件处理方式与上面一致，最后需要将处理后的class文件重新压缩即可。</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">foreachJar</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, outputProvider: <span class="hljs-type">TransformOutputProvider</span>, input: <span class="hljs-type">JarInput</span>, isIncremental: <span class="hljs-type">Boolean</span>)</span></span> &#123;<br>    <span class="hljs-keyword">if</span> (input.file.absolutePath.endsWith(<span class="hljs-string">"jar"</span>)) &#123;<br>        <span class="hljs-keyword">var</span> jarName = input.file.name<br>        <span class="hljs-keyword">val</span> md5Name = DigestUtils.md5Hex(input.file.absolutePath)<br>        <span class="hljs-keyword">if</span> (jarName.endsWith(<span class="hljs-string">".jar"</span>)) &#123;<br>            jarName = jarName.substring(<span class="hljs-number">0</span>, jarName.length - <span class="hljs-number">4</span>)<br>        &#125;<br>        <span class="hljs-keyword">val</span> dest = outputProvider.getContentLocation(<br>            <span class="hljs-string">"<span class="hljs-subst">$&#123;jarName&#125;</span>_<span class="hljs-subst">$&#123;md5Name&#125;</span>"</span>,<br>            input.contentTypes,<br>            input.scopes,<br>            Format.JAR<br>        )<br>        <span class="hljs-keyword">if</span> (isIncremental) &#123;<br>            <span class="hljs-keyword">when</span> (input.status) &#123;<br>                Status.ADDED, Status.CHANGED -&gt; &#123;<br>                    println(<span class="hljs-string">"Jar is Updated name： <span class="hljs-subst">$&#123;input.file.name&#125;</span>"</span>)<br>                    transformJar(context, dest, input)<br>                &#125;<br>                Status.REMOVED               -&gt; &#123;<br>                    println(<span class="hljs-string">"Jar is Removed and <span class="hljs-subst">$&#123;input.file.name&#125;</span>"</span>)<br>                    <span class="hljs-keyword">if</span> (dest.exists()) &#123;<br>                        FileUtils.forceDelete(dest)<br>                    &#125;<br>                &#125;<br>                <span class="hljs-keyword">else</span>                         -&gt; &#123;<br>  <br>                &#125;<br>            &#125;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            transformJar(context, dest, input)<br>        &#125;<br>  <br>    &#125;<br>&#125;<br>  <br><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">transformJar</span><span class="hljs-params">(context: <span class="hljs-type">Context</span>, dest: <span class="hljs-type">File</span>, input: <span class="hljs-type">JarInput</span>)</span></span> &#123;<br>    <span class="hljs-keyword">var</span> modifyJar: File? = <span class="hljs-literal">null</span><br>    modifyJar = modifyJarFile(input.file, context.temporaryDir)<br>    <span class="hljs-keyword">if</span> (modifyJar == <span class="hljs-literal">null</span>) &#123;<br>        modifyJar = input.file<br>    &#125;<br>  <span class="hljs-comment">//操作完成后，最后需要拷贝回去 避免文件丢失</span><br>    FileUtils.copyFile(modifyJar, dest)<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
</ul>
<pre><code class=" mermaid">flowchart TB
id1((开始))
id2(transform)
id1 --&gt; id2
id3&#123;isIncremental&#125;
id2--&gt; id3
id4(outputProvider.deleteAll)
id3--非增量模式/false--&gt;id4
id5(遍历transformInvocation.inputs)
id4--&gt;id5
id3--增量模式/true--&gt;id5
id7(遍历\ndirectoryInputs)
id6(遍历\njarInputs)
id5--&gt;id6
id5--&gt;id7
id71(遍历\nsrc下class文件)
id72(执行hook)
id73(拷贝修改后class文件到\noutputProvider.getContentLocation位置)
id7--&gt;id71--&gt;id72--&gt;id73
id61(遍历jarinput下jar/aar文件)
id62(解压jar/aar文件)
id63(遍历内部class文件)
id64(执行hook)
id65(修改完的class文件打包成jar文件)
id66(拷贝修改后jar文件到\noutputProvider.getContentLocation位置)
id6--&gt;id61--&gt;id62--&gt;id63--&gt;id64--&gt;id65--&gt;id66
id8((transform\n结束))
id66--&gt;id8
id73--&gt;id8
</code></pre>
<h4 id="注册Transform"><a href="#注册Transform" class="headerlink" title="注册Transform"></a>注册Transform</h4><blockquote>
<p>实现一个<code>Transform</code>后，需要注册才可以功能生效。</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomPlugin</span> : <span class="hljs-type">Plugin</span>&lt;<span class="hljs-type">Project</span>&gt; </span>&#123;<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(project: <span class="hljs-type">Project</span>)</span></span> &#123;<br>      <span class="hljs-comment">//处理extension等信息</span><br>      ...<br>       <span class="hljs-comment">//判定当前为 app module</span><br>        <span class="hljs-keyword">val</span> appExtension = project.extensions.findByType(AppExtension::<span class="hljs-class"><span class="hljs-keyword">class</span>.<span class="hljs-title">java</span>)</span><br>        <span class="hljs-keyword">if</span> (appExtension != <span class="hljs-literal">null</span>) &#123;<br>            appExtension.registerTransform(MethodTraceTransform(project, <span class="hljs-literal">true</span>))<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">//判定当前为 library module</span><br>            <span class="hljs-keyword">val</span> libExtension = project.extensions.findByType(LibraryExtension::<span class="hljs-class"><span class="hljs-keyword">class</span>.<span class="hljs-title">java</span>)</span><br>            libExtension?.registerTransform(MethodTraceTransform(project, <span class="hljs-literal">false</span>))<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h3><h4 id="注册Transform-1"><a href="#注册Transform-1" class="headerlink" title="注册Transform"></a>注册Transform</h4><blockquote>
<p>主要是将<code>Transform</code>注册在<code>BaseExtension</code>中。</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">BaseExtension</span> <span class="hljs-keyword">protected</span> <span class="hljs-keyword">constructor</span></span>(<br>  ...<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _transforms: MutableList&lt;Transform&gt; = mutableListOf()<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> _transformDependencies: MutableList&lt;List&lt;Any&gt;&gt; = mutableListOf()<br>  ...<br>  <br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">registerTransform</span><span class="hljs-params">(transform: <span class="hljs-type">Transform</span>, <span class="hljs-keyword">vararg</span> dependencies: <span class="hljs-type">Any</span>)</span></span> &#123;<br>        dslServices.deprecationReporter.reportDeprecatedApi(<br>            newApiElement = <span class="hljs-literal">null</span>,<br>            oldApiElement = <span class="hljs-string">"android.registerTransform"</span>,<br>            url = <span class="hljs-string">"https://developer.android.com/studio/releases/gradle-plugin-api-updates#transform-api"</span>,<br>            deprecationTarget = DeprecationReporter.DeprecationTarget.TRANSFORM_API<br>        )<br>        _transforms.add(transform)<br>        _transformDependencies.add(listOf(dependencies))<br>    &#125;<br>  <br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> transforms: List&lt;Transform&gt;<br>        <span class="hljs-keyword">get</span>() = ImmutableList.copyOf(_transforms)<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> transformsDependencies: List&lt;List&lt;Any&gt;&gt;<br>        <span class="hljs-keyword">get</span>() = ImmutableList.copyOf(_transformDependencies)<br>  <br>  &#125;<br></code></pre></td></tr></table></figure>
<p>内部的<code>transforms</code>由外部调用，<code>GlobalTaskCreationConfigImpl</code>使用到了<code>transforms</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">override</span> <span class="hljs-keyword">val</span> transforms: List&lt;Transform&gt;<br>    <span class="hljs-keyword">get</span>() = oldExtension.transforms<br></code></pre></td></tr></table></figure>
<p><code>GlobalTaskCreationConfigImpl</code>为<code>GlobalTaskCreationConfig</code>实现类，所以<code>GlobalTaskCreationConfig</code>对应的<code>transforms</code>即为<code>BaseExtension</code>注册进来的<code>Transform</code>。</p>
<h4 id="创建TransformTask"><a href="#创建TransformTask" class="headerlink" title="创建TransformTask"></a>创建TransformTask</h4><p>由<a href="/2022/03/18/Gradle学习笔记-AGP原理/" title="Gradle学习笔记-AGP原理">Gradle学习笔记-AGP原理</a>可知Task的构建流程</p>
<p>都是由<code>BasePlugin.createAndroidTasks</code>开始的，其他细节在<a href="/2022/03/18/Gradle学习笔记-AGP原理/" title="Gradle学习笔记-AGP原理">Gradle学习笔记-AGP原理</a>有详细介绍</p>
<h5 id="BasePlugin-createAndroidTasks"><a href="#BasePlugin-createAndroidTasks" class="headerlink" title="BasePlugin.createAndroidTasks"></a>BasePlugin.createAndroidTasks</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-function"><span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">createAndroidTasks</span><span class="hljs-params">()</span> </span>&#123;<br>    GlobalTaskCreationConfig globalConfig = variantManager.getGlobalTaskCreationConfig();<br> ...<br>    TaskManager&lt;VariantBuilderT, VariantT&gt; taskManager =<br>            createTaskManager(<br>                    project,<br>                    variants,<br>                    variantManager.getTestComponents(),<br>                    variantManager.getTestFixturesComponents(),<br>                    globalConfig,<br>                    taskManagerConfig,<br>                    extension);<br><br>    taskManager.createTasks(variantFactory.getVariantType(), createVariantModel(globalConfig));<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="TaskManager-createTasks"><a href="#TaskManager-createTasks" class="headerlink" title="TaskManager.createTasks"></a>TaskManager.createTasks</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createTasks</span><span class="hljs-params">(<br>        variantType: <span class="hljs-type">VariantType</span>, variantModel: <span class="hljs-type">VariantModel</span>)</span></span> &#123;<br>  ...<br>    <span class="hljs-comment">// Create tasks for all variants (main, testFixtures and tests)        </span><br>    <span class="hljs-keyword">for</span> (variant <span class="hljs-keyword">in</span> variants) &#123;<br>        createTasksForVariant(variant)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createTasksForVariant</span><span class="hljs-params">(<br>        variant: <span class="hljs-type">ComponentInfo</span>&lt;<span class="hljs-type">VariantBuilderT</span>, VariantT&gt;,<br>)</span></span>&#123;<br>  ...<br>    doCreateTasksForVariant(variant)<br>&#125;<br><br><span class="hljs-keyword">protected</span> <span class="hljs-keyword">abstract</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doCreateTasksForVariant</span><span class="hljs-params">(<br>        variantInfo: <span class="hljs-type">ComponentInfo</span>&lt;<span class="hljs-type">VariantBuilderT</span>, VariantT&gt;)</span></span><br></code></pre></td></tr></table></figure>
<h5 id="TaskManager-doCreateTasksForVariant"><a href="#TaskManager-doCreateTasksForVariant" class="headerlink" title="TaskManager.doCreateTasksForVariant"></a>TaskManager.doCreateTasksForVariant</h5><blockquote>
<p><code>TaskManager</code>是抽象类，主要实现类为</p>
<ul>
<li><code>ApplicationTaskManager</code>：对应 app module</li>
<li><code>LibraryTaskManager</code>：对应 library module</li>
</ul>
</blockquote>
<p>以<code>LibraryTaskManager</code>为例</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Override</span><br><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doCreateTasksForVariant</span><span class="hljs-params">(<br>        @NotNull ComponentInfo&lt;LibraryVariantBuilderImpl, LibraryVariantImpl&gt; variantInfo)</span> </span>&#123;<br>  <span class="hljs-comment">//创建其他Task</span><br>  ...<br>  TransformManager transformManager = libraryVariant.getTransformManager();<br>  <br>  <span class="hljs-comment">//对应的BaseExtension 注册的Transform</span><br>   List&lt;Transform&gt; customTransforms = globalConfig.getTransforms();<br>   List&lt;List&lt;Object&gt;&gt; customTransformsDependencies = globalConfig.getTransformsDependencies();<br>  <br>   <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>, count = customTransforms.size(); i &lt; count; i++) &#123;<br>        Transform transform = customTransforms.get(i);<br>     <span class="hljs-comment">//library module 只支持 PROJECT_ONLY</span><br>        Sets.SetView&lt;? <span class="hljs-keyword">super</span> Scope&gt; difference =<br>                Sets.difference(transform.getScopes(), TransformManager.PROJECT_ONLY);<br>        <span class="hljs-keyword">if</span> (!difference.isEmpty()) &#123;<br>            String scopes = difference.toString();<br>            issueReporter.reportError(<br>                    Type.GENERIC,<br>                    String.format(<br>                            <span class="hljs-string">"Transforms with scopes '%s' cannot be applied to library projects."</span>,<br>                            scopes));<br>        &#125;            <br>     <span class="hljs-comment">//创建TransformTask</span><br>        transformManager.addTransform(<br>                taskFactory,<br>                libraryVariant,<br>                transform,<br>                <span class="hljs-keyword">null</span>,<br>                task -&gt; &#123;<br>                    <span class="hljs-keyword">if</span> (!deps.isEmpty()) &#123;<br>                        task.dependsOn(deps);<br>                    &#125;<br>                &#125;,<br>                taskProvider -&gt; &#123;<br>                    <span class="hljs-comment">// if the task is a no-op then we make assemble task</span><br>                    <span class="hljs-comment">// depend on it.</span><br>                    <span class="hljs-keyword">if</span> (transform.getScopes().isEmpty()) &#123;<br>                        TaskFactoryUtils.dependsOn(<br>                                libraryVariant.getTaskContainer().getAssembleTask(),<br>                                taskProvider);<span class="hljs-comment">//依赖assembleXXTask后执行</span><br>                    &#125;<br>                &#125;);                <br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="TransformManager-addTransform"><a href="#TransformManager-addTransform" class="headerlink" title="TransformManager.addTransform"></a>TransformManager.addTransform</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java">    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-keyword">public</span> &lt;T extends Transform&gt; Optional&lt;TaskProvider&lt;TransformTask&gt;&gt; addTransform(<br>            <span class="hljs-meta">@NonNull</span> TaskFactory taskFactory,<br>            <span class="hljs-meta">@NonNull</span> VariantCreationConfig creationConfig,<br>            <span class="hljs-meta">@NonNull</span> T transform, <span class="hljs-comment">//the transform to add</span><br>            <span class="hljs-meta">@Nullable</span> PreConfigAction preConfigAction,<br>            <span class="hljs-meta">@Nullable</span> TaskConfigAction&lt;TransformTask&gt; configAction,<br>            <span class="hljs-meta">@Nullable</span> TaskProviderCallback&lt;TransformTask&gt; providerCallback) &#123;<br>      <span class="hljs-comment">//设置Task name   transform[getInputTypes]With[getName]For[creationConfig.name]</span><br>      <span class="hljs-comment">//示例名称 transform[Classes]With[MethodTrace]For[Release]</span><br>        String taskName = creationConfig.computeTaskName(getTaskNamePrefix(transform), <span class="hljs-string">""</span>);      <br>      <br>      <span class="hljs-comment">//创建TransformTask</span><br>        <span class="hljs-keyword">return</span> Optional.of(<br>                taskFactory.register(<span class="hljs-comment">//注册创建的TransformTask</span><br>                        <span class="hljs-keyword">new</span> TransformTask.CreationAction&lt;&gt;(<br>                                creationConfig.getName(),<br>                                taskName,<br>                                transform,<br>                                inputStreams,<br>                                referencedStreams,<br>                                outputStream),<br>                        preConfigAction,<br>                        wrappedConfigAction,<br>                        providerCallback));      <br>    &#125;<br><br><span class="hljs-comment">//最终得到的TaskName格式为 </span><br>    <span class="hljs-function"><span class="hljs-keyword">static</span> String <span class="hljs-title">getTaskNamePrefix</span><span class="hljs-params">(@NonNull Transform transform)</span> </span>&#123;<br>        StringBuilder sb = <span class="hljs-keyword">new</span> StringBuilder(<span class="hljs-number">100</span>);<br>        sb.append(<span class="hljs-string">"transform"</span>);<br><br>        sb.append(<br>                transform<br>                        .getInputTypes()<br>                        .stream()<br>                        .map(<br>                                inputType -&gt;<br>                                        CaseFormat.UPPER_UNDERSCORE.to(<br>                                                CaseFormat.UPPER_CAMEL, inputType.name()))<br>                        .sorted() <span class="hljs-comment">// Keep the order stable.</span><br>                        .collect(Collectors.joining(<span class="hljs-string">"And"</span>)));<br>        sb.append(<span class="hljs-string">"With"</span>);<br>        StringHelper.appendCapitalized(sb, transform.getName());<br>        sb.append(<span class="hljs-string">"For"</span>);<br><br>        <span class="hljs-keyword">return</span> sb.toString();<br>    &#125;<br></code></pre></td></tr></table></figure>
<h5 id="TransformTask-CreationAction"><a href="#TransformTask-CreationAction" class="headerlink" title="TransformTask.CreationAction"></a>TransformTask.CreationAction</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@CacheableTask</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransformTask</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">StreamBasedTask</span> </span>&#123;<br>  <span class="hljs-comment">//TransformTask 输入</span><br>    <span class="hljs-meta">@Input</span><br>    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-keyword">public</span> Set&lt;? <span class="hljs-keyword">super</span> QualifiedContent.Scope&gt; getScopes() &#123;<br>        <span class="hljs-keyword">return</span> transform.getScopes();<br>    &#125;<br>  <br>    <span class="hljs-meta">@Input</span><br>    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-keyword">public</span> Set&lt;QualifiedContent.ContentType&gt; getInputTypes() &#123;<br>        <span class="hljs-keyword">return</span> transform.getInputTypes();<br>    &#125;  <br>  <br>  <span class="hljs-comment">//TransformTask 输出</span><br>    <span class="hljs-meta">@OutputDirectory</span><br>    <span class="hljs-meta">@Optional</span><br>    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> DirectoryProperty <span class="hljs-title">getOutputDirectory</span><span class="hljs-params">()</span></span>;<br><br>    <span class="hljs-meta">@OutputFile</span><br>    <span class="hljs-meta">@Optional</span><br>    <span class="hljs-meta">@NonNull</span><br>    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> RegularFileProperty <span class="hljs-title">getOutputFile</span><span class="hljs-params">()</span></span>;<br>  <br> ...<br>   <br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreationAction</span>&lt;<span class="hljs-title">T</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Transform</span>&gt;<br>            <span class="hljs-keyword">extends</span> <span class="hljs-title">TaskCreationAction</span>&lt;<span class="hljs-title">TransformTask</span>&gt; </span>&#123;<br>        <span class="hljs-meta">@NonNull</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String variantName;<br>        <span class="hljs-meta">@NonNull</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> String taskName;<br>        <span class="hljs-meta">@NonNull</span><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> T transform;<br>      <br>      ...<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(@NonNull TransformTask task)</span> </span>&#123;<br>            task.transform = transform;<br>            transform.setOutputDirectory(task.getOutputDirectory());<br>            transform.setOutputFile(task.getOutputFile());<br>        ...<br>      &#125;<br>    &#125;<br>  <br>&#125;<br></code></pre></td></tr></table></figure>
<p>最后创建一个名为<code>transform[getInputTypes]With[getName]For[creationConfig.name]</code>的Task，并注册到当前module中。</p>
<h4 id="执行TransfromTask-执行transform"><a href="#执行TransfromTask-执行transform" class="headerlink" title="执行TransfromTask(执行transform())"></a>执行TransfromTask(执行transform())</h4><p>执行<code>Task</code>实际执行的是<code>自定义Task</code>内部实现了<code>@TaskAction</code>的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//TransformTask.java</span><br>    <span class="hljs-meta">@TaskAction</span><br>    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">transform</span><span class="hljs-params">(<span class="hljs-keyword">final</span> IncrementalTaskInputs incrementalTaskInputs)</span><br>            <span class="hljs-keyword">throws</span> IOException, TransformException, InterruptedException </span>&#123;<br>      ...<br>        <br>                        transform.transform(<br>                                <span class="hljs-keyword">new</span> TransformInvocationBuilder(context)<br>                                        .addInputs(consumedInputs.getValue())<br>                                        .addReferencedInputs(referencedInputs.getValue())<br>                                        .addSecondaryInputs(changedSecondaryInputs.getValue())<br>                                        .addOutputProvider(<br>                                                outputStream != <span class="hljs-keyword">null</span><br>                                                        ? outputStream.asOutput()<br>                                                        : <span class="hljs-keyword">null</span>)<br>                                        .setIncrementalMode(isIncremental.getValue())<br>                                        .build());        <br>      <br>    &#125;<br></code></pre></td></tr></table></figure>
<p>最终执行到了<code>自定义Transform</code>的<code>transform()</code>。</p>
<p>//todo 流程</p>
<h4 id="增量模式实现"><a href="#增量模式实现" class="headerlink" title="增量模式实现"></a>增量模式实现</h4><blockquote>
<p>若<code>isIncremental</code>为true，则返回的文件会携带状态，根据不同的状态执行不同的逻辑。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//TransformTask.java</span><br>    <span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">gatherChangedFiles</span><span class="hljs-params">(<br>            @NonNull Logger logger,<br>            @NonNull IncrementalTaskInputs incrementalTaskInputs,<br>            @NonNull <span class="hljs-keyword">final</span> Map&lt;File, Status&gt; changedFileMap,<br>            @NonNull <span class="hljs-keyword">final</span> Set&lt;File&gt; removedFiles)</span> </span>&#123;<br>        logger.info(<span class="hljs-string">"Transform inputs calculations based on following changes"</span>);<br>        incrementalTaskInputs.outOfDate(inputFileDetails -&gt; &#123;<br>            logger.info(inputFileDetails.getFile().getAbsolutePath() + <span class="hljs-string">":"</span><br>                    + IntermediateFolderUtils.inputFileDetailsToStatus(inputFileDetails));<br>            <span class="hljs-keyword">if</span> (inputFileDetails.isAdded()) &#123;<br>                changedFileMap.put(inputFileDetails.getFile(), Status.ADDED);<br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (inputFileDetails.isModified()) &#123;<br>                changedFileMap.put(inputFileDetails.getFile(), Status.CHANGED);<br>            &#125;<br>        &#125;);<br><br>        incrementalTaskInputs.removed(<br>                inputFileDetails -&gt; &#123;<br>                        logger.info(inputFileDetails.getFile().getAbsolutePath() + <span class="hljs-string">":REMOVED"</span>);<br>                        removedFiles.add(inputFileDetails.getFile());<br>                &#125;);<br>    &#125;<br></code></pre></td></tr></table></figure>
<p>由<code>Gradle</code>中的<code>TaskExecution.execute()</code>处理对应的文件。</p>
<p>会在{%post_link Gradle学习笔记-构建流程%}详细分析。</p>
<pre><code class=" mermaid">flowchart LR
id(compileReleaseJavaWithJavac\nTask产物)
id---&gt;id1
id---&gt;id2
id---&gt;id3
subgraph JarInput
 id2(jar/aar)
end

 subgraph DirectoryInput
  id1(class)
  id3(resource)
 end
 
 id4(自定义Transform)
 id1-.-&gt;id4
 id2-.-&gt;id4
 id3-.-&gt;id4
 
 id4---&gt;id5
 
 id5(自定义Transform)
 id5-.-&gt;id6
 
 id6(系统Transform)
</code></pre>
<p>基于上面分析，每个<code>Transform</code>都对应一个<code>TransformTask</code>，Android编译器中的<code>TaskManager</code>将每个<code>Transform</code>串连起来。</p>
<p>第一个<code>自定义Transform</code>接受来自<code>compileJavaWithJavac(对应源码 JavaCompileCreationAction)</code>Task的中间产物</p>
<ul>
<li>javac编译得到的class文件</li>
<li>远端/本地的第三方依赖</li>
<li>resource资源</li>
</ul>
<p>这些产物在<code>Transform链</code>上传递，处理完成后再向下一个进行传递。</p>
<h2 id="Transform模板"><a href="#Transform模板" class="headerlink" title="Transform模板"></a>Transform模板</h2><blockquote>
<p>大部分功能代码是一致的，主要差异在于字节码的处理上，由此可以抽象出一套模板写法，实现方只要处理字节码部分即可。</p>
</blockquote>
<blockquote>
<p> <code>Transform</code>API将在<code>AGP 8.0</code>中移除，主要为了<strong>提高构建性能，Transform API很难与其他Gradle特性结合使用。</strong></p>
</blockquote>
<p>基于以上原因，<code>Transform</code>后续可以使用<code>AsmClassVisitorFactory</code>或<code>TransformAction</code>进行替代。</p>
<h2 id="AsmClassVisitorFactory"><a href="#AsmClassVisitorFactory" class="headerlink" title="AsmClassVisitorFactory"></a>AsmClassVisitorFactory</h2><blockquote>
<p>在<code>AGP 4.2</code>后提供<code>AsmClassVisitorFactory</code>，主要用于处理<code>class</code>文件，与<code>Transform</code>主要功能大致相同，可以看做同等替换。</p>
<p><em>根据官方的说法，<code>AsmClassVisitoFactory</code>会带来约18%的性能提升，同时可以减少约5倍代码</em></p>
</blockquote>
<p><a href="https://developer.android.com/reference/tools/gradle-api/7.1/com/android/build/api/instrumentation/AsmClassVisitorFactory" target="_blank" rel="noopener">AsmClassVisitorFactory 文档</a></p>
<h3 id="示例代码-2"><a href="#示例代码-2" class="headerlink" title="示例代码"></a>示例代码</h3><h4 id="新建ClassVisitorFactory对象"><a href="#新建ClassVisitorFactory对象" class="headerlink" title="新建ClassVisitorFactory对象"></a>新建ClassVisitorFactory对象</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExampleClassVisitorFactory</span> : <span class="hljs-type">AsmClassVisitorFactory</span>&lt;<span class="hljs-type">ExampleClassVisitorFactory.ExampleParams</span>&gt; </span>&#123;<br>    <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ExampleParams</span> : <span class="hljs-type">InstrumentationParameters &#123;</span></span><br>        <span class="hljs-meta">@get:Input</span><br>        <span class="hljs-keyword">val</span> writeToStdout: Property&lt;<span class="hljs-built_in">Boolean</span>&gt;<br>    &#125;<br><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createClassVisitor</span><span class="hljs-params">(classContext: <span class="hljs-type">ClassContext</span>, nextClassVisitor: <span class="hljs-type">ClassVisitor</span>)</span></span>: ClassVisitor &#123;<br>        <span class="hljs-keyword">val</span> className = classContext.currentClassData.className.substringAfterLast(<span class="hljs-string">"."</span>)<br>        <span class="hljs-keyword">return</span> ExampleClassNode(className, nextClassVisitor, PrintWriter(System.<span class="hljs-keyword">out</span>))<br>    &#125;<br><br>  <span class="hljs-comment">//控制哪些类需要扫描</span><br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isInstrumentable</span><span class="hljs-params">(classData: <span class="hljs-type">ClassData</span>)</span></span>: <span class="hljs-built_in">Boolean</span> &#123;<br>        <span class="hljs-keyword">return</span> !classData.className.contains(<span class="hljs-string">".R$"</span>)<br>                &amp;&amp; !classData.className.endsWith(<span class="hljs-string">".R"</span>)<br>                &amp;&amp; !classData.className.endsWith(<span class="hljs-string">".BuildConfig"</span>)<br>                &amp;&amp; classData.className.startsWith(<span class="hljs-string">"com.example"</span>)<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">//ExampleClassNode.kt</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ExampleClassNode</span></span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> className: String, <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> nextVisitor: ClassVisitor, <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> printWriter: PrintWriter) :<br>    ClassVisitor(Opcodes.ASM7, nextVisitor) &#123;<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">visitMethod</span><span class="hljs-params">(<br>        access: <span class="hljs-type">Int</span>,<br>        name: <span class="hljs-type">String</span>?,<br>        descriptor: <span class="hljs-type">String</span>?,<br>        signature: <span class="hljs-type">String</span>?,<br>        exceptions: <span class="hljs-type">Array</span>&lt;<span class="hljs-type">out</span> <span class="hljs-type">String</span>&gt;?<br>    )</span></span>: MethodVisitor &#123;<br>        <span class="hljs-keyword">val</span> methodVisitor = <span class="hljs-keyword">super</span>.visitMethod(access, name, descriptor, signature, exceptions)<br>        <span class="hljs-keyword">return</span> PrintLogInterceptor(className, methodVisitor, access, name, descriptor)<br>    &#125;<br>      <br>          <span class="hljs-keyword">inner</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PrintLogInterceptor</span></span>(<br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> className: String?, <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> methodVisitor: MethodVisitor, access: <span class="hljs-built_in">Int</span>, name: String?, descriptor: String?<br>    ) : AdviceAdapter(ASM7, methodVisitor, access, name, descriptor) &#123;<br><br>        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">onMethodEnter</span><span class="hljs-params">()</span></span> &#123;<br>            <span class="hljs-keyword">super</span>.onMethodEnter()<br>          <span class="hljs-comment">//在每个方法里添加 Log打印，打印信息为类名和方法名</span><br>            methodVisitor.visitLdcInsn(className)<br>            methodVisitor.visitLdcInsn(name)<br>            methodVisitor.visitMethodInsn(INVOKESTATIC, <span class="hljs-string">"android/util/Log"</span>, <span class="hljs-string">"d"</span>, <span class="hljs-string">"(Ljava/lang/String;Ljava/lang/String;)I"</span>, <span class="hljs-literal">false</span>)<br>        &#125;<br>    &#125;<br>      <br> &#125;<br></code></pre></td></tr></table></figure>
<h4 id="注册ClassVisitorFactory对象"><a href="#注册ClassVisitorFactory对象" class="headerlink" title="注册ClassVisitorFactory对象"></a>注册ClassVisitorFactory对象</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//ExampleClassVisitorFactory.kt</span><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomPlugin</span> : <span class="hljs-type">Plugin</span>&lt;<span class="hljs-type">Project</span>&gt; </span>&#123;<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">apply</span><span class="hljs-params">(project: <span class="hljs-type">Project</span>)</span></span> &#123;<br>      <span class="hljs-comment">//</span><br>        <span class="hljs-keyword">val</span> androidComponents = project.extensions.findByType(AndroidComponentsExtension::<span class="hljs-class"><span class="hljs-keyword">class</span>.<span class="hljs-title">java</span>) //获取<span class="hljs-title">androidComponent</span></span><br>        <span class="hljs-keyword">if</span>(androidComponents!=<span class="hljs-literal">null</span>)&#123;<br>            androidComponents.onVariants &#123;variant -&gt;<br>                variant.instrumentation.transformClassesWith(<br>                    ExampleClassVisitorFactory::<span class="hljs-class"><span class="hljs-keyword">class</span>.<span class="hljs-title">java</span>,<br>                    <span class="hljs-type">InstrumentationScope.ALL //扫描范围</span></span><br>                )&#123;<br>                    it.writeToStdout.<span class="hljs-keyword">set</span>(<span class="hljs-literal">true</span>)<br>                &#125;<br>                variant.instrumentation.setAsmFramesComputationMode(FramesComputationMode.COPY_FRAMES)<br>            &#125;<br>        &#125; <br>      <br>    &#125; <br>&#125;<br></code></pre></td></tr></table></figure>
<p>可使用 <code>Android Studio Plugin——ASM ByteCode Viewer</code>，提前把要插入的代码进行解析获取ASM代码。</p>
<h3 id="相关API-1"><a href="#相关API-1" class="headerlink" title="相关API"></a>相关API</h3><h4 id="AsmClassVisitorFactory-1"><a href="#AsmClassVisitorFactory-1" class="headerlink" title="AsmClassVisitorFactory"></a>AsmClassVisitorFactory</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">AsmClassVisitorFactory</span>&lt;<span class="hljs-type">ParametersT : InstrumentationParameters</span>&gt; : <span class="hljs-type">Serializable &#123;</span></span><br>    <span class="hljs-meta">@get:Nested</span><br>    <span class="hljs-keyword">val</span> parameters: Property&lt;ParametersT&gt;<br>  <br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createClassVisitor</span><span class="hljs-params">(<br>        classContext: <span class="hljs-type">ClassContext</span>,<br>        nextClassVisitor: <span class="hljs-type">ClassVisitor</span><br>    )</span></span>: ClassVisitor<br>  <br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">isInstrumentable</span><span class="hljs-params">(classData: <span class="hljs-type">ClassData</span>)</span></span>: <span class="hljs-built_in">Boolean</span><br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>parameters</li>
</ul>
<blockquote>
<p>外部可配置<code>ClassVisitorFactory</code>的属性</p>
</blockquote>
<ul>
<li>isInstrumentable</li>
</ul>
<blockquote>
<p>设置哪些类需要被扫描，可以提升执行效率</p>
</blockquote>
<ul>
<li>ClassData</li>
</ul>
<blockquote>
<p>对应类的部分数据</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">ClassData</span> </span>&#123;<br>    <span class="hljs-comment">/**<br>     * Fully qualified name of the class.<br>     */</span><br>    <span class="hljs-keyword">val</span> className: String<br><br>    <span class="hljs-comment">/**<br>     * List of the annotations the class has.<br>     */</span><br>    <span class="hljs-keyword">val</span> classAnnotations: List&lt;String&gt;<br><br>    <span class="hljs-comment">/**<br>     * List of all the interfaces that this class or a superclass of this class implements.<br>     */</span><br>    <span class="hljs-keyword">val</span> interfaces: List&lt;String&gt;<br><br>    <span class="hljs-comment">/**<br>     * List of all the super classes that this class or a super class of this class extends.<br>     */</span><br>    <span class="hljs-keyword">val</span> superClasses: List&lt;String&gt;<br>&#125;<br></code></pre></td></tr></table></figure>
<ul>
<li>createClassVisitor</li>
</ul>
<blockquote>
<p>创建<code>ClassVisitor</code>对象</p>
</blockquote>
<h4 id="AndroidComponentsExtension"><a href="#AndroidComponentsExtension" class="headerlink" title="AndroidComponentsExtension"></a>AndroidComponentsExtension</h4><p>transformClassesWith</p>
<blockquote>
<p>注册自定义<code>ClassVisitorFactory</code></p>
</blockquote>
<h3 id="工作原理-1"><a href="#工作原理-1" class="headerlink" title="工作原理"></a>工作原理</h3><p>与<code>Transform</code>类似，实际<code>AsmClassVisitorFactory</code>最终也是通过Task执行，使用的就是<code>TransformClassesWithAsm</code>Task。</p>
<p>初始也是从<code>BasePlugin.createAndroidTasks</code>开始，再执行到<code>TaskManager.doCreateTasksForVariant</code>。</p>
<h4 id="TaskManager-doCreateTasksForVariant-1"><a href="#TaskManager-doCreateTasksForVariant-1" class="headerlink" title="TaskManager.doCreateTasksForVariant"></a>TaskManager.doCreateTasksForVariant</h4><p><code>TaskManager</code>是抽象类，主要实现类为</p>
<ul>
<li><code>ApplicationTaskManager</code>：对应 app module</li>
<li><code>LibraryTaskManager</code>：对应 library module</li>
</ul>
<p>以<code>ApplicationTaskManager</code>为例</p>
<h4 id="ApplicationTaskManager-doCreateTasksForVariant"><a href="#ApplicationTaskManager-doCreateTasksForVariant" class="headerlink" title="ApplicationTaskManager.doCreateTasksForVariant"></a>ApplicationTaskManager.doCreateTasksForVariant</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//    ApplicationTaskManager.kt</span><br><span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doCreateTasksForVariant</span><span class="hljs-params">(<br>        variantInfo: <span class="hljs-type">ComponentInfo</span>&lt;<span class="hljs-type">ApplicationVariantBuilderImpl</span>, ApplicationVariantImpl&gt;<br>    )</span></span> &#123;<br>      createCommonTasks(variantInfo)<br>      ...<br>      <br>    &#125;<br><br><span class="hljs-comment">//AbstractAppTaskManager.kt</span><br><span class="hljs-keyword">protected</span> void createCommonTasks(<span class="hljs-meta">@NonNull</span> ComponentInfo&lt;VariantBuilderT, VariantT&gt; variant) &#123;<br>     ...<br>        <span class="hljs-comment">// Add a compile task class相关处理都需要在compile执行后</span><br>        createCompileTask(appVariantProperties);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> void createCompileTask(<span class="hljs-meta">@NonNull</span> VariantImpl variant) &#123;<br>        ApkCreationConfig apkCreationConfig = (ApkCreationConfig) variant;<br><br>        TaskProvider&lt;? extends JavaCompile&gt; javacTask = createJavacTask(variant);<br>        addJavacClassesStream(variant);<br>      <span class="hljs-comment">//执行compile task</span><br>        setJavaCompilerTask(javacTask, variant);<br>        createPostCompilationTasks(apkCreationConfig);<br>    &#125;<br><br><span class="hljs-comment">//TaskManager.kt</span><br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">createPostCompilationTasks</span><span class="hljs-params">(creationConfig: <span class="hljs-type">ApkCreationConfig</span>)</span></span> &#123;<br>      ...<br>        maybeCreateTransformClassesWithAsmTask(<br>            creationConfig <span class="hljs-keyword">as</span> ComponentImpl,<br>            isTestCoverageEnabled<br>        )<br>      <br>    &#125;<br></code></pre></td></tr></table></figure>
<h4 id="TaskManager-maybeCreateTransformClassesWithAsmTask"><a href="#TaskManager-maybeCreateTransformClassesWithAsmTask" class="headerlink" title="TaskManager.maybeCreateTransformClassesWithAsmTask"></a>TaskManager.maybeCreateTransformClassesWithAsmTask</h4><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">maybeCreateTransformClassesWithAsmTask</span><span class="hljs-params">(<br>    creationConfig: <span class="hljs-type">ComponentImpl</span>,<br>    isTestCoverageEnabled: <span class="hljs-type">Boolean</span><br>)</span></span> &#123;<br> ...<br>        creationConfig<br>                .transformManager<br>                .consumeStreams(<br>                        mutableSetOf(com.android.build.api.transform.QualifiedContent.Scope.PROJECT),<br>                        setOf(com.android.build.api.transform.QualifiedContent.DefaultContentType.CLASSES))<br>        taskFactory.register(<br>                TransformClassesWithAsmTask.CreationAction(<br>                    creationConfig,<br>                    isTestCoverageEnabled<br>                )<br>        )<br>  <br>&#125;<br></code></pre></td></tr></table></figure>
<p>在此处注册<code>TransformClassesWithAsmTask</code></p>
<h4 id="TransformClassesWithAsmTask"><a href="#TransformClassesWithAsmTask" class="headerlink" title="* TransformClassesWithAsmTask"></a>* TransformClassesWithAsmTask</h4><blockquote>
<p>实际执行 字节码处理的 任务</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransformClassesWithAsmTask</span> : <span class="hljs-type">NewIncrementalTask</span></span>() &#123;<br> ...<br>  <span class="hljs-comment">//输入信息</span><br>    <span class="hljs-meta">@get:Input</span><br>    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> excludes: SetProperty&lt;String&gt;<br><br>    <span class="hljs-meta">@get:Nested</span><br>    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> visitorsList: ListProperty&lt;AsmClassVisitorFactory&lt;*&gt;&gt; <span class="hljs-comment">//AsmClassVisitorFactory列表</span><br><br>    <span class="hljs-meta">@get:Incremental</span><br>    <span class="hljs-meta">@get:Classpath</span><br>    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> inputClassesDir: ConfigurableFileCollection <span class="hljs-comment">//输入的classes文件路径</span><br><br>    <span class="hljs-comment">// This is used when jacoco instrumented jars are used as inputs</span><br>    <span class="hljs-meta">@get:Incremental</span><br>    <span class="hljs-meta">@get:Classpath</span><br>    <span class="hljs-meta">@get:Optional</span><br>    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> inputJarsDir: DirectoryProperty <span class="hljs-comment">//输入的jar包路径</span><br>  <br>  <br>  <span class="hljs-comment">//输出目录</span><br>    <span class="hljs-meta">@get:OutputDirectory</span><br>    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> classesOutputDir: DirectoryProperty <span class="hljs-comment">//输出的classes文件路径</span><br><br>    <span class="hljs-meta">@get:OutputDirectory</span><br>    <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">val</span> jarsOutputDir: DirectoryProperty <span class="hljs-comment">//输出的jar包路径</span><br>  <br>  ...<br>  <br>   <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doTaskAction</span><span class="hljs-params">(inputChanges: <span class="hljs-type">InputChanges</span>)</span></span> &#123;<br>        <span class="hljs-keyword">if</span> (inputChanges.isIncremental) &#123;<br>          <span class="hljs-comment">//增量执行</span><br>            doIncrementalTaskAction(inputChanges)<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>          <span class="hljs-comment">//全量执行</span><br>            doFullTaskAction(inputChanges)<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="doFullTaskAction-doIncrementalTaskAction"><a href="#doFullTaskAction-doIncrementalTaskAction" class="headerlink" title="doFullTaskAction/doIncrementalTaskAction"></a>doFullTaskAction/doIncrementalTaskAction</h5><blockquote>
<p>全量执行和增量执行任务，根据<code>isIncremental</code>判断是否增量编译。</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doFullTaskAction</span><span class="hljs-params">(inputChanges: <span class="hljs-type">InputChanges</span>)</span></span> &#123;<br>    incrementalFolder.mkdirs()<br>    FileUtils.deleteDirectoryContents(classesOutputDir.<span class="hljs-keyword">get</span>().asFile)<br>    FileUtils.deleteDirectoryContents(incrementalFolder)<br><br>    workerExecutor.noIsolation().submit(TransformClassesFullAction::<span class="hljs-class"><span class="hljs-keyword">class</span>.<span class="hljs-title">java</span>) </span>&#123;<br>        configureParams(it, inputChanges)<br>        it.inputClassesDir.from(inputClassesDir)<br>        it.inputJarsDir.<span class="hljs-keyword">set</span>(inputJarsDir)<br>    &#125;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doIncrementalTaskAction</span><span class="hljs-params">(inputChanges: <span class="hljs-type">InputChanges</span>)</span></span> &#123;<br>  ...<br>    workerExecutor.noIsolation().submit(TransformClassesIncrementalAction::<span class="hljs-class"><span class="hljs-keyword">class</span>.<span class="hljs-title">java</span>) </span>&#123;<br>        configureParams(it, inputChanges)<br>        it.inputClassesDirChanges.<span class="hljs-keyword">set</span>(<br>            inputChanges.getFileChanges(inputClassesDir).toSerializable()<br>        )<br>        <span class="hljs-keyword">if</span> (inputJarsDir.isPresent) &#123;<br>            it.inputJarsChanges.<span class="hljs-keyword">set</span>(inputChanges.getFileChanges(inputJarsDir).toSerializable())<br>        &#125;<br>    &#125;<br>  <br>&#125;<br></code></pre></td></tr></table></figure>
<p>最终执行对应的Action</p>
<h5 id="TransformClassesFullAction-TransformClassesIncrementalAction"><a href="#TransformClassesFullAction-TransformClassesIncrementalAction" class="headerlink" title="TransformClassesFullAction/TransformClassesIncrementalAction"></a>TransformClassesFullAction/TransformClassesIncrementalAction</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><code class="hljs kotlin">    <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransformClassesFullAction</span>:<br>        <span class="hljs-type">TransformClassesWorkerAction</span>&lt;<span class="hljs-type">FullActionWorkerParams</span>&gt;</span>() &#123;<br><br>        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span> &#123;<br>            <span class="hljs-keyword">val</span> classesHierarchyResolver = getClassesHierarchyResolver()<br>            getInstrumentationManager(classesHierarchyResolver).use &#123; instrumentationManager -&gt;<br>                parameters.inputClassesDir.files.filter(File::exists).forEach &#123;<br>                  <span class="hljs-comment">//处理class</span><br>                    instrumentationManager.instrumentClassesFromDirectoryToDirectory(<br>                        it,<br>                        parameters.classesOutputDir.<span class="hljs-keyword">get</span>().asFile<br>                    )<br>                &#125;<br>               <span class="hljs-comment">//处理jar</span><br>                processJars(instrumentationManager)<br>            &#125;<br><br>            updateIncrementalState(emptySet(), classesHierarchyResolver)<br>        &#125;<br>          ... <br>        &#125;<br><br><span class="hljs-comment">//增量</span><br>    <span class="hljs-keyword">abstract</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">TransformClassesIncrementalAction</span>:<br>        <span class="hljs-type">TransformClassesWorkerAction</span>&lt;<span class="hljs-type">IncrementalWorkerParams</span>&gt;</span>() &#123;<br>        <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">run</span><span class="hljs-params">()</span></span> &#123;<br>          <span class="hljs-comment">//处理增量文件 状态为added &amp; modified</span><br>                classesChanges.addedFiles.plus(classesChanges.modifiedFiles).forEach &#123;<br>                    <span class="hljs-keyword">val</span> outputFile =<br>                        parameters.classesOutputDir.<span class="hljs-keyword">get</span>().asFile.resolve(it.normalizedPath)<br>                    instrumentationManager.instrumentModifiedFile(<br>                        inputFile = it.file,<br>                        outputFile = outputFile,<br>                        relativePath = it.normalizedPath<br>                    )<br>                &#125;<br>           <span class="hljs-comment">//处理jar</span><br>                processJars(instrumentationManager)          <br>        &#125;<br>          <br>     &#125;<br><br><span class="hljs-comment">//处理jar包</span><br>        <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">processJars</span><span class="hljs-params">(instrumentationManager: <span class="hljs-type">AsmInstrumentationManager</span>)</span></span> &#123;<br>         ...<br>                mappingState.jarsInfo.forEach &#123; (file, info) -&gt;<br>                    <span class="hljs-keyword">if</span> (info.hasChanged) &#123;<br>                        <span class="hljs-keyword">val</span> instrumentedJar =<br>                            File(parameters.jarsOutputDir.<span class="hljs-keyword">get</span>().asFile, info.identity + DOT_JAR)<br>                        FileUtils.deleteIfExists(instrumentedJar)<br>                        instrumentationManager.instrumentClassesFromJarToJar(file, instrumentedJar)<br>                    &#125;<br>                &#125;          <br>        &#125;<br></code></pre></td></tr></table></figure>
<p>以上<code>instrumentXX()</code>最终都指向<code>doInstrumentClass()</code></p>
<h5 id="AsmInstrumentationManager-doInstrumentClass"><a href="#AsmInstrumentationManager-doInstrumentClass" class="headerlink" title="AsmInstrumentationManager.doInstrumentClass"></a>AsmInstrumentationManager.doInstrumentClass</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doInstrumentClass</span><span class="hljs-params">(<br>    packageName: <span class="hljs-type">String</span>,<br>    className: <span class="hljs-type">String</span>,<br>    classInputStream: () -&gt; <span class="hljs-type">InputStream</span><br>)</span></span>: ByteArray? &#123;<br>  ...<br>  <span class="hljs-comment">//记录class相关信息</span><br>    <span class="hljs-keyword">val</span> classData = ClassDataLazyImpl(<br>        classFullName,<br>        &#123; classesHierarchyResolver.getAnnotations(classInternalName) &#125;,<br>        &#123; classesHierarchyResolver.getAllInterfaces(classInternalName) &#125;,<br>        &#123; classesHierarchyResolver.getAllSuperClasses(classInternalName) &#125;<br>    )      <br>  <span class="hljs-comment">//根据isInstrumentable 筛选所需classVisitor</span><br>    <span class="hljs-keyword">val</span> filteredVisitors = visitors.filter &#123; entry -&gt;<br>        entry.isInstrumentable(classData)<br>    &#125;.reversed()<br>  <br>  <span class="hljs-comment">//执行字节码处理</span><br>  ...<br>                            <span class="hljs-keyword">return</span><span class="hljs-symbol">@use</span> doInstrumentByteCode(<br>                                classContext,<br>                                byteCode,<br>                                filteredVisitors,<br>                                containsJsrOrRetInstruction = <span class="hljs-literal">true</span><br>                            )      <br>&#125;<br></code></pre></td></tr></table></figure>
<p>接下来执行自定义的 字节码处理逻辑</p>
<h5 id="AsmInstrumentationManager-doInstrumentByteCode"><a href="#AsmInstrumentationManager-doInstrumentByteCode" class="headerlink" title="AsmInstrumentationManager.doInstrumentByteCode"></a>AsmInstrumentationManager.doInstrumentByteCode</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-keyword">private</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">doInstrumentByteCode</span><span class="hljs-params">(<br>    classContext: <span class="hljs-type">ClassContext</span>,<br>    byteCode: <span class="hljs-type">ByteArray</span>,<br>    visitors: <span class="hljs-type">List</span>&lt;<span class="hljs-type">AsmClassVisitorFactory</span>&lt;*&gt;&gt;,<br>    containsJsrOrRetInstruction: <span class="hljs-type">Boolean</span><br>)</span></span>: ByteArray &#123;<br>    <span class="hljs-keyword">val</span> classReader = ClassReader(byteCode)<br>    <span class="hljs-keyword">val</span> classWriter =<br>        FixFramesClassWriter(<br>            classReader,<br>            getClassWriterFlags(containsJsrOrRetInstruction),<br>            classesHierarchyResolver<br>        )<br>    <span class="hljs-keyword">var</span> nextVisitor: ClassVisitor = classWriter<br><br>    <span class="hljs-keyword">if</span> (framesComputationMode == FramesComputationMode.COMPUTE_FRAMES_FOR_INSTRUMENTED_CLASSES) &#123;<br>        nextVisitor = MaxsInvalidatingClassVisitor(apiVersion, classWriter)<br>    &#125;<br><br>    <span class="hljs-keyword">val</span> originalVisitor = nextVisitor<br><br>    visitors.forEach &#123; entry -&gt;<br>        nextVisitor = entry.createClassVisitor(classContext, nextVisitor)<br>    &#125;<br><br>    <span class="hljs-comment">// No external visitor will instrument this class</span><br>    <span class="hljs-keyword">if</span> (nextVisitor == originalVisitor) &#123;<br>        <span class="hljs-keyword">return</span> byteCode<br>    &#125;<br><br>    classReader.accept(nextVisitor, getClassReaderFlags(containsJsrOrRetInstruction))<br>    <span class="hljs-keyword">return</span> classWriter.toByteArray()<br>&#125;<br></code></pre></td></tr></table></figure>
<p>在<code>doInstrumentByteCode</code>执行自定义处理逻辑</p>
<pre><code class=" mermaid">flowchart TD
TransformClassesWithAsmTask执行流程
a((开始))
b(doTaskAction)
a--&gt;b
c&#123;isIncremental\n是否增量编译?&#125;
b--&gt;c
d(doFullTaskAction)
c--全量编译--&gt;d
d1(执行\nTransformClassesFullAction)
d2(处理class/jar文件)
d--&gt;d1--&gt;d2

e(doIncrementalTaskAction)
c--增量编译--&gt;e
e1(TransformClassesIncrementalAction)
e2(处理增量class/jar文件\nFileStatus.NEW或FileStatus.CHANGED)
e--&gt;e1--&gt;e2

f(AsmInstrumentationManager\n.doInstrumentClass)
d2--&gt;f
e2--&gt;f

g(筛选isInstrumentable=true\n的AsmClassVisitorFactory)
h(AsmInstrumentationManager\n.doInstrumentByteCode)
f--&gt;g
g--&gt;h

i(执行自定义 字节码处理 逻辑)
h--&gt;i
j((结束))
i--&gt;j
</code></pre>
<h4 id="transformClassesWith"><a href="#transformClassesWith" class="headerlink" title="transformClassesWith"></a>transformClassesWith</h4><blockquote>
<p>通过<code>AndroidComponentsExtension</code>注册自定义的<code>AsmClassVisitorFactory</code>对象</p>
</blockquote>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//注册AsmClassVisitorFactory</span><br><br>        <span class="hljs-keyword">val</span> androidComponents = project.extensions.findByType(AndroidComponentsExtension::<span class="hljs-class"><span class="hljs-keyword">class</span>.<span class="hljs-title">java</span>)</span><br>        <span class="hljs-keyword">if</span>(androidComponents!=<span class="hljs-literal">null</span>)&#123;<br>            androidComponents.onVariants &#123;variant -&gt;<br>                println(<span class="hljs-string">"variant.name == <span class="hljs-subst">$&#123;variant.name&#125;</span>"</span>)<br>                variant.instrumentation.transformClassesWith(<br>                    ExampleClassVisitorFactory::<span class="hljs-class"><span class="hljs-keyword">class</span>.<span class="hljs-title">java</span>,<br>                    <span class="hljs-type">InstrumentationScope.ALL</span></span><br>                )&#123;<br>                    it.writeToStdout.<span class="hljs-keyword">set</span>(<span class="hljs-literal">true</span>)<br>                &#125;<br>                variant.instrumentation.setAsmFramesComputationMode(FramesComputationMode.COPY_FRAMES)<br>            &#125;<br>        &#125;<br></code></pre></td></tr></table></figure>
<p>AndroidComponentsExtension结构如下</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//AndroidComponentsExtension.kt</span><br><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">AndroidComponentsExtension</span>&lt;<span class="hljs-type"><br>        DslExtensionT: CommonExtension&lt;*, *, *, *</span>&gt;,<br>        <span class="hljs-type">VariantBuilderT: VariantBuilder</span>,<br>        <span class="hljs-type">VariantT: Variant&gt;</span></span><br>    : DslLifecycle&lt;DslExtensionT&gt;&#123;...&#125;<br><br><span class="hljs-comment">//Variant.kt</span><br><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Variant</span> : <span class="hljs-type">Component</span>, <span class="hljs-type">HasAndroidResources &#123;...&#125;</span></span><br><br><span class="hljs-comment">//Component.kt</span><br><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Component</span>: <span class="hljs-type">ComponentIdentity &#123;</span></span><br>  ...<br>   <span class="hljs-keyword">val</span> instrumentation: Instrumentation<br>&#125;<br><br><span class="hljs-comment">//Instrumentation.kt</span><br><span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">Instrumentation</span> </span>&#123;<br> ...<br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;ParamT : InstrumentationParameters&gt;</span> <span class="hljs-title">transformClassesWith</span><span class="hljs-params">(<br>        classVisitorFactoryImplClass: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">out</span> <span class="hljs-type">AsmClassVisitorFactory</span>&lt;<span class="hljs-type">ParamT</span>&gt;&gt;,<br>        scope: <span class="hljs-type">InstrumentationScope</span>,<br>        instrumentationParamsConfig: (<span class="hljs-type">ParamT</span>) -&gt; <span class="hljs-type">Unit</span><br>    )</span></span>  <br>&#125;<br><br><span class="hljs-comment">//实现类 InstrumentationImpl.kt</span><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">InstrumentationImpl</span></span>(<br>    services: TaskCreationServices,<br>    variantPropertiesApiServices: VariantPropertiesApiServices,<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> isLibraryVariant: <span class="hljs-built_in">Boolean</span><br>) : Instrumentation &#123;<br>   <span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> asmClassVisitorsRegistry = AsmClassVisitorsFactoryRegistry(services.issueReporter) <br>  <br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;ParamT : InstrumentationParameters&gt;</span> <span class="hljs-title">transformClassesWith</span><span class="hljs-params">(<br>        classVisitorFactoryImplClass: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">out</span> <span class="hljs-type">AsmClassVisitorFactory</span>&lt;<span class="hljs-type">ParamT</span>&gt;&gt;,<br>        scope: <span class="hljs-type">InstrumentationScope</span>,<br>        instrumentationParamsConfig: (<span class="hljs-type">ParamT</span>) -&gt; <span class="hljs-type">Unit</span><br>    )</span></span> &#123;<br>        <span class="hljs-keyword">if</span> (isLibraryVariant &amp;&amp; scope == InstrumentationScope.ALL) &#123;<br>            <span class="hljs-keyword">throw</span> RuntimeException(<br>                <span class="hljs-string">"Can't register <span class="hljs-subst">$&#123;classVisitorFactoryImplClass.name&#125;</span> to "</span> +<br>                        <span class="hljs-string">"instrument library dependencies.\n"</span> +<br>                        <span class="hljs-string">"Instrumenting library dependencies will have no effect on library "</span> +<br>                        <span class="hljs-string">"consumers, move the dependencies instrumentation to be done in the "</span> +<br>                        <span class="hljs-string">"consuming app or test component."</span><br>            )<br>        &#125;<br>        asmClassVisitorsRegistry.register(<br>            classVisitorFactoryImplClass,<br>            scope,<br>            instrumentationParamsConfig<br>        )<br>    &#125;  <br>  <br>&#125;<br></code></pre></td></tr></table></figure>
<h5 id="AsmClassVisitorsFactoryRegistry-register"><a href="#AsmClassVisitorsFactoryRegistry-register" class="headerlink" title="AsmClassVisitorsFactoryRegistry.register"></a>AsmClassVisitorsFactoryRegistry.register</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AsmClassVisitorsFactoryRegistry</span></span>(<span class="hljs-keyword">private</span> <span class="hljs-keyword">val</span> issueReporter: IssueReporter) &#123;<br>  <span class="hljs-comment">//class </span><br>    <span class="hljs-keyword">val</span> projectClassesVisitors =<br>        ArrayList&lt;AsmClassVisitorFactoryEntry&lt;<span class="hljs-keyword">out</span> InstrumentationParameters&gt;&gt;()<br>  <span class="hljs-comment">//jar</span><br>    <span class="hljs-keyword">val</span> dependenciesClassesVisitors =<br>        ArrayList&lt;AsmClassVisitorFactoryEntry&lt;<span class="hljs-keyword">out</span> InstrumentationParameters&gt;&gt;()<br>  <br>    <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-type">&lt;ParamT : InstrumentationParameters&gt;</span> <span class="hljs-title">register</span><span class="hljs-params">(<br>        classVisitorFactoryImplClass: <span class="hljs-type">Class</span>&lt;<span class="hljs-type">out</span> <span class="hljs-type">AsmClassVisitorFactory</span>&lt;<span class="hljs-type">ParamT</span>&gt;&gt;,<br>        scope: <span class="hljs-type">InstrumentationScope</span>,<br>        instrumentationParamsConfig: (<span class="hljs-type">ParamT</span>) -&gt; <span class="hljs-type">Unit</span><br>    )</span></span> &#123;<br>        <span class="hljs-keyword">val</span> visitorEntry = AsmClassVisitorFactoryEntry(<br>            classVisitorFactoryImplClass,<br>            instrumentationParamsConfig<br>        )<br>        <span class="hljs-keyword">if</span> (scope == InstrumentationScope.ALL) &#123;<br>          <span class="hljs-comment">//对依赖的aar/jar进行处理</span><br>            dependenciesClassesVisitors.add(visitorEntry)<br>        &#125;<br>      <span class="hljs-comment">//对依赖的module中class进行处理</span><br>        projectClassesVisitors.add(visitorEntry)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>通过<code>transformClassesWith</code>注册的<code>ClassVisitorFactory</code>最终记录在<code>projectClassesVisitors</code>中。</p>
<p><code>AsmClassVisitorsFactoryRegistry.projectClassesVisitors</code>–&gt;<code>InstrumentationImpl.registeredProjectClassesVisitors</code>–&gt;<code>ComponentImpl.registeredProjectClassesVisitors</code></p>
<h5 id="TransformClassesWithAsmTask-CreationAction-configure"><a href="#TransformClassesWithAsmTask-CreationAction-configure" class="headerlink" title="TransformClassesWithAsmTask.CreationAction.configure"></a>TransformClassesWithAsmTask.CreationAction.configure</h5><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs kotlin"><span class="hljs-comment">//TransformClassesWithAsmTask.kt</span><br>        <span class="hljs-keyword">protected</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">getInstrumentationManager</span><span class="hljs-params">(<br>            classesHierarchyResolver: <span class="hljs-type">ClassesHierarchyResolver</span><br>        )</span></span>: AsmInstrumentationManager &#123;<br>            <span class="hljs-keyword">return</span> AsmInstrumentationManager(<br>                visitors = parameters.visitorsList.<span class="hljs-keyword">get</span>(),<span class="hljs-comment">//外部注册的ClassVisitorFactory</span><br>                apiVersion = parameters.asmApiVersion.<span class="hljs-keyword">get</span>(),<br>                classesHierarchyResolver = classesHierarchyResolver,<br>                framesComputationMode = parameters.framesComputationMode.<span class="hljs-keyword">get</span>(),<br>                excludes = parameters.excludes.<span class="hljs-keyword">get</span>(),<br>                profilingTransforms = parameters.profilingTransforms.getOrElse(emptyList())<br>            )<br>        &#125;<br><br><br><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CreationAction</span></span>(<br>        component: ComponentImpl,<br>        <span class="hljs-keyword">val</span> isTestCoverageEnabled: <span class="hljs-built_in">Boolean</span><br>    ) : VariantTaskCreationAction&lt;TransformClassesWithAsmTask, ComponentImpl&gt;(<br>        component<br> ) &#123;<br>...<br>    <span class="hljs-keyword">override</span> <span class="hljs-function"><span class="hljs-keyword">fun</span> <span class="hljs-title">configure</span><span class="hljs-params">(task: <span class="hljs-type">TransformClassesWithAsmTask</span>)</span></span> &#123;<br>            <span class="hljs-keyword">super</span>.configure(task)<br>            task.incrementalFolder = creationConfig.paths.getIncrementalDir(task.name)<br><br>            task.visitorsList.setDisallowChanges(creationConfig.registeredProjectClassesVisitors)      <br>      ...<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<h3 id="优点-amp-缺点"><a href="#优点-amp-缺点" class="headerlink" title="优点&amp;缺点"></a>优点&amp;缺点</h3><h4 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h4><ul>
<li>不需要像<code>Transform</code>写一堆模版代码，包括全量/增量文件处理，jar包处理，<code>TransformClassesWithAsmTask</code>内部已实现相关逻辑</li>
<li>可注册多个<code>AsmClassVisitorFactory</code>，在一次IO过程中，进行多次处理，提升构建性能。</li>
</ul>
<h4 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h4><ul>
<li>内部实现与<code>ASM</code>绑定，需要有一定的认知了解</li>
<li>不像<code>Transform</code>那样灵活，可以进行除字节码处理以外的操作（基本也够用）</li>
</ul>
<h2 id="TransformAction"><a href="#TransformAction" class="headerlink" title="TransformAction"></a>TransformAction</h2><h2 id="参考链接"><a href="#参考链接" class="headerlink" title="参考链接"></a>参考链接</h2><p><a href="http://tools.android.com/tech-docs/new-build-system/transform-api" target="_blank" rel="noopener">Transform-API</a></p>
<p><a href="https://juejin.cn/post/7098752199575994405#heading-8" target="_blank" rel="noopener">Gradle-Transform 分析</a></p>
<p><a href="https://juejin.cn/post/7131889789787176974" target="_blank" rel="noopener">TransformAction介绍</a></p>
<p><a href="https://docs.gradle.org/current/userguide/artifact_transforms.html" target="_blank" rel="noopener">TransformAction-Gradle文档</a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/Gradle/">Gradle</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">
                  
                    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！
                  
                </p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2022/03/18/Gradle学习笔记-AGP原理/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Gradle学习笔记-AGP原理</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2022/01/25/OpenGL-环境配置/">
                        <span class="hidden-mobile">OpenGL-环境配置</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>


  <!-- SCRIPTS -->
  
  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  <script  src="/js/local-search.js" ></script>



  
    <script  src="/js/img-lazyload.js" ></script>
  



  



  
    <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>
  
  
    <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>
  
  
    <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>
  














  <script  src="https://cdn.jsdelivr.net/npm/mermaid@8.8.3/dist/mermaid.min.js" ></script>
  <script>
    if (window.mermaid) {
      mermaid.initialize({"theme":"default"});
    }
  </script>







<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>


</body>
</html>
