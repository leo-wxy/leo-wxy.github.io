

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=&#34;auto&#34;>



<head><meta name="generator" content="Hexo 3.9.0">
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" type="image/png" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#11527b">
  <meta name="description" content="如果我没有见过光明，那我本可以忍受黑暗">
  <meta name="author" content="Leo-Wxy">
  <meta name="keywords" content="">
  <title>Jetpack-Lifecycle简析 - Wxy的个人博客</title>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css">


  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/github-markdown-css@4.0.0/github-markdown.min.css">
  <link rel="stylesheet" href="/lib/hint/hint.min.css">

  
    
    
      
      <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@10.4.0/styles/atom-one-light.min.css">
    
  

  
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css">
  



<!-- 主题依赖的图标库，不要自行修改 -->
<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_ba1fz6golrf.css">

<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_kmeydafke9r.css">

<link rel="stylesheet" href="/css/main.css">

<!-- 自定义样式保持在最底部 -->


  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    var CONFIG = {"hostname":"leo-wxy.github.io","root":"/","version":"1.8.7","typing":{"enable":false,"typeSpeed":70,"cursorChar":"_","loop":false},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"always","icon":"#"},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"copy_btn":true,"image_zoom":{"enable":true},"toc":{"enable":true,"headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"onlypost":false},"web_analytics":{"enable":false,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null}}};
  </script>
  <script src="/js/utils.js"></script>
  <script src="/js/color-schema.js"></script>
</head>


<body>
  <header style="height: 30vh;">
    <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand"
       href="/">&nbsp;<strong>Wxy's Blog</strong>&nbsp;</a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                归档
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/">
                <i class="iconfont icon-tags-fill"></i>
                标签
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/">
                <i class="iconfont icon-link-fill"></i>
                友链
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" data-toggle="modal" data-target="#modalSearch">&nbsp;<i
                class="iconfont icon-search"></i>&nbsp;</a>
          </li>
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" href="javascript:">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

    <div class="banner" id="banner" parallax=true
         style="background: url('/img/default.png') no-repeat center center;
           background-size: cover;">
      <div class="full-bg-img">
        <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
          <div class="page-header text-center fade-in-up">
            <span class="h2" id="subtitle" title="Jetpack-Lifecycle简析">
              
                Jetpack-Lifecycle简析
              
            </span>

            
              <div class="mt-3">
  
  
    <span class="post-meta">
      <i class="iconfont icon-date-fill" aria-hidden="true"></i>
      <time datetime="2019-02-15 17:01" pubdate>
        2019年2月15日 下午
      </time>
    </span>
  
</div>

<div class="mt-1">
  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-chart"></i>
      3.5k 字
    </span>
  

  
    
    <span class="post-meta mr-2">
      <i class="iconfont icon-clock-fill"></i>
      
      
      53
       分钟
    </span>
  

  
  
</div>

            
          </div>

          
        </div>
      </div>
    </div>
  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="d-none d-lg-block col-lg-2"></div>
    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div class="py-5" id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">Jetpack-Lifecycle简析</h1>
            
            <div class="markdown-body">
              <p><img src="/images/Lifecycle原理分析.png" srcset="/img/loading.gif" alt="Lifecycle原理分析"></p>
<h2 id="Lifecycle简介"><a href="#Lifecycle简介" class="headerlink" title="Lifecycle简介"></a>Lifecycle简介</h2><p>Google官方提供的一个<strong>生命周期感知组件</strong>。可以由引用组件自己进行生命周期管理，从而减少内存泄露以及异常的可能性。</p>
<p><strong>让我们自己创建的对象也可以感知到Android组件的生命周期。</strong></p>
<p>核心设计模式<strong>观察者模式</strong>。</p>
<h2 id="Lifecycle使用示例"><a href="#Lifecycle使用示例" class="headerlink" title="Lifecycle使用示例"></a>Lifecycle使用示例</h2><p>先构建需要监听生命周期的组件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> class LifeCycleComponent implements LifecycleObserver &#123;<br>    @OnLifecycleEvent(Lifecycle.Event.ON_CREATE)<br>    <span class="hljs-keyword">void</span> onCreate()&#123;<br><br>    &#125;<br><br>    @OnLifecycleEvent(Lifecycle.Event.ON_PAUSE)<br>    <span class="hljs-keyword">void</span> onPause()&#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>在Activity/Fragment中引用该组件并绑定生命周期</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> class NewActivity extends AppCompatActivity &#123;<br>   <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> onCreate(@Nullable Bundle savedInstanceState) &#123;<br>   		<span class="hljs-keyword">super</span>.onCreate(savedInstanceState);<br>        getLifecycle().addObserver(new LifeCycleComponent());<br>   &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>更多使用示例可参考<a href="https://developer.android.google.cn/topic/libraries/architecture/lifecycle#codelabs" target="_blank" rel="noopener">官方Lifecycle示例</a></p>
<h2 id="Lifecycle源码解析"><a href="#Lifecycle源码解析" class="headerlink" title="Lifecycle源码解析"></a>Lifecycle源码解析</h2><p><img src="/images/Lifecycle-源码解析.png" srcset="/img/loading.gif" alt="源码解析"></p>
<h3 id="LifecycleObserver"><a href="#LifecycleObserver" class="headerlink" title="LifecycleObserver"></a>LifecycleObserver</h3><p><img src="/images/Lifecycle-LifecycleObserver.png" srcset="/img/loading.gif" alt="Lifecycle-LifecycleObserver"></p>
<blockquote>
<p>属于观察者模式的<strong>观察者</strong>，负责接受生命周期事件。需要监听生命周期的组件都需要实现该接口。</p>
</blockquote>
<figure class="highlight java"><figcaption><span>LifecycleObserver.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">/**<br> * Marks a class as a LifecycleObserver. It does not have any methods, instead, relies on<br> * &#123;@link OnLifecycleEvent&#125; annotated methods.<br> */<br><span class="hljs-keyword">public</span> interface LifecycleObserver &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure>
<p>内部未提供任何方法，需要监听生命周期的话就采用<code>OnLifecycleEvent</code>去实现</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java">//运行时注解<br>@Retention(RetentionPolicy.RUNTIME)<br>//只支持注解方法<br>@Target(ElementType.METHOD)<br><span class="hljs-keyword">public</span> @interface OnLifecycleEvent &#123;<br>    Lifecycle.Event value();<br>&#125;<br></code></pre></td></tr></table></figure>
<p>至此定义完成了需要取得监听结果的对象以及需要监听的生命周期</p>
<h3 id="Lifecycle"><a href="#Lifecycle" class="headerlink" title="Lifecycle"></a>Lifecycle</h3><p><img src="/images/Lifecycle-Lifecycle.png" srcset="/img/loading.gif" alt="Lifecycle-Lifecycle"></p>
<blockquote>
<p>属于观察者模式中的<strong>被观察者</strong>，负责接受生命周期监听事件，并分发到观察者<code>LifecycleObserver</code>中。</p>
</blockquote>
<figure class="highlight java"><figcaption><span>Lifecycle.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> class Lifecycle &#123;<br>    //添加观察者<br>    @MainThread<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> addObserver(@NonNull LifecycleObserver observer);<br>    //移除观察者<br>    @MainThread<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> <span class="hljs-keyword">void</span> removeObserver(@NonNull LifecycleObserver observer);<br>    //获取当前生命周期状态<br>    @MainThread<br>    @NonNull<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">abstract</span> State getCurrentState();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> Event &#123;<br>        /**<br>         * Constant <span class="hljs-keyword">for</span> onCreate event of the &#123;@link LifecycleOwner&#125;.<br>         */<br>        ON_CREATE,<br>        /**<br>         * Constant <span class="hljs-keyword">for</span> onStart event of the &#123;@link LifecycleOwner&#125;.<br>         */<br>        ON_START,<br>        /**<br>         * Constant <span class="hljs-keyword">for</span> onResume event of the &#123;@link LifecycleOwner&#125;.<br>         */<br>        ON_RESUME,<br>        /**<br>         * Constant <span class="hljs-keyword">for</span> onPause event of the &#123;@link LifecycleOwner&#125;.<br>         */<br>        ON_PAUSE,<br>        /**<br>         * Constant <span class="hljs-keyword">for</span> onStop event of the &#123;@link LifecycleOwner&#125;.<br>         */<br>        ON_STOP,<br>        /**<br>         * Constant <span class="hljs-keyword">for</span> onDestroy event of the &#123;@link LifecycleOwner&#125;.<br>         */<br>        ON_DESTROY,<br>        /**<br>         * An &#123;@link Event Event&#125; constant that can be used to match all events.<br>         */<br>        ON_ANY<br>    &#125;<br><br>    /**<br>     * Lifecycle states. You can consider the states as the nodes in a graph and<br>     * &#123;@link Event&#125;s as the edges between these nodes.<br>     */<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">enum</span> State &#123;<br>        /**<br>         * Destroyed state <span class="hljs-keyword">for</span> a LifecycleOwner. After <span class="hljs-keyword">this</span> event, <span class="hljs-keyword">this</span> Lifecycle will not dispatch<br>         * any more events. For instance, <span class="hljs-keyword">for</span> an &#123;@link android.app.Activity&#125;, <span class="hljs-keyword">this</span> state is reached<br>         * &lt;b&gt;right before&lt;/b&gt; Activity's &#123;@link android.app.Activity#onDestroy() onDestroy&#125; call.<br>         */<br>        DESTROYED,<br><br>        /**<br>         * Initialized state <span class="hljs-keyword">for</span> a LifecycleOwner. For an &#123;@link android.app.Activity&#125;, <span class="hljs-keyword">this</span> is<br>         * the state when it is constructed but has not received<br>         * &#123;@link android.app.Activity#onCreate(android.os.Bundle) onCreate&#125; yet.<br>         */<br>        INITIALIZED,<br><br>        /**<br>         * Created state <span class="hljs-keyword">for</span> a LifecycleOwner. For an &#123;@link android.app.Activity&#125;, <span class="hljs-keyword">this</span> state<br>         * is reached in two cases:<br>         * &lt;ul&gt;<br>         *     &lt;li&gt;after &#123;@link android.app.Activity#onCreate(android.os.Bundle) onCreate&#125; call;<br>         *     &lt;li&gt;&lt;b&gt;right before&lt;/b&gt; &#123;@link android.app.Activity#onStop() onStop&#125; call.<br>         * &lt;/ul&gt;<br>         */<br>        CREATED,<br><br>        /**<br>         * Started state <span class="hljs-keyword">for</span> a LifecycleOwner. For an &#123;@link android.app.Activity&#125;, <span class="hljs-keyword">this</span> state<br>         * is reached in two cases:<br>         * &lt;ul&gt;<br>         *     &lt;li&gt;after &#123;@link android.app.Activity#onStart() onStart&#125; call;<br>         *     &lt;li&gt;&lt;b&gt;right before&lt;/b&gt; &#123;@link android.app.Activity#onPause() onPause&#125; call.<br>         * &lt;/ul&gt;<br>         */<br>        STARTED,<br><br>        /**<br>         * Resumed state <span class="hljs-keyword">for</span> a LifecycleOwner. For an &#123;@link android.app.Activity&#125;, <span class="hljs-keyword">this</span> state<br>         * is reached after &#123;@link android.app.Activity#onResume() onResume&#125; is called.<br>         */<br>        RESUMED;<br><br>        /**<br>         * Compares <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span> State is greater or equal to the given &#123;@code state&#125;.<br>         *<br>         * @param state State to compare with<br>         * @return <span class="hljs-keyword">true</span> <span class="hljs-keyword">if</span> <span class="hljs-keyword">this</span> State is greater or equal to the given &#123;@code state&#125;<br>         */<br>        <span class="hljs-keyword">public</span> <span class="hljs-keyword">boolean</span> isAtLeast(@NonNull State state) &#123;<br>            return compareTo(state) &gt;= 0;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><img src="/images/lifecycle-states.svg" srcset="/img/loading.gif" alt="生命周期状态示意图"></p>
<h3 id="LifecycleOwner"><a href="#LifecycleOwner" class="headerlink" title="LifecycleOwner"></a>LifecycleOwner</h3><p><img src="/images/Lifecycle-LifecycleOwner.png" srcset="/img/loading.gif" alt="Lifecycle-LifecycleOwner"></p>
<p>定义好自定义组件后就需要将其与Activity/Fragment进行绑定。此时就需要去获取其内部的<code>lifecycle</code>对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> interface LifecycleOwner &#123;<br>    Lifecycle getLifecycle();<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>LifecycleOwner</code>只提供一个<code>getLifecycle()</code>获取<code>lifecycle</code>对象。</p>
<p>在Activity/Fragment中，可以直接调用到<code>getLifecycle()</code>进行获取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> class FragmentActivity extends ComponentActivity implements<br>    ViewModelStoreOwner&#123;<br>    ...<br>&#125;<br><br><span class="hljs-keyword">public</span> class ComponentActivity extends Activity<br>        implements LifecycleOwner, KeyEventDispatcher.Component &#123;<br>    ...<br>    <span class="hljs-keyword">private</span> LifecycleRegistry mLifecycleRegistry = new LifecycleRegistry(<span class="hljs-keyword">this</span>);<br>    ...<br>    @Override<br>    <span class="hljs-keyword">public</span> Lifecycle getLifecycle() &#123;<br>        return mLifecycleRegistry;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> class Fragment implements ComponentCallbacks, OnCreateContextMenuListener, LifecycleOwner,<br>ViewModelStoreOwner &#123;<br>    ...<br>    LifecycleRegistry mLifecycleRegistry = new LifecycleRegistry(<span class="hljs-keyword">this</span>);<br>    ...<br>    @Override<br>    <span class="hljs-keyword">public</span> Lifecycle getLifecycle() &#123;<br>        return mLifecycleRegistry;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>在<code>FragmentActivity</code>及<code>Fragment</code>中都已默认实现了<code>LifecycleOwner</code>接口，就无需开发者自己实现。</p>
<h3 id="LifecycleRegistry"><a href="#LifecycleRegistry" class="headerlink" title="LifecycleRegistry"></a>LifecycleRegistry</h3><p><img src="/images/Lifecycle-LifecycleRegistry.png" srcset="/img/loading.gif" alt="Lifecycle-LifecycleRegistry"></p>
<blockquote>
<p>Lifecycle抽象类的唯一核心功能实现类，由它实现了生命周期绑定及添加/移除监听功能。</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> class LifecycleRegistry extends Lifecycle &#123;<br>  //观察者集合<br>    <span class="hljs-keyword">private</span> FastSafeIterableMap&lt;LifecycleObserver, ObserverWithState&gt; mObserverMap =<br>            new FastSafeIterableMap&lt;&gt;();<br>  //当前lifecycle状态<br>    <span class="hljs-keyword">private</span> State mState;<br>  //弱引用包住 lifecycleOwner ，避免发生内存泄漏<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> WeakReference&lt;LifecycleOwner&gt; mLifecycleOwner;<br>  <br>  ...<br>&#125;<br></code></pre></td></tr></table></figure>
<p><img src="/images/Lifecycle四个类的关系.jpg" srcset="/img/loading.gif" alt="四个类的关系"></p>
<h3 id="关键流程分析"><a href="#关键流程分析" class="headerlink" title="关键流程分析"></a>关键流程分析</h3><p>先分析在Activity/Fragment中是如何使用<code>LifecycleRegistry</code>，后续分析功能实现。</p>
<p><img src="/images/Lifecycle-关键流程分析.png" srcset="/img/loading.gif" alt="Lifecycle-关键流程分析"></p>
<h4 id="Fragment绑定"><a href="#Fragment绑定" class="headerlink" title="Fragment绑定"></a>Fragment绑定</h4><p><img src="/images/Lifecycle-Fragment绑定流程.png" srcset="/img/loading.gif" alt="Fragment绑定"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> class Fragment implements ComponentCallbacks, OnCreateContextMenuListener, LifecycleOwner,<br>        ViewModelStoreOwner &#123;<br>    ...<br>    LifecycleRegistry mLifecycleRegistry = new LifecycleRegistry(<span class="hljs-keyword">this</span>);<br>    ...<br>    @Override<br>    <span class="hljs-keyword">public</span> Lifecycle getLifecycle() &#123;<br>        return mLifecycleRegistry;<br>    &#125;<br>            <br>    ...<br>    <span class="hljs-keyword">void</span> performCreate(Bundle savedInstanceState) &#123;<br>        <span class="hljs-keyword">if</span> (mChildFragmentManager != <span class="hljs-keyword">null</span>) &#123;<br>            mChildFragmentManager.noteStateNotSaved();<br>        &#125;<br>        //标记当前Lifecycle.State为CREATED<br>        mState = CREATED;<br>        mCalled = <span class="hljs-keyword">false</span>;<br>        onCreate(savedInstanceState);<br>        mIsCreated = <span class="hljs-keyword">true</span>;<br>        //回调 ON_CREATE<br>        mLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_CREATE);<br>    &#125;<br>            <br>    <span class="hljs-keyword">void</span> performStart() &#123;<br>        mState = STARTED;<br>        mCalled = <span class="hljs-keyword">false</span>;<br>        onStart();<br>        <span class="hljs-keyword">if</span> (mChildFragmentManager != <span class="hljs-keyword">null</span>) &#123;<br>            mChildFragmentManager.dispatchStart();<br>        &#125;<br>        //回调ON_START<br>        mLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_START);<br>        <span class="hljs-keyword">if</span> (mView != <span class="hljs-keyword">null</span>) &#123;<br>            mViewLifecycleRegistry.handleLifecycleEvent(Lifecycle.Event.ON_START);<br>        &#125;<br>    &#125;        <br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>Fragment</code>通过<code>LifecycleRegistry.handleLifecycleEvent()</code>进行了生命周期绑定。</p>
<h4 id="Activity绑定"><a href="#Activity绑定" class="headerlink" title="Activity绑定"></a>Activity绑定</h4><p><img src="/images/Lifecycle-Activity绑定流程.png" srcset="/img/loading.gif" alt="Lifecycle-Activity绑定流程"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> class ComponentActivity extends Activity<br>        implements LifecycleOwner, KeyEventDispatcher.Component &#123;<br>        ...<br>    <span class="hljs-keyword">private</span> LifecycleRegistry mLifecycleRegistry = new LifecycleRegistry(<span class="hljs-keyword">this</span>);<br>        @Override<br>    @SuppressWarnings("RestrictedApi")<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> onCreate(@Nullable Bundle savedInstanceState) &#123;<br>        <span class="hljs-keyword">super</span>.onCreate(savedInstanceState);<br>        ReportFragment.injectIfNeededIn(<span class="hljs-keyword">this</span>);<br>    &#125;<br><br>    @CallSuper<br>    @Override<br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> onSaveInstanceState(Bundle outState) &#123;<br>        mLifecycleRegistry.markState(Lifecycle.State.CREATED);<br>        <span class="hljs-keyword">super</span>.onSaveInstanceState(outState);<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>
<p>如果绑定在Activity上，就需要通过动态添加一个<code>ReportFragment</code>去绑定生命周期</p>
<figure class="highlight java"><figcaption><span>ReportFragment.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> class ReportFragment extends Fragment &#123;<br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> injectIfNeededIn(Activity activity) &#123;<br>        // ProcessLifecycleOwner should always correctly work and some activities may not extend<br>        // FragmentActivity from support lib, so we use framework fragments <span class="hljs-keyword">for</span> activities<br>        android.app.FragmentManager manager = activity.getFragmentManager();<br>        //创建自身并加入宿主Activity<br>        <span class="hljs-keyword">if</span> (manager.findFragmentByTag(REPORT_FRAGMENT_TAG) == <span class="hljs-keyword">null</span>) &#123;<br>            manager.beginTransaction().add(new ReportFragment(), REPORT_FRAGMENT_TAG).commit();<br>            // Hopefully, we are the first to make a transaction.<br>            manager.executePendingTransactions();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">static</span> ReportFragment get(Activity activity) &#123;<br>        //获取自身实例<br>        return (ReportFragment) activity.getFragmentManager().findFragmentByTag(<br>                REPORT_FRAGMENT_TAG);<br>    &#125;<br>    <br>    @Override<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> onActivityCreated(Bundle savedInstanceState) &#123;<br>        <span class="hljs-keyword">super</span>.onActivityCreated(savedInstanceState);<br>        dispatchCreate(mProcessListener);<br>        //分发ON_CREATE事件<br>        dispatch(Lifecycle.Event.ON_CREATE);<br>    &#125;<br><br>    @Override<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> onStart() &#123;<br>        <span class="hljs-keyword">super</span>.onStart();<br>        dispatchStart(mProcessListener);<br>        //分发ON_START事件<br>        dispatch(Lifecycle.Event.ON_START);<br>    &#125;<br>    <br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> dispatch(Lifecycle.Event event) &#123;<br>        Activity activity = getActivity();<br>        <span class="hljs-keyword">if</span> (activity <span class="hljs-keyword">instanceof</span> LifecycleRegistryOwner) &#123;<br>            ((LifecycleRegistryOwner) activity).getLifecycle().handleLifecycleEvent(event);<br>            return;<br>        &#125;<br>        //指代了 ComponentActivity<br>        <span class="hljs-keyword">if</span> (activity <span class="hljs-keyword">instanceof</span> LifecycleOwner) &#123;<br>            Lifecycle lifecycle = ((LifecycleOwner) activity).getLifecycle();<br>            <span class="hljs-keyword">if</span> (lifecycle <span class="hljs-keyword">instanceof</span> LifecycleRegistry) &#123;<br>                ((LifecycleRegistry) lifecycle).handleLifecycleEvent(event);<br>            &#125;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p>Activity的生命周期监听需要依赖动态添加进的<code>ReportFragment</code>的生命周期进行回调。</p>
<h4 id="注册-注销观察者"><a href="#注册-注销观察者" class="headerlink" title="注册/注销观察者"></a>注册/注销观察者</h4><p><img src="/images/Lifecycle-注册监听流程.png" srcset="/img/loading.gif" alt="Lifecycle-注册监听流程"></p>
<p>通过<code>addObserver()/removeObserver()</code>控制观察者的添加与移除</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><code class="hljs java"> @Override<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> addObserver(@NonNull LifecycleObserver observer) &#123;<br>        //计算初始状态 默认初始状态是 INITALIZED<br>        State initialState = mState == DESTROYED ? DESTROYED : INITIALIZED;<br>        //封装ObserverWithState状态<br>        ObserverWithState statefulObserver = new ObserverWithState(observer, initialState);<br>        //从缓存中获取 observer这个key对应的值<br>        ObserverWithState previous = mObserverMap.putIfAbsent(observer, statefulObserver);<br>        //防止重复加入<br>        <span class="hljs-keyword">if</span> (previous != <span class="hljs-keyword">null</span>) &#123;<br>            return;<br>        &#125;<br>        LifecycleOwner lifecycleOwner = mLifecycleOwner.get();<br>        <span class="hljs-keyword">if</span> (lifecycleOwner == <span class="hljs-keyword">null</span>) &#123;<br>            // it is <span class="hljs-keyword">null</span> we should be destroyed. Fallback quickly<br>            return;<br>        &#125;<br><br>        <span class="hljs-keyword">boolean</span> isReentrance = mAddingObserverCounter != 0 || mHandlingEvent;<br>        //计算当前lifecycle的状态<br>        State targetState = calculateTargetState(observer);<br>        mAddingObserverCounter++;<br>        <span class="hljs-keyword">while</span> ((statefulObserver.mState.compareTo(targetState) &lt; 0<br>                &amp;&amp; mObserverMap.contains(observer))) &#123;<br>            pushParentState(statefulObserver.mState);<br>          //分发Event<br>            statefulObserver.dispatchEvent(lifecycleOwner, upEvent(statefulObserver.mState));<br>          //删除自身状态<br>            popParentState();<br>            // 在回调时可能用户操作导致发生变化<br>            targetState = calculateTargetState(observer);<br>        &#125;<br>        //是否重入，<br>        <span class="hljs-keyword">if</span> (!isReentrance) &#123;<br>            // we <span class="hljs-keyword">do</span> sync only on the top level.<br>            sync();<br>        &#125;<br>        mAddingObserverCounter--;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> State calculateTargetState(LifecycleObserver observer) &#123;<br>        Entry&lt;LifecycleObserver, ObserverWithState&gt; previous = mObserverMap.ceil(observer);<br><br>        State siblingState = previous != <span class="hljs-keyword">null</span> ? previous.getValue().mState : <span class="hljs-keyword">null</span>;<br>        State parentState = !mParentStates.isEmpty() ? mParentStates.get(mParentStates.size() - 1)<br>                : <span class="hljs-keyword">null</span>;<br>        // 返回最小的 state<br>        return min(min(mState, siblingState), parentState);<br>    &#125;<br><br><br><span class="hljs-keyword">static</span> class ObserverWithState &#123;<br>    //保存当前Observer的状态<br>    State mState;<br>    //源Observer的包装类<br>    GenericLifecycleObserver mLifecycleObserver;<br><br>    ObserverWithState(LifecycleObserver observer, State initialState) &#123;<br>        //生成一个原Observer的包装类<br>        mLifecycleObserver = Lifecycling.getCallback(observer);<br>        mState = initialState;<br>    &#125;<br>    //该方法将生命周期事件分发到LifecycleObserver中<br>    <span class="hljs-keyword">void</span> dispatchEvent(LifecycleOwner owner, Event event) &#123;<br>        State newState = getStateAfter(event);<br>        mState = min(mState, newState);<br>        //调用包装类的onStateChanged方法，传递生命周期事件到Observer中<br>        mLifecycleObserver.onStateChanged(owner, event);<br>        mState = newState;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>addObserver()</code>主要执行以下几步：</p>
<ol>
<li>封装<code>ObserverWithState</code>类型，包括<code>State</code>和<code>LifecycleObserver</code></li>
<li>判断<code>isReentrance</code>，表示<code>是否重入</code>，理解为<em>当前是否有执行<code>addObserver()</code>或有其他Event在处理</em></li>
<li>执行<code>while循环</code>负责<strong>对齐观察者和宿主的生命周期</strong>，将<code>observer</code>的<code>State</code>对齐<code>LifecycleOwner</code>的<code>State</code>。(例如在<code>onPause()</code>注册的<code>LifecycleOwner</code>，可以在注册的时候，立刻回调到<code>ON_CREATE</code>事件。)——<strong>建议在<code>onCreate()</code>调用<code>addObserver()</code></strong></li>
<li>若<code>isReentrance==false</code>，继续向下执行<code>sync()</code></li>
</ol>
<h4 id="生命周期事件的分发"><a href="#生命周期事件的分发" class="headerlink" title="生命周期事件的分发"></a>生命周期事件的分发</h4><p><img src="/images/Lifecycle-事件分发流程.png" srcset="/img/loading.gif" alt="Lifecycle-事件分发流程"></p>
<p>观察上述源码发现，每触发一个生命周期都会响应到<code>LifecycleRegistry.handleLifecycleEvent()</code></p>
<figure class="highlight java"><figcaption><span>LifecycleRegistry.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> handleLifecycleEvent(@NonNull Lifecycle.Event event) &#123;<br>    //根据当前收到的生命周期状态获取事件发生后的后续状态<br>    State next = getStateAfter(event);<br>    moveToState(next);<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> moveToState(State next) &#123;<br>    <span class="hljs-keyword">if</span> (mState == next) &#123;<br>        return;<br>    &#125;<br>    mState = next;<br>    //处于未同步状态则返回<br>    <span class="hljs-keyword">if</span> (mHandlingEvent || mAddingObserverCounter != 0) &#123;<br>        mNewEventOccurred = <span class="hljs-keyword">true</span>;<br>        // we will figure out what to <span class="hljs-keyword">do</span> on upper level.<br>        return;<br>    &#125;<br>    mHandlingEvent = <span class="hljs-keyword">true</span>;<br>    //执行同步方法，把所有的State转成Event<br>    sync();<br>    mHandlingEvent = <span class="hljs-keyword">false</span>;<br>&#125;<br><br><span class="hljs-keyword">static</span> State getStateAfter(Event event) &#123;<br>    <span class="hljs-keyword">switch</span> (event) &#123;<br>        <span class="hljs-keyword">case</span> ON_CREATE:<br>        <span class="hljs-keyword">case</span> ON_STOP:<br>            return CREATED;<br>        <span class="hljs-keyword">case</span> ON_START:<br>        <span class="hljs-keyword">case</span> ON_PAUSE:<br>            return STARTED;<br>        <span class="hljs-keyword">case</span> ON_RESUME:<br>            return RESUMED;<br>        <span class="hljs-keyword">case</span> ON_DESTROY:<br>            return DESTROYED;<br>        <span class="hljs-keyword">case</span> ON_ANY:<br>            <span class="hljs-keyword">break</span>;<br>    &#125;<br>    throw new IllegalArgumentException("Unexpected event value " + event);<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>handleLifecycleEvent()</code>主要执行以下几步：</p>
<ol>
<li>通过<code>getStateAfter()</code>将传进来的<code>Event</code>转化为<code>State</code></li>
<li>再通过<code>moveToState()</code>调用到<code>sync()</code>同步状态</li>
</ol>
<h4 id="同步状态——sync"><a href="#同步状态——sync" class="headerlink" title="同步状态——sync()"></a>同步状态——<code>sync()</code></h4><p><img src="/images/Lifecycle-同步状态流程.png" srcset="/img/loading.gif" alt="Lifecycle-同步状态流程"></p>
<p>设置状态完毕后需要同步所有的状态(<code>Status</code>)。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs java">//Lifecycle自定义的数据结构，类似HashMap<br><span class="hljs-keyword">private</span> FastSafeIterableMap&lt;LifecycleObserver, ObserverWithState&gt; mObserverMap =<br>        new FastSafeIterableMap&lt;&gt;();<br><br><br>// happens only on the top of stack (never in reentrance),<br>// so it doesn't have to take in account parents<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> sync() &#123;<br>    LifecycleOwner lifecycleOwner = mLifecycleOwner.get();<br>    <span class="hljs-keyword">if</span> (lifecycleOwner == <span class="hljs-keyword">null</span>) &#123;<br>        Log.w(LOG_TAG, "LifecycleOwner is garbage collected, you shouldn't <span class="hljs-keyword">try</span> dispatch "<br>                + "new events from it.");<br>        return;<br>    &#125;<br>    <span class="hljs-keyword">while</span> (!isSynced()) &#123;<br>        // mNewEventOccurred 是为了在 observer 触发状态变化时让 backwardPass/forwardPass()<br>        // 提前返回用的。我们刚准备调他们，这里设置为 <span class="hljs-keyword">false</span> 即可。<br>        mNewEventOccurred = <span class="hljs-keyword">false</span>;<br>        // no need to check eldest <span class="hljs-keyword">for</span> nullability, because isSynced does it <span class="hljs-keyword">for</span> us.<br>        <span class="hljs-keyword">if</span> (mState.compareTo(mObserverMap.eldest().getValue().mState) &lt; 0) &#123;<br>            // mObserverMap 里的元素的状态是非递增排列的，也就是说，队头的 state 最大<br>            // 如果 mState 小于队列里最大的那个，说明有元素需要更新状态<br>            // 为了维持 mObserverMap 的 Invariant，这里我们需要从队尾往前更新元素的状态<br>            backwardPass(lifecycleOwner);<br>        &#125;<br>        Entry&lt;LifecycleObserver, ObserverWithState&gt; newest = mObserverMap.newest();<br>        // 如果 mNewEventOccurred，说明在上面调用 backwardPass() 时，客户触发了状态修改<br>        <span class="hljs-keyword">if</span> (!mNewEventOccurred &amp;&amp; newest != <span class="hljs-keyword">null</span><br>                &amp;&amp; mState.compareTo(newest.getValue().mState) &gt; 0) &#123;<br>            forwardPass(lifecycleOwner);<br>        &#125;<br>    &#125;<br>    mNewEventOccurred = <span class="hljs-keyword">false</span>;<br>&#125;<br><br>// 如果所有的 observer 的状态都已经同步完，则返回 <span class="hljs-keyword">true</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> isSynced() &#123;<br>    <span class="hljs-keyword">if</span> (mObserverMap.size() == 0) &#123;<br>        return <span class="hljs-keyword">true</span>;<br>    &#125;<br>    //获取最大状态<br>    State eldestObserverState = mObserverMap.eldest().getValue().mState;<br>    //获取最小状态<br>    State newestObserverState = mObserverMap.newest().getValue().mState;<br>    // 因为我们保证队头的 state &gt;= 后面的元素的 state，所以只要判断头尾就够了<br>    return eldestObserverState == newestObserverState &amp;&amp; mState == newestObserverState;<br>&#125;<br></code></pre></td></tr></table></figure>
<p><code>sync()</code>时发现状态不一致，就需要进行向前或向后的变化。</p>
<p>使用当前Lifecycle的<code>mState</code>和<code>mObserverMap</code>的最大值进行比较，如果当前<code>mState</code>较小，需要进行递减状态<code>backwardPass()</code></p>
<p>使用当前Lifecycle的<code>mState</code>和<code>mObserverMap</code>的最小值进行比较，如果当前<code>mState</code>较大，需要进行递增状态<code>forwardPass()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">private</span> ArrayList&lt;State&gt; mParentStates = new ArrayList&lt;&gt;();<br><br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> forwardPass(LifecycleOwner lifecycleOwner) &#123;<br>        // 从队头开始迭代<br>        Iterator&lt;Entry&lt;LifecycleObserver, ObserverWithState&gt;&gt; ascendingIterator =<br>                mObserverMap.iteratorWithAdditions();<br>        <span class="hljs-keyword">while</span> (ascendingIterator.hasNext() &amp;&amp; !mNewEventOccurred) &#123;<br>            Entry&lt;LifecycleObserver, ObserverWithState&gt; entry = ascendingIterator.next();<br>            ObserverWithState observer = entry.getValue();<br>            //当前observer的state值小于mState，则需递增当前状态到mState<br>            <span class="hljs-keyword">while</span> ((observer.mState.compareTo(mState) &lt; 0 &amp;&amp; !mNewEventOccurred<br>                    // 可能在回调客户代码的时候，客户把自己移除了<br>                    &amp;&amp; mObserverMap.contains(entry.getKey()))) &#123;<br>                pushParentState(observer.mState);<br>                //递增其状态<br>                observer.dispatchEvent(lifecycleOwner, upEvent(observer.mState));<br>                popParentState();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> backwardPass(LifecycleOwner lifecycleOwner) &#123;<br>        // 从队尾开始迭代<br>        Iterator&lt;Entry&lt;LifecycleObserver, ObserverWithState&gt;&gt; descendingIterator =<br>                mObserverMap.descendingIterator();<br>        <span class="hljs-keyword">while</span> (descendingIterator.hasNext() &amp;&amp; !mNewEventOccurred) &#123;<br>            Entry&lt;LifecycleObserver, ObserverWithState&gt; entry = descendingIterator.next();<br>            ObserverWithState observer = entry.getValue();<br>            //当前observer的state值大于mState，则需递减当前状态到mState<br>            <span class="hljs-keyword">while</span> ((observer.mState.compareTo(mState) &gt; 0 &amp;&amp; !mNewEventOccurred<br>                    &amp;&amp; mObserverMap.contains(entry.getKey()))) &#123;<br>                //递减其状态<br>                Event event = downEvent(observer.mState);<br>                pushParentState(getStateAfter(event));<br>                observer.dispatchEvent(lifecycleOwner, event);<br>                popParentState();<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> popParentState() &#123;<br>        mParentStates.remove(mParentStates.size() - 1);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> pushParentState(State state) &#123;<br>        mParentStates.add(state);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Event downEvent(State state) &#123;<br>        <span class="hljs-keyword">switch</span> (state) &#123;<br>            <span class="hljs-keyword">case</span> INITIALIZED:<br>                throw new IllegalArgumentException();<br>            <span class="hljs-keyword">case</span> CREATED:<br>                return ON_DESTROY;<br>            <span class="hljs-keyword">case</span> STARTED:<br>                return ON_STOP;<br>            <span class="hljs-keyword">case</span> RESUMED:<br>                return ON_PAUSE;<br>            <span class="hljs-keyword">case</span> DESTROYED:<br>                throw new IllegalArgumentException();<br>        &#125;<br>        throw new IllegalArgumentException("Unexpected state value " + state);<br>    &#125;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> Event upEvent(State state) &#123;<br>        <span class="hljs-keyword">switch</span> (state) &#123;<br>            <span class="hljs-keyword">case</span> INITIALIZED:<br>            <span class="hljs-keyword">case</span> DESTROYED:<br>                return ON_CREATE;<br>            <span class="hljs-keyword">case</span> CREATED:<br>                return ON_START;<br>            <span class="hljs-keyword">case</span> STARTED:<br>                return ON_RESUME;<br>            <span class="hljs-keyword">case</span> RESUMED:<br>                throw new IllegalArgumentException();<br>        &#125;<br>        throw new IllegalArgumentException("Unexpected state value " + state);<br>    &#125;<br></code></pre></td></tr></table></figure>
<p><code>forwardPass()</code>首先获取一个<code>mObserverMap</code>的迭代器，然后遍历每一子元素，递增其状态并通过<code>dispatchEvent()</code>分发事件，直到状态递增到<code>mState</code>为止。</p>
<p>假设<code>mObserverMap</code>中的所有都处于<code>CREATED</code>状态，当收到一个<code>ON_START</code>事件时，表示需要进入<code>STARTED</code>状态，由于<code>STARTED</code>较大，需要进行<code>forwardPass()</code>来递增<code>mObserverMap</code>中的状态，其内部调用到<code>upEvent()</code>升至了<code>STARTED</code>，再发送出去，外部接受到的就是<code>ON_START</code>事件。</p>
<p><img src="/images/upEvent-downEvent.jpg" srcset="/img/loading.gif" alt="upEvent/downEvent"></p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><blockquote>
<p><code>Lifecycle</code>原理简述：</p>
<p>实现<code>LifecycleObserver</code>接口，在需要监听对应生命周期(<code>Lifecycle.Event</code>)的方法添加<code>@OnLifecycleEvent()</code>注解。</p>
<p>通过<code>LifecycleOwner.getLifecycle()</code>调用<code>addObserver()</code>添加监听，添加到<code>LifecycleRegistry.mObserverMap</code>中。(如果未在初始生命周期添加的监听，添加时会先执行之前生命周期的事件。)</p>
<p><code>LifecycleRegistry</code>就是<code>Lifecycle</code>的唯一实现类，上面说到的都是通过它实现的。当<code>LifecyleOwner</code>执行到对应的生命周期，就会通过<code>handleLifecycleEvent()</code>进行对应生命周期事件的分发，内部通过<code>sync()</code>负责<strong>同步<code>LifecycleOwner</code>与<code>mObserverMap</code>的状态</strong>，如果状态不统一，就需要通过<code>upEvent()</code>与<code>downEvent()</code>进行统一，并且通过<code>dispatchEvent()</code>分发未统一的事件。</p>
</blockquote>
<h2 id="拓展"><a href="#拓展" class="headerlink" title="拓展"></a>拓展</h2><p><code>@OnLifecycleEvent</code>采用<strong>运行时注解</strong>方式，需要通过反射来执行逻辑。<code>Lifecycle</code>对于该注解采用了 <strong>一次查找后续从缓存中获取</strong>的形式，降低了反射时的性能消耗。详情可参考 <em>androidx.lifecycle.ClassInfoCache</em>内部有具体的逻辑实现。</p>
<p>上面执行到了<code>LifecycleObserver.dispatchEvent()</code>分发对应事件到使用了<code>@OnLifecycleEvent()</code>的方法中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java">//LifecycleRegistry.java<br>        <span class="hljs-keyword">void</span> dispatchEvent(LifecycleOwner owner, Event event) &#123;<br>            State newState = getStateAfter(event);<br>            mState = min(mState, newState);<br>            mLifecycleObserver.onStateChanged(owner, event);<br>            mState = newState;<br>        &#125;<br><br><br>//ReflectiveGenericLifecycleObserver.java LifecycleObserver的实现类<br>    @Override<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> onStateChanged(LifecycleOwner source, Event event) &#123;<br>        mInfo.invokeCallbacks(source, event, mWrapped);<br>    &#125;<br><br>//ClassesInfoCache.java<br>//缓存Event相关处理<br><span class="hljs-keyword">final</span> Map&lt;Lifecycle.Event, List&lt;MethodReference&gt;&gt; mEventToHandlers;<br><br>        <span class="hljs-keyword">void</span> invokeCallbacks(LifecycleOwner source, Lifecycle.Event event, Object target) &#123;<br>            invokeMethodsForEvent(mEventToHandlers.get(event), source, event, target);<br>            invokeMethodsForEvent(mEventToHandlers.get(Lifecycle.Event.ON_ANY), source, event,<br>                    target);<br>        &#125;<br><br>        <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> invokeMethodsForEvent(List&lt;MethodReference&gt; handlers,<br>                LifecycleOwner source, Lifecycle.Event event, Object mWrapped) &#123;<br>            <span class="hljs-keyword">if</span> (handlers != <span class="hljs-keyword">null</span>) &#123;<br>                <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = handlers.size() - 1; i &gt;= 0; i--) &#123;<br>                    handlers.get(i).invokeCallback(source, event, mWrapped);<br>                &#125;<br>            &#125;<br>        &#125;<br></code></pre></td></tr></table></figure>
<h2 id="内容引用"><a href="#内容引用" class="headerlink" title="内容引用"></a>内容引用</h2><p><a href="https://jekton.github.io/2018/07/06/android-arch-lifecycle/" target="_blank" rel="noopener">Jekton-Lifecycle</a></p>
<p><a href="https://developer.android.google.cn/topic/libraries/architecture/lifecycle#java" target="_blank" rel="noopener">Android Developer 生命周期感知组件</a></p>

            </div>
            <hr>
            <div>
              <div class="post-metas mb-3">
                
                
                  <div class="post-meta">
                    <i class="iconfont icon-tags"></i>
                    
                      <a class="hover-with-bg" href="/tags/源码解析/">源码解析</a>
                    
                  </div>
                
              </div>
              
                <p class="note note-warning">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-sa/4.0/deed.zh" rel="nofollow noopener">CC BY-SA 4.0 协议</a> ，转载请注明出处！</p>
              
              
                <div class="post-prevnext">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2019/02/19/Java-注解/">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">Java - 注解</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2019/02/15/Jetpack-LiveData简析/">
                        <span class="hidden-mobile">Jetpack-LiveData简析</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>
    
      <div class="d-none d-lg-block col-lg-2 toc-container" id="toc-ctn">
        <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>

      </div>
    
  </div>
</div>

<!-- Custom -->


    

    
      <a id="scroll-top-button" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v"
                 for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>
    

    
  </main>

  <footer class="text-center mt-5 py-3">
  <div class="footer-content">
     <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
  </div>
  

  

  
</footer>

<!-- SCRIPTS -->

  <script  src="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://cdn.jsdelivr.net/npm/nprogress@0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" ></script>
<script  src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" ></script>
<script  src="/js/debouncer.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>

<!-- Plugins -->


  
    <script  src="/js/lazyload.js" ></script>
  



  



  <script  src="https://cdn.jsdelivr.net/npm/tocbot@4.12.0/dist/tocbot.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js" ></script>



  <script  src="https://cdn.jsdelivr.net/npm/anchor-js@4.3.0/anchor.min.js" ></script>



  <script defer src="https://cdn.jsdelivr.net/npm/clipboard@2.0.6/dist/clipboard.min.js" ></script>








  <script  src="/js/local-search.js" ></script>
  <script>
    (function () {
      var path = "/local-search.xml";
      var inputArea = document.querySelector("#local-search-input");
      inputArea.onclick = function () {
        searchFunc(path, 'local-search-input', 'local-search-result');
        this.onclick = null
      }
    })()
  </script>















<!-- 主题的启动项 保持在最底部 -->
<script  src="/js/boot.js" ></script>



</body>
</html>
