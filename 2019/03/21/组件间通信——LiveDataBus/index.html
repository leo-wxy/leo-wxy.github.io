<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="组件间通信——LiveDataBus"><meta name="keywords" content="Android"><meta name="author" content="Leo-Wxy"><meta name="copyright" content="Leo-Wxy"><title>组件间通信——LiveDataBus | Wxy的个人博客</title><link rel="shortcut icon" href="/melody-favicon.ico"><link rel="stylesheet" href="/css/index.css?version=1.7.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.7.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容:${query}"}},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="切换文章详情">切换站点概览</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#LiveDataBus的组成"><span class="toc-number">1.</span> <span class="toc-text">LiveDataBus的组成</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LiveDataBus的实现"><span class="toc-number">2.</span> <span class="toc-text">LiveDataBus的实现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#LiveDataBus改进"><span class="toc-number">3.</span> <span class="toc-text">LiveDataBus改进</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#改进方案"><span class="toc-number">3.1.</span> <span class="toc-text">改进方案</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#改进代码"><span class="toc-number">3.2.</span> <span class="toc-text">改进代码</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="/images/avatar.png"></div><div class="author-info__name text-center">Leo-Wxy</div><div class="author-info__description text-center">如果我没有见过光明，那我本可以忍受黑暗</div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="/archives"><span class="pull-left">文章</span><span class="pull-right">128</span></a><a class="author-info-articles__tags article-meta" href="/tags"><span class="pull-left">标签</span><span class="pull-right">19</span></a></div></div></div><div id="content-outer"><div class="plain" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="/">Wxy的个人博客</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">首页</a><a class="site-page" href="/archives">归档</a><a class="site-page" href="/tags">标签</a><a class="site-page" href="/categories">分类</a></span><span class="pull-right"><a class="site-page social-icon search"><i class="fa fa-search"></i><span> 搜索</span></a></span></div></div><div class="layout" id="content-inner"><article id="post"><div class="plain" id="post-title">组件间通信——LiveDataBus</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-21</time></div><div class="article-container" id="post-content"><blockquote>
<p><code>LiveData</code>是一个可以被观察的数据持有类，可以感知并遵循<code>Activity、Fragment，Service</code>等组件的生命周期。由于这种特性可以使他做到在特定生命周期执行特定的操作。</p>
</blockquote>
<p><code>LiveData</code>优点：</p>
<ul>
<li><strong>UI和实时数据保持一致</strong>：可以在数据发生改变时立即响应到</li>
<li><strong>避免内存泄漏</strong>：当绑定的组件被销毁时，会自动清理数据以及移除引用，避免泄漏</li>
</ul>
<p>根据上述优点，就可以利用<code>LiveData</code>去实现一个组件间通信的方案，这套方案相对于<code>EventBus</code>、<code>RxBus</code>有着明显的优势，不需要显式的去调用反注册方法(<em>以免内存泄漏</em>)，而且其自带生命周期感知，可以在Activity等组件处于前台状态时，进行UI更改，避免浪费资源。</p>
<h2 id="LiveDataBus的组成"><a href="#LiveDataBus的组成" class="headerlink" title="LiveDataBus的组成"></a>LiveDataBus的组成</h2><ul>
<li><strong>消息</strong>：用于在组件中通信所传递的数据，可能是基本类型也可能是自定义Model</li>
<li><strong>消息通道</strong>：用消息通道来甄别不同的LiveData(<em>处理对象</em>)</li>
<li><strong>订阅者</strong>：通过消息通道获取对应的<code>LiveData</code>，调用<code>observe()</code>进行订阅</li>
<li><strong>发布者</strong>：通过消息通道获取对应的<code>LiveData</code>，调用<code>postValue()、setValue()</code>进行消息发送</li>
</ul>
<span itemprop="image" itemscope="" itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="/images/LiveDataBus结构.png" class="full-image" alt="LiveDataBus结构" title="LiveDataBus结构"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span>
<h2 id="LiveDataBus的实现"><a href="#LiveDataBus的实现" class="headerlink" title="LiveDataBus的实现"></a>LiveDataBus的实现</h2><p>按照上述结构图，可以马上就写出一个大致结构</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LiveDataBus</span> <span class="keyword">private</span> <span class="keyword">constructor</span></span>() &#123;</span><br><span class="line">    <span class="comment">//用于存放消息通道</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> map: MutableMap&lt;String, MutableLiveData&lt;Any&gt;?&gt;</span><br><span class="line"></span><br><span class="line">    init &#123;</span><br><span class="line">        map = HashMap()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">getChannel</span><span class="params">(target: <span class="type">String</span>, type: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;)</span></span>: MutableLiveData&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (!map.containsKey(target)) &#123;</span><br><span class="line">            map[target] = MutableLiveData()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map[target] <span class="keyword">as</span> MutableLiveData&lt;T&gt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getChannel</span><span class="params">(target: <span class="type">String</span>)</span></span>: MutableLiveData&lt;Any&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> getChannel(target, Any::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> instance: LiveDataBus <span class="keyword">by</span> lazy &#123; LiveDataBus() &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>对应发送数据方法</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//同步发送</span></span><br><span class="line">LiveDataBus.instance.getChannel(<span class="string">"web"</span>, String::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>).<span class="title">value</span> = "<span class="title">ssa</span>"</span></span><br><span class="line"><span class="comment">//异步发送</span></span><br><span class="line">LiveDataBus.instance.getChannel(<span class="string">"web"</span>,String::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>).<span class="title">postValue</span></span>(<span class="string">"ssa"</span>)</span><br></pre></td></tr></table></figure>
<p>对应接收数据方法</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">LiveDataBus.instance.getChannel(<span class="string">"web"</span>, String::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">           .observe(<span class="keyword">this</span><span class="symbol">@MainActivity</span>, Observer &#123; s -&gt;</span><br><span class="line">                Log.e(<span class="string">"web"</span>, s)</span><br><span class="line">           &#125;)</span><br></pre></td></tr></table></figure>
<p>但是在实际的使用过程中发现了另一个问题，再打开一个新页面时，如果也存在监听者，就会收到该页面打开前所发送的消息，类似<em>粘性事件</em>，但大部分场景下是不需要这样的，所以需要针对这个问题进行改进。</p>
<h2 id="LiveDataBus改进"><a href="#LiveDataBus改进" class="headerlink" title="LiveDataBus改进"></a>LiveDataBus改进</h2><p>根据<a href="/2019/02/15/LiveData简析/" title="LiveData简析">LiveData简析</a>这部分源码分析可知，LiveData中的数据分发流程如下图所示：</p>
<span itemprop="image" itemscope="" itemtype="http://schema.org/ImageObject"><img itemprop="url image" src="/images/LiveData-dispatch.png" class="full-image" alt="LiveData Dispatch" title="LiveData Dispatch"><meta itemprop="width" content="auto"><meta itemprop="height" content="auto"></span>
<p>根据上述流程分析：调用到<code>setValue()/postValue()</code>将用户数据进行发送，然后进入到<code>dispatchValue()</code>下进行分发，设置<code>mVersion++(mVersion表示调用方法次数)</code>，想下调用到<code>considerNotify()</code>内部需要判断<code>observer.mLastVersion(Observer注册次数)</code>与<code>mVersion</code>大小，如果小于就会调用到对应<code>Observer.onChanged()</code>事件进行分发。</p>
<p><em>由于初始化时，先会调用到<code>postValue()/setValue()</code>此时mVersion+1，就比<code>mLastVersion</code>要大，就会触发事件的分发。</em></p>
<h3 id="改进方案"><a href="#改进方案" class="headerlink" title="改进方案"></a>改进方案</h3><p><strong>只要可以设置<code>mLastVersion</code>与<code>mVersion</code>保持一致，就不会进行事件的分发。</strong></p>
<p>此时需要利用<strong>反射</strong>的方式对<code>LiveData</code>中的数据进行改变，首先按照需求，先要找到<code>Observer</code>，然后修改其中的<code>mLastVersion</code>即可。</p>
<figure class="highlight java"><figcaption><span>LiveData.java</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@MainThread</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">observe</span><span class="params">(@NonNull LifecycleOwner owner, @NonNull Observer&lt;T&gt; observer)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (owner.getLifecycle().getCurrentState() == DESTROYED) &#123;</span><br><span class="line">           <span class="comment">// ignore</span></span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       LifecycleBoundObserver wrapper = <span class="keyword">new</span> LifecycleBoundObserver(owner, observer);</span><br><span class="line">       <span class="comment">//存储所有的Observer对象</span></span><br><span class="line">       ObserverWrapper existing = mObservers.putIfAbsent(observer, wrapper);</span><br><span class="line">       <span class="keyword">if</span> (existing != <span class="keyword">null</span> &amp;&amp; !existing.isAttachedTo(owner)) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Cannot add the same observer"</span></span><br><span class="line">                   + <span class="string">" with different lifecycles"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (existing != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       owner.getLifecycle().addObserver(wrapper);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>需要从<code>mObservers</code>中入手，然后找到对应<code>Observer</code>即可。</p>
<blockquote>
<p>除了<code>observer()</code>外，还有一个<code>observerForever()</code>，该方法是一直存在监听的，而且不会绑定对应的组件，所以可以在任意组件中监听到事件，如果使用时，需要注意销毁。</p>
</blockquote>
<h3 id="改进代码"><a href="#改进代码" class="headerlink" title="改进代码"></a>改进代码</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.wxy.router.eventbus.utils</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.arch.lifecycle.LifecycleOwner</span><br><span class="line"><span class="keyword">import</span> android.arch.lifecycle.LiveData</span><br><span class="line"><span class="keyword">import</span> android.arch.lifecycle.MutableLiveData</span><br><span class="line"><span class="keyword">import</span> android.arch.lifecycle.Observer</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.icu.lang.UCharacter.GraphemeClusterBreak.T</span><br><span class="line"><span class="keyword">import</span> java.lang.Exception</span><br><span class="line"><span class="keyword">import</span> java.lang.NullPointerException</span><br><span class="line"><span class="keyword">import</span> java.util.*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LiveDataBus</span> <span class="keyword">private</span> <span class="keyword">constructor</span></span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//用于存放消息通道</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> map: MutableMap&lt;String, BusMutableLiveData&lt;Any&gt;?&gt;</span><br><span class="line"></span><br><span class="line">    init &#123;</span><br><span class="line">        map = HashMap()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">getChannel</span><span class="params">(target: <span class="type">String</span>, type: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;)</span></span>: BusMutableLiveData&lt;T&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (!map.containsKey(target)) &#123;</span><br><span class="line">            map[target] = BusMutableLiveData()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> map[target] <span class="keyword">as</span> BusMutableLiveData&lt;T&gt;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getChannel</span><span class="params">(target: <span class="type">String</span>)</span></span>: BusMutableLiveData&lt;Any&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> getChannel(target, Any::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> instance: LiveDataBus <span class="keyword">by</span> lazy &#123; LiveDataBus() &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//Observer装饰类</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">ObserverWrapper</span>&lt;<span class="type">T</span>&gt;</span>() : Observer&lt;T&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">var</span> observer: Observer&lt;T&gt;? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">constructor</span>(observer: Observer&lt;T&gt;) : <span class="keyword">this</span>() &#123;</span><br><span class="line">            <span class="keyword">this</span>.observer = observer</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onChanged</span><span class="params">(t: <span class="type">T</span>?)</span></span> &#123;</span><br><span class="line">            observer?.let &#123;</span><br><span class="line">                <span class="keyword">if</span> (isCallOnObserve()) <span class="keyword">return</span><span class="symbol">@let</span></span><br><span class="line">                it.onChanged(t)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//判断当前 Observer类型是否为永久存在，如果是则不予处理</span></span><br><span class="line">        <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">isCallOnObserve</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> stackTrace = Thread.currentThread().stackTrace</span><br><span class="line">            <span class="keyword">if</span> (stackTrace.isNotEmpty()) &#123;</span><br><span class="line">                stackTrace.forEach &#123; stackTraceElement -&gt;</span><br><span class="line">                    <span class="keyword">if</span> (<span class="string">"android.arch.lifecycle.LiveData"</span> == stackTraceElement.className &amp;&amp;</span><br><span class="line">                        <span class="string">"observeForever"</span> == stackTraceElement.methodName</span><br><span class="line">                    ) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">BusMutableLiveData</span>&lt;<span class="type">T</span>&gt; : <span class="type">MutableLiveData</span>&lt;<span class="type">T</span>&gt;</span>() &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">val</span> observerMap: MutableMap&lt;Observer&lt;T&gt;, Observer&lt;T&gt;&gt; = hashMapOf()</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">observe</span><span class="params">(owner: <span class="type">LifecycleOwner</span>, observer: <span class="type">Observer</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.observe(owner, observer)</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                hook(observer)</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                e.printStackTrace()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">observeForever</span><span class="params">(observer: <span class="type">Observer</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!observerMap.containsKey(observer)) &#123;</span><br><span class="line">                observerMap[observer] = LiveDataBus.ObserverWrapper(observer)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">super</span>.observeForever(observer)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">removeObserver</span><span class="params">(observer: <span class="type">Observer</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">            <span class="keyword">val</span> realObserver: Observer&lt;T&gt;? = <span class="keyword">if</span> (observerMap.containsKey(observer)) &#123;</span><br><span class="line">                observerMap.remove(observer)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                observer</span><br><span class="line">            &#125;</span><br><span class="line">            realObserver?.let &#123; <span class="keyword">super</span>.removeObserver(it) &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">hook</span><span class="params">(observer: <span class="type">Observer</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">val</span> classLiveData = LiveData::<span class="class"><span class="keyword">class</span>.<span class="title">java</span></span></span><br><span class="line">                <span class="comment">//获取LiveData中的 mObservers 对象</span></span><br><span class="line">                <span class="keyword">val</span> fieldObservers = classLiveData.getDeclaredField(<span class="string">"mObservers"</span>)</span><br><span class="line">                fieldObservers.isAccessible = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">val</span> objectObservers = fieldObservers.<span class="keyword">get</span>(<span class="keyword">this</span>)</span><br><span class="line">                <span class="keyword">val</span> classObservers = objectObservers.javaClass</span><br><span class="line">                <span class="keyword">val</span> methodGet = classObservers.getDeclaredMethod(<span class="string">"get"</span>, Object::<span class="class"><span class="keyword">class</span>.<span class="title">java</span>)</span></span><br><span class="line">                methodGet.isAccessible = <span class="literal">true</span></span><br><span class="line">                <span class="keyword">val</span> objectWrapperEntry = methodGet.invoke(objectObservers, observer)</span><br><span class="line">                <span class="keyword">var</span> objectWrapper: Any? = <span class="literal">null</span></span><br><span class="line">                <span class="keyword">if</span> (objectWrapperEntry <span class="keyword">is</span> Map.Entry&lt;*, *&gt;) &#123;</span><br><span class="line">                    objectWrapper = objectWrapperEntry.value</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (objectWrapper == <span class="literal">null</span>)</span><br><span class="line">                    <span class="keyword">throw</span> NullPointerException(<span class="string">"wrapper can not be null"</span>)</span><br><span class="line">                <span class="comment">//获取对应Observer对象</span></span><br><span class="line">                <span class="keyword">val</span> classObserverWrapper = objectWrapper.javaClass.superclass</span><br><span class="line">                <span class="comment">//获取其中 mLastVersion数据</span></span><br><span class="line">                <span class="keyword">val</span> fieldLastVersion = classObserverWrapper.getDeclaredField(<span class="string">"mLastVersion"</span>)</span><br><span class="line">                fieldLastVersion.isAccessible = <span class="literal">true</span></span><br><span class="line">                <span class="comment">//获取其中mVersion数据</span></span><br><span class="line">                <span class="keyword">val</span> fieldVersion = classLiveData.getDeclaredField(<span class="string">"mVersion"</span>)</span><br><span class="line">                fieldVersion.isAccessible = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">val</span> objectVersion = fieldVersion.<span class="keyword">get</span>(<span class="keyword">this</span>)</span><br><span class="line">                <span class="comment">//重新赋值 使两者相等则事件不会进行分发</span></span><br><span class="line">                fieldLastVersion.<span class="keyword">set</span>(objectWrapper, objectVersion)</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                e.printStackTrace()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">Leo-Wxy</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://yoursite.com/2019/03/21/组件间通信——LiveDataBus/">http://yoursite.com/2019/03/21/组件间通信——LiveDataBus/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://yoursite.com">Wxy的个人博客</a>！</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Android/">Android</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="/2019/03/28/Golang学习笔记/"><i class="fa fa-chevron-left">  </i><span>Golang学习笔记-基本概念</span></a></div><div class="next-post pull-right"><a href="/2019/03/15/Java中的锁事/"><span>Java中的锁事</span><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2013 - 2020 By Leo-Wxy</div><div class="framework-info"><span>驱动 - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="/js/utils.js?version=1.7.0"></script><script src="/js/fancybox.js?version=1.7.0"></script><script src="/js/sidebar.js?version=1.7.0"></script><script src="/js/copy.js?version=1.7.0"></script><script src="/js/fireworks.js?version=1.7.0"></script><script src="/js/transition.js?version=1.7.0"></script><script src="/js/scroll.js?version=1.7.0"></script><script src="/js/head.js?version=1.7.0"></script><script src="/js/search/local-search.js"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script><div class="search-dialog" id="local-search"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章"></div></div></div><hr><div id="local-search-results"><div id="local-hits"></div><div id="local-stats"><div class="local-search-stats__hr" id="hr"><span>由</span> <a href="https://github.com/wzpan/hexo-generator-search" style="color:#49B1F5;">hexo-generator-search</a>
 <span>提供支持</span></div></div></div><span class="search-close-button"><i class="fa fa-times"></i></span></div><div class="search-mask"></div></body></html>